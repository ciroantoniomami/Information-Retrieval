<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    		<meta name="keywords" content="User:Keitei/monobook.js" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikipedia (English)" />
		<link rel="copyright" href="../../../COPYING.html" />
    <title>User:Keitei/monobook.js - Simple English Wikipedia, the free encyclopedia</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../skins/htmldump/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/md5.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/utf8.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/lookup.js"></script>
    <script type="text/javascript" src="../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../raw/MediaWiki%7ECommon.css";
@import "../../../raw/MediaWiki%7EMonobook.css";
@import "../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="ns-2">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">User:Keitei/monobook.js</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Simple English Wikipedia, the free encyclopedia</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../k/e/i/User%7EKeitei_af28.html" title="User:Keitei">User:Keitei</a></span></div>
	    	    	    <!-- start content -->
	    <p><b>Note:</b> After saving, you may have to bypass your browser's cache to see the changes. <b>Mozilla / Firefox / Safari:</b> hold down <i>Shift</i> while clicking <i>Reload</i>, or press <i>Ctrl-Shift-R</i> (<i>Cmd-Shift-R</i> on Apple Mac); <b>IE:</b> hold <i>Ctrl</i> while clicking <i>Refresh</i>, or press <i>Ctrl-F5</i>; <b>Konqueror:</b>: simply click the <i>Reload</i> button, or press <i>F5</i>; <b>Opera</b> users may need to completely clear their cache in <i>Tools→Preferences</i>.
</p><pre>// &lt;nowiki&gt;

window.onload = Main;
function Main() {
    addactions();
}

function addactions() {
    addwelcome();
    addenwp()
}

function addwelcome() { 
    if(!document.editform) return;
    var txt = document.editform.wpTextbox1;
    var url = window.location;
    if(txt.value.length == 0) {
        if (url.search.indexOf(&quot;User_talk:&quot;) != -1) {
            var tabs = document.getElementById('p-cactions').getElementsByTagName('ul')[0];
            if(document.title.indexOf(&quot;Editing&quot;) == 0) addlilink(tabs, 'javascript:welcome()', 'welcome', 'ca-welcome');
        }
    }
}

function addenwp() {
    if(!document.getElementById) return;
    var x = document.getElementById('ca-history');
    var y = document.getElementById('ca-edit');
    var tabs = document.getElementById('p-cactions').getElementsByTagName('ul')[0];
    if((!x)&amp;&amp;(!y)) return;
    addlilink(tabs, &quot;http://en.wikipedia.org/wiki/Special:Search?search=&quot;+ document.getElementsByTagName('h1')[0].firstChild.nodeValue +&quot;&amp;go=Go&quot;, 'en.wp', 'ca-en.wp');
}


function welcome() {
    document.editform.wpSummary.value = 'Welcome!';
    document.editform.wpMinoredit.checked = false;
    document.editform.wpWatchthis.checked = false;
    var txt = document.editform.wpTextbox1;
    if(txt.value.length &gt; 0) txt.value += '\n';
    txt.value += '{{subst:welcome}} --~~~~';
    document.editform.wpSave.focus();
}

function addlilink(tabs, url, name, id) {
    var na = document.createElement('a');
    na.href = url;
    na.id = id;
    na.appendChild(document.createTextNode(name));
    var li = document.createElement('li');
    li.appendChild(na);
    tabs.appendChild(li);
    return li;
}


// &lt;/nowiki&gt;

var popupVersion=&quot;Thu Mar 2 19:40:47 EST 2006&quot;;
// STARTFILE: main.js
// **********************************************************************
// **                             Warning                              **
// **********************************************************************
// ** if you edit this file, be sure that your editor recognizes it as **
// **   utf8, or the weird and wonderful characters in the namespaces  **
// **   below will be completely broken. You can check with the show   **
// **            changes button before submitting the edit.            **
// **                      test: مدیا מיוחד Мэдыя                      **
// **********************************************************************

////////////////////////////////////////////////////////////////////
// Import stylesheet(s)
//


if (1) {
  document.write('&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;' +
		 'http://en.wikipedia.org/w/index.php?title=User:Lupin/navpop.css' +
		 '&amp;action=raw&amp;ctype=text/css&amp;dontcountme=s&quot;&gt;');
} else {
  document.write('&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;http://localhost:8080/js/navpop.css&quot;&gt;');
}

//////////////////////////////////////////////////
// Globals
//

// Trying to shove as many of these as possible into the pg (popup globals) object
window.pg = {
  re: {},               // regexps
  ns: {},               // namespaces
  string: {},           // translatable strings
  wiki: {},             // local site info
  misc: {},             // YUCK PHOOEY
  option: {},           // options, see newOption etc
  optionDefault: {},    // default option values
  flag: {},             // misc flags
  cache: {},            // page and image cache
  diffData: {},         // support for diff previews
  structures: {},       // navlink structures
  timer: {},            // all sorts of timers (too damn many)
  counter: {},          // .. and all sorts of counters
  current: {},          // state info
 endoflist: null
};

window.pop = {          // wrap various functions in here
  init: {},
  util: {},
 endoflist: null
};

////////////////////////////////////////////////////////////////////
// Run things
////////////////////////////////////////////////////////////////////

addOnloadHook(setupPopups);

/// Local Variables: ///
/// mode:c ///
/// End: ///

// ENDFILE: main.js
// STARTFILE: actions.js
function setupTooltips(container) {
  if (!container) {
    // the main initial call
    if (getValueOf('popupOnEditSelection')) {
      try {
	document.editform.wpTextbox1.onmouseup=function() { doSelectionPopup(); };
      } catch (neverMind) {}
    }
    // article/content is a structure-dependent thing
    if (getValueOf('popupOnlyArticleLinks')) {
      container = document.getElementById('article') || document.getElementById('content') || document;
    } else {
      container = document;
    }
  }

  if (container.ranSetupTooltipsAlready) { return; }
  container.ranSetupTooltipsAlready=true;

  var anchors;
  anchors=container.getElementsByTagName('A');
  setupTooltipsLoop(anchors, 0, 250, 100);
}

function setupTooltipsLoop(anchors,begin,howmany,sleep) {
  var finish=begin+howmany;
  var loopend = min(finish, anchors.length);
  var remTitles = getValueOf('removeTitles');
  var j=loopend - begin;
  log ('setupTooltips: anchors.length=' + anchors.length + ', begin=' + begin +
       ', howmany=' + howmany + ', loopend=' + loopend);
  // try a faster (?) loop construct
  if (j &gt; 0) {
    do {
      var a=anchors[loopend - j];
      if (!a || !a.href) {
	log('got null anchor at index ' + loopend - j);
	continue;
      }
      if ( isPopupLink(a) ) {
	a.onmouseover=mouseOverWikiLink;
	a.onmouseout= mouseOutWikiLink;
	a.onclick= killPopup;
	if (remTitles &amp;&amp; typeof a.originalTitle=='undefined') {
	  a.originalTitle=a.title;
	  a.title='';
	}
      }
    } while (--j);
  }
  if (finish &lt; anchors.length) {
    pop.runOnce(function() {setupTooltipsLoop(anchors,finish,howmany,sleep);}, sleep);
  }
  else {
    // now eliminate popups from the TOC
    if (! getValueOf('popupTocLinks')) {
      var toc=document.getElementById('toc');
      if (toc) {
	var tocLinks=toc.getElementsByTagName('A');
	var tocLen = tocLinks.length;
	for (var j=0; j&lt;tocLen; ++j) {
	  log ('killing popup for toclinks[' + j + ']');
	  a=tocLinks[j];
	  a.onmouseover=null; a.onmouseout=null; a.onclick=null;
	  if (a.originalTitle) { a.title=a.originalTitle; }
	}
	// looks like we just killed any onclick stuff that used to be going on in the toc
	// life is hard
      }
    }

    pg.flag.finishedLoading=true;
  }
}

// add CSS class to table

function addPopupStylesheetClasses () {
  var tables=over.getElementsByTagName('table');
  tables[0].className='popupBorderTable';
  tables[1].className='popupTable';
  var fonts=over.getElementsByTagName('font');
  fonts[0].className='popupFont';
  fonts[0].id='overFontWrapper';
}

function registerHooks(np) {
  var popupMaxWidth=getValueOf('popupMaxWidth');

  if (typeof popupMaxWidth == 'number') {
    var setMaxWidth = function () {
      np.mainDiv.style.maxWidth = popupMaxWidth + 'px';
      np.maxWidth = popupMaxWidth;

      // hack for IE
      // see http://www.svendtofte.com/code/max_width_in_ie/
      // use setExpression as documented here on msdn: http://tinyurl dot com/dqljn

      if (np.mainDiv.style.setExpression) {
	np.mainDiv.style.setExpression('width', 'document.body.clientWidth &gt; ' +
				       popupMaxWidth + ' ? &quot;' +popupMaxWidth + 'px&quot;: &quot;auto&quot;');
      }
    };
    np.addHook(setMaxWidth, 'unhide', 'before');
  }

  np.addHook(addPopupShortcuts, 'unhide', 'after');
  np.addHook(rmPopupShortcuts, 'hide', 'before');


  //don't do this here...
  //np.addHook(window.fillEmptySpans, 'create', 'after');

  //registerHook(&quot;createPopup&quot;, window.addPopupStylesheetClasses, FAFTER);
}


function mouseOverWikiLink() {
  if (!pg.flag.finishedLoading) { return; }
  return mouseOverWikiLink2(this);
}

function mouseOverWikiLink2(a) {
  // FIXME: should not generate the HTML until the delay has elapsed,
  //        and then popup immediately. Can be a CPU hog otherwise.

  //log('mouseOverWikiLink: a='+a+', pg.current.link='+pg.current.link);

  // try not to duplicate effort
  if ( a==pg.current.link &amp;&amp; a.navpopup &amp;&amp; a.navpopup.isVisible() ) { return; }
  pg.current.link=a;

  if (getValueOf('simplePopups') &amp;&amp; pg.option.popupStructure===null) {
    // reset *default value* of popupStructure
    //log ('simplePopups is true and no popupStructure selected. Defaulting to &quot;original&quot;');
    setDefault('popupStructure', 'original');
  }

  var article=(new Title()).fromAnchor(a);
  // set global variable (ugh) to hold article (wikipage)
  pg.current.article = article;
  var diff=null;
  var oldid=oldidFromAnchor(a);
  if (getValueOf('popupPreviewDiffs')) {
    diff=diffFromAnchor(a);
  }

  if (pg.timer.image !== null) {
    clearInterval(pg.timer.image);
    pg.timer.image=null;
    pg.counter.checkImages=0;
  }

  if (!a.navpopup) {
    log ('mouseoverwikilink2: creating new Navpopup');
    a.navpopup = new Navpopup();
    a.navpopup.fuzz=5;
    a.navpopup.delay=getValueOf('popupDelay')*1000;
    // a.navpopup.append($t(a.navpopup.uid));
    // increment global counter now
    a.navpopup.popupIdNumber = ++pg.idNumber;
    registerHooks(a.navpopup);
  }
  if (a.navpopup.pending===null || a.navpopup.pending!==0) {
    // either fresh popups or those with unfinshed business are redone from scratch
    log ('doing popup content from scratch; a.navpopup.pending='+a.navpopup.pending);
    a.navpopup.setInnerHTML(popupHTML(a));
    fillEmptySpans();
    /*    if (bug) {
      setPopupHTML('Cannot generate diff until ' +
		   '&lt;a href=&quot;http://bugzilla.wikimedia.org/show_bug.cgi?id=4838&quot;&gt;this patch&lt;/a&gt; ' +
		   'is applied to Mediawiki. Sorry!&lt;hr&gt;', 'popupError');
    }
    */

  } else {
    log ('using existing popup content - just showing');
  }
  a.navpopup.showSoonIfStable(a.navpopup.delay);

  getValueOf('popupInitialWidth');

  if (typeof pg.timer.checkPopupPosition==typeof 1) { clearInterval(pg.timer.checkPopupPosition); }
  pg.timer.checkPopupPosition=setInterval(checkPopupPosition, 600);

  if (getValueOf('popupLiveOptions')) {
    setPopupHTML(popupLiveOptionsHTML(), 'popupLiveOptions', pg.idNumber,
		 function () { popupToggleShowOptions(true); } );
  }
  if (getValueOf('popupRedlinkRemoval') &amp;&amp; a.className=='new') {
    setPopupHTML('&lt;br&gt;'+popupRedlinkHTML(), 'popupRedlink', pg.idNumber);
  }

  if(getValueOf('simplePopups')) { return; }

  // We're creating a closure with all our data in it because... we're lazy
  // is this a bad idea?
  pop.unsimplify = function () {
    log('pop.unsimplify');
    a.navpopup.unsimplified=true;
    var previewImage=true;

    pg.misc.gImage=null;
    //alert(diff+'\n'+oldid);
    if ( diff===null ) {
      if (isImage(article) &amp;&amp; ( getValueOf('imagePopupsForImages') || ! anchorContainsImage(a) )) {
	loadImages(article);
      }
      else if (!isImage(article) &amp;&amp; previewImage ) {
	pg.counter.redir=0;
	loadPreview(article, oldid, diff, a.navpopup);
      }
    }
    else {
      loadDiff(article, oldid, diff);
    }

    var s=document.getElementById('popupUnsimplify' + pg.idNumber);
    if (s &amp;&amp; s.style) {
      s.style.display='none';
    }
  };

  if (getValueOf('popupUnsimplifyLink')) { return; }
  if (!a.navpopup.unsimplified || a.navpopup.pending!==0 ) {
    log ('running pop.unsimplify(), unsimplified='+a.navpopup.unsimplified +
	 ', pending='+a.navpopup.pending);
    a.navpopup.pending=0;
    pop.unsimplify();
  }
}

function loadPreview(article, oldid, diff, navpop) {
  log('loadPreview(' + article + ', ' + oldid + ', ' + navpop + ')');
  if (navpop &amp;&amp; navpop.pending===null) { navpop.pending=0; }
  ++navpop.pending;
  getWiki(article, insertPreview, oldid, navpop);
}

function loadPreviewFromRedir(redirMatch, navpop) {
  // redirMatch is a regex match
  //log('loadPreviewFromRedir, pg.counter.redir='+pg.counter.redir);
  var target = new Title().fromWikiText(redirMatch[2]);
  var trailingRubbish=redirMatch[4];
  pg.counter.redir++;
  var warnRedir = redirLink(target);

  setPopupHTML(warnRedir, 'popupWarnRedir');
  fillEmptySpans({redir: true, redirTarget: target});

  return loadPreview(target, null, null, navpop);
}

function insertPreview(download) {
  //log('insertPreview, pg.counter.redir='+pg.counter.redir);
  if (download.id != pg.idNumber) {
    //log ('insertPreview: download.id='+download.id+' but pg.idNumber='+pg.idNumber+'. Bailing...');
    return;
  }
  var wikiText=download.data;
  var navpop=download.owner;
  if (navpop &amp;&amp; navpop.pending) { --navpop.pending; }
  var redirMatch = pg.re.redirect.exec(wikiText);

  var art=pg.current.article;

  if (pg.counter.redir===0 &amp;&amp; redirMatch) {
    pg.current.redirSource=pg.current.article;
    loadPreviewFromRedir(redirMatch, navpop);
    return;
  }

  var redirSource=pg.current.redirSource||'';

  if (pg.counter.redir===0) { // not a redir, so we don't have to specify an oldTarget
    makeFixDabs(wikiText);
  } else {
    makeFixDabs(wikiText, redirSource);
  }

  pg.current.redirSource=null;
  pg.counter.redir=0;

  if (getValueOf('popupSummaryData')) {
    var pgInfo=getPageInfo(wikiText, download);
    setPopupTrailer('&lt;br&gt;' + pgInfo);
  }


  var imagePage=getValidImageFromWikiText(wikiText);
  if(imagePage) {
    // loadThisImage expects an &quot;address fragment&quot;
    imagePage = wikiMarkupToAddressFragment(imagePage);
    loadThisImage(imagePage);
  }

  if (getValueOf('popupPreviews')) {
    if (download &amp;&amp; typeof download.data == typeof ''){
      if (isInNamespace(pg.current.article, 'Template') &amp;&amp; getValueOf('popupPreviewRawTemplates')) {
	// FIXME compare/consolidate with diff escaping code for wikitext
	var h='&lt;hr&gt;&lt;tt&gt;' +
	  download.data.split(&quot;&amp;&quot;).join(&quot;&amp;amp;&quot;).split(&quot;&lt;&quot;).join(&quot;&amp;lt;&quot;).split(&quot;&gt;&quot;).join(&quot;&amp;gt;&quot;).split('\\n').join('&lt;br&gt;\\n') +
	  '&lt;/tt&gt;';
	setPopupHTML(h, 'popupPreview');
      }
      else {
	// deal with tricksy anchors
	var anch=decodeAnchor(pg.current.article);
	var d=download.data;
	if (anch) {
	  var anchRe=RegExp('=+\\s*' + literalizeRegex(anch).replace(/[_ ]/g, '[_ ]') + '\\s*=+');
	  var match=d.match(anchRe);
	  if(match &amp;&amp; match.length &gt; 0 &amp;&amp; match[0]) { d=d.substring(d.indexOf(match[0])); }
	  else { // try to deal with == foo [[bar|baz]] boom == -&gt; #foo_baz_boom
	    var lines=d.split('\n');
	    for (var i=0; i&lt;lines.length; ++i) {
	      lines[i]=lines[i].replace(RegExp('[[]{2}([^|\\]]*?[|])?(.*?)[\\]]{2}', 'g'), '$2');
	      if (lines[i].match(anchRe)) {
		d=d.split('\n').slice(i).join('\n').replace(RegExp('^[^=]*'), '');
		break;
	      }
	    }
	  }
	}
	var p=new Previewmaker(d.substring(0,10000));
	p.showPreview();
      }
    }
  }
}

function killPopup() {
  if (getValueOf('popupShortcutKeys')) { rmPopupShortcuts(); }
  pg.current.link.navpopup.banish();
  pg.current.link=null;
  abortAllDownloads();
  stopImagesDownloading();
  if (pg.timer.checkPopupPosition !== null) {
    clearInterval(pg.timer.checkPopupPosition);
    pg.timer.checkPopupPosition=null;
  }
  if (pg.timer.checkImages !== null) { clearInterval(pg.timer.checkImages); pg.timer.checkImages=null; }
  if (pg.timer.image !== null) { clearInterval(pg.timer.image); pg.timer.image=null; }
  return true; // preserve default action (eg from onclick)
}

// ENDFILE: actions.js
// STARTFILE: domdrag.js
/**
   @fileoverview
   The {@link Drag} object, which enables objects to be dragged around.

   &lt;pre&gt;
   *************************************************
   dom-drag.js
   09.25.2001
   www.youngpup.net
   **************************************************
   10.28.2001 - fixed minor bug where events
   sometimes fired off the handle, not the root.
   *************************************************
   Pared down, some hooks added by [[User:Lupin]]

   Copyright Aaron Boodman.
   Saying stupid things daily since March 2001.
   &lt;/pre&gt;


*/

/**
   Creates a new Drag object. This is used to make various DOM elements draggable.
   @constructor
*/
function Drag () {
  /**
     Condition to determine whether or not to drag. This function should take one parameter, an Event.
     To disable this, set it to &lt;code&gt;null&lt;/code&gt;.
     @type Function
  */
  this.startCondition = null;
  /**
     Hook to be run when the drag finishes. This is passed the final coordinates of the dragged object (two integers, x and y).
     To disables this, set it to &lt;code&gt;null&lt;/code&gt;.
     @type Function
  */
  this.endHook = null;
}

/**
   Gets an event in a cross-browser manner.
   @param {Event} e
   @private
 */
Drag.prototype.fixE = function(e) {
  if (typeof e == 'undefined') { e = window.event; }
  if (typeof e.layerX == 'undefined') { e.layerX = e.offsetX; }
  if (typeof e.layerY == 'undefined') { e.layerY = e.offsetY; }
  return e;
};
/**
   Initialises the Drag instance by telling it which object you want to be draggable, and what you want to drag it by.
   @param {DOMElement} o The &quot;handle&quot; by which &lt;code&gt;oRoot&lt;/code&gt; is dragged.
   @param {DOMElement} oRoot The object which moves when &lt;code&gt;o&lt;/code&gt; is dragged, or &lt;code&gt;o&lt;/code&gt; if omitted.
*/
Drag.prototype.init = function(o, oRoot) {
  var dragObj      = this;
  this.obj = o;
  o.onmousedown    = function(e) { dragObj.start.apply( dragObj, [e]); };
  o.dragging       = false;
  o.draggable      = true;
  o.hmode          = true ;
  o.vmode          = true ;

  o.root = oRoot &amp;&amp; oRoot !== null ? oRoot : o ;

  if (isNaN(parseInt(o.root.style.left, 10))) { o.root.style.left   = &quot;0px&quot;; }
  if (isNaN(parseInt(o.root.style.top,  10))) { o.root.style.top    = &quot;0px&quot;; }

  o.root.onthisStart  = function(){};
  o.root.onthisEnd    = function(){};
  o.root.onthis       = function(){};
};

/**
   Starts the drag.
   @private
   @param {Event} e
*/
Drag.prototype.start = function(e) {
  var o = this.obj; // = this;
  e = this.fixE(e);
  if (this.startCondition &amp;&amp; !this.startCondition(e)) { return; }
  var y = parseInt(o.vmode ? o.root.style.top  : o.root.style.bottom, 10);
  var x = parseInt(o.hmode ? o.root.style.left : o.root.style.right,  10);
  o.root.onthisStart(x, y);

  o.lastMouseX    = e.clientX;
  o.lastMouseY    = e.clientY;

  var dragObj      = this;
  o.onmousemoveDefault    = document.onmousemove;
  o.dragging              = true;
  document.onmousemove    = function(e) { dragObj.drag.apply( dragObj, [e] ); };
  document.onmouseup      = function(e) { dragObj.end.apply( dragObj, [e] ); };
  //  document.onclick        = document.onmouseup;
  //  document.onclick        = document.onmouseup;

  return false;
};
/**
   Does the drag.
   @param {Event} e
   @private
*/
Drag.prototype.drag = function(e) {
  e = this.fixE(e);
  var o = this.obj;

  var ey    = e.clientY;
  var ex    = e.clientX;
  var y = parseInt(o.vmode ? o.root.style.top  : o.root.style.bottom, 10);
  var x = parseInt(o.hmode ? o.root.style.left : o.root.style.right,  10 );
  var nx, ny;

  nx = x + ((ex - o.lastMouseX) * (o.hmode ? 1 : -1));
  ny = y + ((ey - o.lastMouseY) * (o.vmode ? 1 : -1));

  if (o.xMapper)        { nx = o.xMapper(y); }
  else if (o.yMapper)   { ny = o.yMapper(x); }

  this.obj.root.style[o.hmode ? &quot;left&quot; : &quot;right&quot;] = nx + &quot;px&quot;;
  this.obj.root.style[o.vmode ? &quot;top&quot; : &quot;bottom&quot;] = ny + &quot;px&quot;;
  this.obj.lastMouseX    = ex;
  this.obj.lastMouseY    = ey;

  this.obj.root.onthis(nx, ny);
  return false;
};

/**
   Ends the drag.
   @private
*/
Drag.prototype.end = function()  {
  //Document.onmousemove = null;
  document.onmousemove=this.obj.onmousemoveDefault;
  document.onmouseup   = null;
  // document.onclick     = null;
  // document.onmousedown = null;
  this.obj.dragging    = false;
  if (this.endHook) {
    this.endHook( parseInt(this.obj.root.style[this.obj.hmode ? &quot;left&quot; : &quot;right&quot;], 10),
		  parseInt(this.obj.root.style[this.obj.vmode ? &quot;top&quot; : &quot;bottom&quot;], 10));
  }
};

// ENDFILE: domdrag.js
// STARTFILE: liveoptions.js
//////////////////////////////////////////////////
// live options nonsense
//

function popupToggleVar(varstring) {
  pg.option[varstring] = ! getValueOf(varstring);
  if (getValueOf('popupCookies')) {
    Cookie.create(pg.option[varstring], String(pg.option[varstring]));
  }
}

function popupToggleShowOptions (dummy) {
  // just update state if dummy is true
  getValueOf('popupLiveOptionsExpanded');
  if (!dummy) { pg.option.popupLiveOptionsExpanded=!pg.option.popupLiveOptionsExpanded; }
  setPopupHTML((pg.option.popupLiveOptionsExpanded) ? '&amp;lt;&amp;lt;' : '&amp;gt;&amp;gt;',
	       'optionPopped');
  var s=document.getElementById('popupOptionsDiv');
  // if (!s) return;
  if (pg.option.popupLiveOptionsExpanded) { s.style.display='inline'; }
  else { s.style.display='none'; }
}

function popupOptionsCheckboxHTML(varstring, label, title) {
  var html='&lt;br&gt;';
  html += '&lt;span title=&quot;'+title+'&quot;&gt;';
  html += '&lt;input type=&quot;checkbox&quot; id=&quot;'+varstring+'Checkbox&quot; ';
  html += (window[varstring]) ? 'checked=&quot;checked&quot; ' : '';
  html += 'onClick=&quot;javascript:popupToggleVar(' + &quot;'&quot; + varstring + &quot;'&quot; +
    ')&quot;&gt;' + label + '&lt;/input&gt;&lt;/span&gt;';
  return html;
}

function popupLiveOptionsHTML() {
  var html = '';
  html += '&lt;br&gt;';
  html += '&lt;span title=&quot;' + popupString('Show/hide options') + '&quot; ';
  html += 'style=&quot;border: thin dotted black; cursor: pointer&quot; ';
  html += 'onClick=&quot;javascript:popupToggleShowOptions()&quot;&gt;';
  html += 'Options &lt;span id=&quot;optionPopped' + pg.idNumber + '&quot;&gt;&lt;/span&gt;';
  html += '&lt;/span&gt;';
  html += '&lt;div style=&quot;display: none&quot; id=&quot;popupOptionsDiv&quot;&gt;';
  html += popupOptionsCheckboxHTML('simplePopups', popupString('Simple popups'),
	       popupString('Never download extra stuff for images/previews'));
  html += popupOptionsCheckboxHTML('popupUnsimplifyLink', popupString('Preview only on click'),
	       popupString('Only start downloading when told to do so'));
  //html += popupOptionsCheckboxHTML('popupCookies', popupString('cookies'),
  //             popupString('Use cookies to store popups options'));
  html += popupOptionsCheckboxHTML('popupNavLinks', popupString('Show navigation links'),
	       popupString('Display navigation links at the top of the popup'));
  html += popupOptionsCheckboxHTML('popupImages', popupString('Show image previews'),
	       popupString('Load images'));
  html += popupOptionsCheckboxHTML('popupSummaryData', popupString('Show summary data'),
	       popupString('Show page summary data'));
  html += popupOptionsCheckboxHTML('popupPreviews', popupString('Show text previews'),
	       popupString('Show previews'));

  var extraOptions=[
		    'imagePopupsForImages',
		    'popupAdminLinks',
		    'popupAppendRedirNavLinks',
		    'popupCookies',
		    'popupFixDabs',
		    'popupFixRedirs',
		    'popupHistoricalLinks',
		    'popupImagesFromThisWikiOnly',
		    'popupImagesToggleSize',
		    'popupLastEditLink',
		    'popupLiveOptions',
		    'popupLoadImagesSequentially',
		    'popupNeverGetThumbs',
		    'popupOnlyArticleLinks',
		    'popupPreviewKillTemplates',
		    'popupPreviewFirstParOnly',
		    'popupShortcutKeys',
		    'popupSimplifyMainLink',
		    'removeTitles' // no ,
  ];
  for (var i=0; i&lt;extraOptions.length; ++i) {
    html += popupOptionsCheckboxHTML(extraOptions[i], extraOptions[i], popupString('Toggle this option'));
  }

  html += '&lt;/div&gt;';
  return html;
}

// ENDFILE: liveoptions.js
// STARTFILE: structures.js
pg.structures.original={};
pg.structures.original.popupLayout=function () {
  return ['popupBar', 'popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupData', 'popupOtherLinks',
	  'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
	  'popupMiscTools', ['popupRedlink', 'popupLiveOptions', 'popupUnsimplify'],
	  'popupPreview', 'popupFixDab'];
};
pg.structures.original.popupRedirSpans=function () {
  return ['popupRedir', 'popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'];
};
pg.structures.original.popupTitle=function (x) {
  log ('defaultstructure.popupTitle');
  if (!getValueOf('popupNavLinks')) { return navlinkStringToHTML('&lt;b&gt;&lt;&lt;mainlink&gt;&gt;&lt;/b&gt;',x.article,x.oldid); }
  return '';
};
pg.structures.original.popupTopLinks=function (x) {
  log ('defaultstructure.popupTopLinks');
  if (getValueOf('popupNavLinks')) { return navLinksHTML(x.article, x.hint, x.oldid); }
  return '';
};
pg.structures.original.popupImage=function(x) {
  log ('original.popupImage, x.article='+x.article+', pg.idNumber='+pg.idNumber);
  return imageHTML(x.article);
};
pg.structures.original.popupUnsimplify=function(x) {
  if (getValueOf('popupUnsimplifyLink')) {
    return '&lt;br&gt;&lt;span onClick=&quot;javascript:pop.unsimplify()&quot; ' +
    'style=&quot;cursor:pointer; border: thin dotted black&quot; '  +
    'title=&quot;' +popupString('Download preview data') + '&quot;&gt;' +
    'Get preview data' + '&lt;/span&gt;';
  }
  return '';
};
pg.structures.original.popupRedirTitle=pg.structures.original.popupTitle;
pg.structures.original.popupRedirTopLinks=pg.structures.original.popupTopLinks;


function copyStructure(oldStructure, newStructure) {
  pg.structures[newStructure]={};
  for (var prop in pg.structures[oldStructure]) {
    pg.structures[newStructure][prop]=pg.structures[oldStructure][prop];
  }
}

/** -- fancy -- **/
copyStructure('original', 'fancy');
pg.structures.fancy.popupTitle=function (x) {
  return navlinkStringToHTML('&lt;font size=+0&gt;&lt;&lt;mainlink&gt;&gt;&lt;/font&gt;',x.article,x.oldid);
};
pg.structures.fancy.popupTopLinks=function(x) {
  var hist='&lt;&lt;history|shortcut=h|hist&gt;&gt;|&lt;&lt;lastEdit|shortcut=/|last&gt;&gt;if(mainspace){|&lt;&lt;editors|shortcut=E|eds&gt;&gt;}';
  var watch='&lt;&lt;unwatch|unwatchShort&gt;&gt;|&lt;&lt;watch|shortcut=w|watchThingy&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m|move&gt;&gt;';
  return navlinkStringToHTML('if(talk){' +
			     '&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;new|shortcut=+|+&gt;&gt;*' + hist + '*' +
			     '&lt;&lt;article|shortcut=a&gt;&gt;|&lt;&lt;editArticle|edit&gt;&gt;' + '*' + watch + '*' + move +
			     '}else{&lt;&lt;edit|shortcut=e&gt;&gt;*' + hist +
			     '*&lt;&lt;talk|shortcut=t|&gt;&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;' +
			     '*' + watch + '*' + move+'}&lt;br&gt;', x.article, x.oldid);
};
pg.structures.fancy.popupOtherLinks=function(x) {
  var admin='&lt;&lt;unprotect|unprotectShort&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*&lt;&lt;undelete|undeleteShort&gt;&gt;|&lt;&lt;delete|shortcut=d|del&gt;&gt;';
  var user='&lt;&lt;contribs|shortcut=c&gt;&gt;if(wikimedia){|&lt;&lt;count|shortcut=#|#&gt;&gt;}';
  user+='if(ipuser){|&lt;&lt;arin&gt;&gt;}else{*&lt;&lt;email|shortcut=E|'+
    popupString('email')+'&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}';

  var normal='&lt;&lt;whatLinksHere|shortcut=l|links here&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r|related&gt;&gt;';
  return navlinkStringToHTML('&lt;br&gt;if(user){' + user + '*}if(admin){'+admin+'if(user){&lt;br&gt;}else{*}}' + normal,
			     x.article, x.oldid);
};
pg.structures.fancy.popupRedirTitle=pg.structures.fancy.popupTitle;
pg.structures.fancy.popupRedirTopLinks=pg.structures.fancy.popupTopLinks;
pg.structures.fancy.popupRedirOtherLinks=pg.structures.fancy.popupOtherLinks;


/** -- fancy2 -- **/
// hack for [[User:MacGyverMagic]]
copyStructure('fancy', 'fancy2');
pg.structures.fancy2.popupTopLinks=function(x) { // hack out the &lt;br&gt; at the end and put one at the beginning
  return '&lt;br&gt;'+pg.structures.fancy.popupTopLinks(x).replace(RegExp('&lt;br&gt;$','i'),'');
};
pg.structures.fancy2.popupLayout=function () { // move toplinks to after the title
  return ['popupBar', 'popupError', 'popupImage', 'popupTitle', 'popupData', 'popupTopLinks', 'popupOtherLinks',
	  'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
	  'popupMiscTools', ['popupRedlink', 'popupLiveOptions', 'popupUnsimplify'],
	  'popupPreview', 'popupFixDab'];
};

/** -- menus -- **/
copyStructure('original', 'menus');
pg.structures.menus.popupLayout=function () {
  return ['popupBar', 'popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupOtherLinks',
	  'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
	  'popupData', 'popupMiscTools', ['popupRedlink', 'popupLiveOptions', 'popupUnsimplify'],
	  'popupPreview', 'popupFixDab'];
};
pg.structures.menus.popupBar = function (x) {
  // return &lt;a href=&quot;javascript:toggleSticky(' + pg.current.link.navpopup.uid + ')&quot;&gt;(un)stick&lt;/a&gt;';
  return '';
};
function toggleSticky(uid) {
  var popDiv=document.getElementById('navpopup_maindiv'+uid);
  if (!popDiv) { return; }
  if (!popDiv.navpopup.sticky) { popDiv.navpopup.stick(); }
  else {
	popDiv.navpopup.unstick();
	popDiv.navpopup.hide();
  }
}
pg.structures.menus.popupTopLinks = function (x) {
  var s='';
  var dropdiv='&lt;div class=&quot;popup_drop&quot;&gt;';
  var menuspan='&lt;span class=&quot;popup_menu&quot;&gt;';
  var enddiv='&lt;/div&gt;';
  var endspan='&lt;/span&gt;';
  var hist='if(mainspace){&lt;line&gt;}&lt;&lt;history|shortcut=h&gt;&gt;if(mainspace){|&lt;&lt;editors|shortcut=E&gt;&gt;&lt;/line&gt;}';
  var lastedit='&lt;&lt;lastEdit|shortcut=/|show last edit&gt;&gt;&lt;&lt;lastContrib|last set of edits&gt;&gt;&lt;&lt;sinceMe|changes since mine&gt;&gt;';
  var linkshere='&lt;&lt;whatLinksHere|shortcut=l|what links here&gt;&gt;';
  var related='&lt;&lt;relatedChanges|shortcut=r|related changes&gt;&gt;';
  var search='&lt;&lt;search|shortcut=s&gt;&gt;if(wikimedia){|&lt;&lt;globalsearch|shortcut=g|global&gt;&gt;}';
  search += '|&lt;&lt;google|shortcut=G|web&gt;&gt;';
  var watch='&lt;&lt;unwatch|unwatchShort&gt;&gt;|&lt;&lt;watch|shortcut=w|watchThingy&gt;&gt;';
  var protect='&lt;&lt;unprotect|unprotectShort&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;';
  var del='&lt;&lt;undelete|undeleteShort&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m|move page&gt;&gt;';
  if (getValueOf('popupActionsMenu')) {
    s += '&lt;&lt;mainlink&gt;&gt;*' + dropdiv + '&lt;a href=&quot;#&quot;&gt;'+popupString('actions') + '&lt;/a&gt;';
  } else { s+= dropdiv + '&lt;&lt;mainlink&gt;&gt;'; }
  s+= menuspan +
  'if(oldid){&lt;line&gt;&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;editOld|shortcut=e|this&amp;nbsp;revision&gt;&gt;&lt;/line&gt;' +
  '&lt;&lt;revert|shortcut=v&gt;&gt;' +
	'}else{&lt;&lt;edit|shortcut=e&gt;&gt;}' +
	'if(talk){&lt;&lt;new|shortcut=+|new topic&gt;&gt;}' +
  hist + lastedit + move + linkshere + related +
	'&lt;&lt;nullEdit|shortcut=n|null edit&gt;&gt;' +
	'&lt;line&gt;' + search + '&lt;/line&gt;' +
	'&lt;hr&gt;' +
	'&lt;line&gt;' + watch + '&lt;/line&gt;' +
	'if(admin){&lt;line&gt;' + protect + '&lt;/line&gt;&lt;line&gt;' + del + '&lt;/line&gt;}' +
	'if(talk){' +
	'&lt;hr&gt;' +
	'&lt;&lt;article|shortcut=a|view article&gt;&gt;' +
	'&lt;&lt;editArticle|edit article&gt;&gt;' +
	'}else{' +
	'&lt;hr&gt;' +
	'&lt;&lt;talk|shortcut=t|talk page&gt;&gt;' +
	'&lt;&lt;editTalk|edit talk&gt;&gt;' +
	'&lt;&lt;newTalk|shortcut=+|new topic&gt;&gt;' +
	'}' +
	endspan + enddiv;
  s+='if(user){*' + dropdiv + '&lt;a href=&quot;#&quot;&gt;'+popupString('user')+'&lt;/a&gt;' + menuspan +
	'&lt;line&gt;&lt;&lt;userPage|shortcut=u|user page&gt;&gt;|&lt;&lt;userSpace|space&gt;&gt;&lt;/line&gt;' +
	'&lt;&lt;userTalk|shortcut=t|user talk&gt;&gt;' +
	'&lt;&lt;editUserTalk|edit user talk&gt;&gt;' +
	'&lt;&lt;newUserTalk|shortcut=+|leave comment&gt;&gt;' +
	'if(ipuser){&lt;&lt;arin&gt;&gt;}else{&lt;&lt;email|shortcut=E|email user&gt;&gt;}' +
	'&lt;hr&gt;' +
	'if(wikimedia){&lt;line&gt;}' +
	'&lt;&lt;contribs|shortcut=c|contributions&gt;&gt;' +
	'if(wikimedia){|&lt;&lt;contribsTree|tree&gt;&gt;&lt;/line&gt;}' +
	'&lt;&lt;userlog|shortcut=L|user log&gt;&gt;' +
	'if(wikimedia){&lt;&lt;count|shortcut=#|edit counter&gt;&gt;}' +
	'if(admin){&lt;line&gt;&lt;&lt;unblock|unblockShort&gt;&gt;|&lt;&lt;block|shortcut=b|block user&gt;&gt;&lt;/line&gt;}' +
	'&lt;&lt;blocklog|shortcut=B|block log&gt;&gt;' +
  getValueOf('popupExtraUserMenu') +
  endspan  + enddiv + '}';
  return navlinkStringToHTML(s, x.article, x.oldid);
};

pg.structures.menus.popupRedirTitle=pg.structures.menus.popupTitle;
pg.structures.menus.popupRedirTopLinks=pg.structures.menus.popupTopLinks;

// ENDFILE: structures.js
// STARTFILE: autoedit.js
function getParamValue(paramName) {
  var cmdRe=RegExp('[&amp;?]'+paramName+'=([^&amp;]*)');
  var h=document.location;
  var m=cmdRe.exec(h);
  if (m) {
    try {
      return decodeURI(m[1]);
    } catch (someError) {}
  }
  return null;
}

function substitute(data,cmdBody) {
  // alert('sub\nfrom: '+cmdBody.from+'\nto: '+cmdBody.to+'\nflags: '+cmdBody.flags);
  var fromRe=RegExp(cmdBody.from, cmdBody.flags);
  return data.replace(fromRe, cmdBody.to);
}

function execCmds(data, cmdList) {
  for (var i=0; i&lt;cmdList.length; ++i) {
    data=cmdList[i].action(data, cmdList[i]);
  }
  return data;
}

function parseCmd(str) {
  // returns a list of commands
  if (!str.length) { return []; }
  var p=false;
  switch (str.charAt(0)) {
  case 's':
    p=parseSubstitute(str);
    break;
  case 'j':
    p=parseJavascript(str);
    break;
  default:
    return false;
  }
  if (p) { return [p].concat(parseCmd(p.remainder)); }
  return false;
}

function unEscape(str, sep) {
  return str.split('\\\\').join('\\').split('\\'+sep).join(sep).split('\\n').join('\n');
}


function runJavascript(data, argWrapper) {
  // flags aren't used (yet)

  // from the user's viewpoint,
  // data is a special variable may appear inside code
  // and gets assigned the text in the edit box

  // alert('eval-ing '+argWrapper.code);

  // commenting this out - it's something of a security nightmare and it's not actually used

  //return eval(argWrapper.code);
}

function parseJavascript(str) {
  // takes a string like j/code/;othercmds and parses it

  var tmp,code,flags;

  if (str.length&lt;3) { return false; }
  var sep=str.charAt(1);
  str=str.substring(2);

  tmp=skipOver(str,sep);
  if (tmp) { code=tmp.segment.split('\n').join('\\n'); str=tmp.remainder; }
  else { return false; }

  flags='';
  if (str.length) {
    tmp=skipOver(str,';') || skipToEnd(str, ';');
    if (tmp) {flags=tmp.segment; str=tmp.remainder; }
  }

  return { action: runJavascript, code: code, flags: flags, remainder: str };
}

function parseSubstitute(str) {
  // takes a string like s/a/b/flags;othercmds and parses it

  var from,to,flags,tmp;

  if (str.length&lt;4) { return false; }
  var sep=str.charAt(1);
  str=str.substring(2);

  tmp=skipOver(str,sep);
  if (tmp) { from=tmp.segment; str=tmp.remainder; }
  else { return false; }

  tmp=skipOver(str,sep);
  if (tmp) { to=tmp.segment; str=tmp.remainder; }
  else { return false; }

  flags='';
  if (str.length) {
    tmp=skipOver(str,';') || skipToEnd(str, ';');
    if (tmp) {flags=tmp.segment; str=tmp.remainder; }
  }

  return {action: substitute, from: from, to: to, flags: flags, remainder: str};

}

function skipOver(str,sep) {
  var endSegment=findNext(str,sep);
  if (endSegment&lt;0) { return false; }
  var segment=unEscape(str.substring(0,endSegment), sep);
  return {segment: segment, remainder: str.substring(endSegment+1)};
}

function skipToEnd(str,sep) {
  return {segment: str, remainder: ''};
}

function findNext(str, ch) {
  for (var i=0; i&lt;str.length; ++i) {
    if (str.charAt(i)=='\\') { i+=2; }
    if (str.charAt(i)==ch) { return i; }
  }
  return -1;
}

function setCheckbox(param, box) {
  var val=getParamValue(param);
  if (val!==null) {
	switch (val) {
    case '1': case 'yes': case 'true':
      box.checked=true;
      break;
    case '0': case 'no':  case 'false':
      box.checked=false;
    }
  }
}

function autoEdit() {
  if (!document.editform) { return false; }
  if (window.autoEdit.alreadyRan) { return false; }
  window.autoEdit.alreadyRan=true;
  var cmdString=getParamValue('autoedit');
  if (cmdString) {
    try {
      var editbox=document.editform.wpTextbox1;
    } catch (dang) { return; }
    var cmdList=parseCmd(cmdString);
    var input=editbox.value;
    var output=execCmds(input, cmdList);
    editbox.value=output;
  }

  var summary=getParamValue('autosummary');
  var summaryprompt=getParamValue('autosummaryprompt');
  if (summaryprompt) {
    var txt='Enter a non-empty edit summary or press cancel to abort';
    if (popupString) { txt=popupString(txt); }
    var response=prompt(txt, summary);
    if (response) { summary=response; }
    else { return; }
  }
  if (summary) { document.editform.wpSummary.value=summary; }

  setCheckbox('autominor', document.editform.wpMinoredit);
  setCheckbox('autowatch', document.editform.wpWatchthis);

  var btn=getParamValue('autoclick');
  if (btn) {
    if (document.editform &amp;&amp; document.editform[btn]) {
      var headings=document.getElementsByTagName('h1');
      if (headings) {
	var div=document.createElement('div');
	var button=document.editform[btn];
	div.innerHTML='&lt;font size=+1&gt;&lt;b&gt;The &quot;' + button.value +
	  '&quot; button has been automatically clicked.' +
	  ' Please wait for the next page to load.&lt;/b&gt;&lt;/font&gt;';
	document.title='('+document.title+')';
	headings[0].parentNode.insertBefore(div, headings[0]);
	button.click();
      }
    } else {
      alert('autoedit.js\n\nautoclick: could not find button &quot;'+ btn +'&quot;.');
    }
  }
}

addOnloadHook(autoEdit);

// ENDFILE: autoedit.js
// STARTFILE: downloader.js
/**
   @fileoverview
   {@link Downloader}, a xmlhttprequest wrapper, and helper functions.
*/

/**
   Creates a new Downloader
   @constructor
   @class The Downloader class. Create a new instance of this class to download stuff.
   @param {String} url The url to download. This can be omitted and supplied later.
*/
function Downloader(url) {
  // Source: http://jibbering.com/2002/4/httprequest.html
  /** xmlhttprequest object which we're wrapping */
  this.http = false;

  /*@cc_on @*/
  /*@if (@_jscript_version &gt;= 5)
  // JScript gives us Conditional compilation,
  // we can cope with old IE versions.
  // and security blocked creation of the objects.
  try {
  this.http = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
  } catch (e) {
  try {
  this.http = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
  } catch (E) {
  // this.http = false;
  }
  }
  @end @*/

  if (! this.http &amp;&amp; typeof XMLHttpRequest!='undefined') { this.http = new XMLHttpRequest(); }
  /** The url to download */
  this.url = url;
  /** A universally unique ID number */
  this.id=null;
  /** Modification date, to be culled from the incoming headers */
  this.lastModified = null;
  /** What to do when the download completes successfully */
  this.callbackFunction = null;
  /** Flag set on &lt;code&gt;abort&lt;/code&gt; */
  this.aborted = false;
}

new Downloader();

/** Submits the http request. */
Downloader.prototype.send = function (x) {
    if (!this.http) { return null; }
    return this.http.send(x);
};
/** Aborts the download, setting the &lt;code&gt;aborted&lt;/code&gt; field to true.  */
Downloader.prototype.abort = function () {
  if (!this.http) { return null; }
  this.aborted=true;
  return this.http.abort();
};
/** Returns the downloaded data. */
Downloader.prototype.getData = function () {if (!this.http) { return null; } return this.http.responseText;};
/** Prepares the download. */
Downloader.prototype.setTarget = function () {if (!this.http) { return null; } this.http.open(&quot;GET&quot;, this.url, true);};
/** Gets the state of the download. */
Downloader.prototype.getReadyState=function () {if (!this.http) { return null; } return this.http.readyState;};

pg.misc.downloadsInProgress = { };

/** Starts the download.
    Note that setTarget {@link Downloader#setTarget} must be run first
*/
Downloader.prototype.start=function () {
  if (!this.http) { return; }
  pg.misc.downloadsInProgress[this.id] = this;
  this.http.send(null);
};

/** Gets the 'Last-Modified' date from the download headers.
    Should be run after the download completes.
    Returns &lt;code&gt;null&lt;/code&gt; on failure.
    @return {Date}
*/
Downloader.prototype.getLastModifiedDate=function () {
  if(!this.http) { return null; }
  var lastmod=null;
  try {
    lastmod=this.http.getResponseHeader('Last-Modified');
  } catch (err) {}
  if (lastmod) { return new Date(lastmod); }
  return null;
};

/** Sets the callback function.
    @param {Function} f callback function, called as &lt;code&gt;f(this)&lt;/code&gt; on success
 */
Downloader.prototype.setCallback = function (f) {
  if(!this.http) { return; }
  this.http.onreadystatechange = f;
};

//////////////////////////////////////////////////
// helper functions

/** Creates a new {@link Downloader} and prepares it for action.
    @param {String} url The url to download
    @param {integer} id The ID of the {@link Downloader} object
    @param {Function} callback The callback function invoked on success
    @return {String/Downloader} the {@link Downloader} object created, or 'ohdear' if an unsupported browser
*/
function newDownload(url, id, callback) {
  var d=new Downloader(url);
  if (!d.http) { return 'ohdear'; }
  d.id=id;
  d.setTarget();
  var f = function () {
    if (d.getReadyState() == 4) {
      delete pg.misc.downloadsInProgress[this.id];
      d.data=d.getData();
      d.lastModified=d.getLastModifiedDate();
      callback(d);
    }
  };
  d.setCallback(f);
  return d;
}
/** Simulates a download from cached data.
    The supplied data is put into a {@link Downloader} as if it had downloaded it.
    @param {String} url The url.
    @param {integer} id The ID.
    @param {Function} callback The callback, which is invoked immediately as &lt;code&gt;callback(d)&lt;/code&gt;,
			       where &lt;code&gt;d&lt;/code&gt; is the new {@link Downloader}.
    @param {String} data The (cached) data.
    @param {Date} lastModified The (cached) last modified date.
*/
function fakeDownload(url, id, callback, data, lastModified) {
  var d=newDownload(url,callback);
  d.id=id; d.data=data;
  d.lastModified=lastModified;
  return callback(d);
}

/**
   Starts a download.
    @param {String} url The url to download
    @param {integer} id The ID of the {@link Downloader} object
    @param {Function} callback The callback function invoked on success
    @return {String/Downloader} the {@link Downloader} object created, or 'ohdear' if an unsupported browser
 */
function startDownload(url, id, callback) {
  var d=newDownload(url, id, callback);
  if (typeof d == typeof '' ) { return d; }
  d.start();
  return d;
}

/**
   Aborts all downloads which have been started.
 */
function abortAllDownloads() {
  for ( var x in pg.misc.downloadsInProgress ) {
    try {
      pg.misc.downloadsInProgress[x].aborted=true;
      pg.misc.downloadsInProgress[x].abort();
      delete pg.misc.downloadsInProgress[x];
    } catch (e) { }
  }
}

// ENDFILE: downloader.js
// STARTFILE: livepreview.js
// Last update: 21:51, 15 Feb 2005 (UTC)

var lp={};

function setupLivePreview() {
  // User options
  window.lp.userName=window.lp.userName||'Wikipedian';
  window.lp.userSignature=window.lp.userSignature||window.lp.userName;
  window.lp.showImages=false; //window.lp.showImages||true;

  // System options
  window.lp.languageCode=window.lp.languageCode||'en';
  window.lp.interwikiCodes=pg.wiki.interwiki;
  window.lp.baseArticlePath=pg.wiki.articlePath;
  window.lp.userNamespace=pg.ns.user;
  window.lp.imageNamespace=pg.ns.image;
  window.lp.categoryNamespace=pg.ns.category;
  window.lp.imageBasePath=getImageUrlStart(pg.wiki.hostname);

  window.lp.mathBasePath=window.lp.mathBasePath||'/math/';
  window.lp.imageFallbackPath=window.lp.imageFallbackPath||'http://upload.wikimedia.org/wikipedia/commons/';
  window.lp.defaultThumbWidth=getValueOf('popupImageSize');
  window.lp.skinMagnifyClip=window.lp.skinMagnifyClip||'/skins/common/images/magnify-clip.png';

}

function wiki2html(str){
  str=strip_cr(str);
  var w=new WikiCode();
  w.lines=str.split(/\n/);
  w.parse();
  return w.html;
}

function WikiCode() {
  this.lines=[];
  this.html='';
  window.lp.signature='[['+window.lp.userNamespace+':'+window.lp.userName+'|'+window.lp.userSignature+']]';
  window.lp.blockImage=new RegExp('^\\[\\['+window.lp.imageNamespace+':.*?\\|.*?(?:frame|thumbnail|thumb|none|right|left|center)','i');
}
WikiCode.prototype._parse_table_data=function(){
  var td_match,td_line;
  td_match=this.lines.shift().match(RegExp(/^(\|\+|\||!)((?:([^[|]*?)\|(?!\|))?(.*))$/));
  if (td_match[1]=='|+'){ this.html+='&lt;caption'; }
  else { this.html+='&lt;t'+((td_match[1]=='|')?'d':'h'); }
  if (typeof td_match[3]!='undefined') { this.html+=' '+td_match[3];td_line=td_match[4].split('||'); }
  else { td_line=td_match[2].split('||'); }
  this.html+='&gt;';
  while(td_line.length&gt;1){ this.lines.unshift(td_match[1]+td_line.pop()); }
  this.html+=_parse_inline_nowiki(td_line[0]);
  var td=new WikiCode();
  var table_count=0;
  while(this.lines.length){
    if(this.lines[0].charAt(0)=='|') {
      if(table_count===0) {break;}
      else if(this.lines[0].charAt(1)=='}'){--table_count;}
    }
    else if(this.lines[0].charAt(0)=='!'&amp;&amp;table_count===0) {break;}
    else if(this.lines[0].substr(0,2)=='{|') {table_count++;}
    td.lines.push(this.lines.shift());
  }
  if(td.lines.length) {td.parse();}
  this.html+=td.html;
};
WikiCode.prototype._parse_pre=function(){
  this.html+='&lt;pre&gt;';
  do{
    this._endline(_parse_inline_nowiki(this.lines[0].substring(1,this.lines[0].length))+&quot;\n&quot;);
  } while(this.lines.length&amp;&amp;this.lines[0].charAt(0)==' ');
  this.html+='&lt;/pre&gt;';
};
WikiCode.prototype._parse_block_image=function(){
  this.html+=_parse_image(this.lines.shift());
};
WikiCode.prototype._endline=function(str){
  this.html+=str;
  this.lines.shift();
};
WikiCode.prototype.parse=function() {
  var p=false;
  do{
    var h_match=this.lines[0].match(/^(={1,6})(.*)\1(.*)$/);
    if(h_match){
      p=false;
      this._endline('&lt;h'+h_match[1].length+'&gt;' + _parse_inline_nowiki(h_match[2])+
		    '&lt;/h'+h_match[1].length+'&gt;' + h_match[3]);
    }else if(this.lines[0].match(/^[*#:;]/)){
      p=false;
      this._parse_list();
    }else if(this.lines[0].charAt(0)==' '){
      p=false;
      this._parse_pre();
    }else if(this.lines[0].substr(0,2)=='{|'){
      p=false;
      this._parse_table();
    }else if(this.lines[0].match(/^----+$/)){
      p=false;
      this._endline('&lt;hr/&gt;');
    }else if(this.lines[0].match(window.lp.blockImage)){
      p=false;
      this._parse_block_image();
    }else{
      if(this.lines[0]===''){
	p=(this.lines.length&gt;1&amp;&amp;this.lines[1]==='');
	if(p){this._endline('&lt;p&gt;&lt;br /&gt;');}
      } else {
	if(!p){this.html+='&lt;p&gt;'; p=true;}
	this.html+=_parse_inline_nowiki(this.lines[0])+' ';
      }
      this.lines.shift();
    }
  }while(this.lines.length);
};
WikiCode.prototype._parse_list=function(){
  var prev='';
  var l_match,imatch,dt_match;
  while(this.lines.length&amp;&amp;(l_match=this.lines[0].match(/^([*#:;]+)(.*)$/))){
    this.lines.shift();
    imatch=str_imatch(prev,l_match[1]);
    for(var i=prev.length-1;i&gt;=imatch;i--){
      if(prev.charAt(i)=='*'){this.html+='&lt;/ul&gt;';}
      else if(prev.charAt(i)=='#'){this.html+='&lt;/ol&gt;';}
      else{
	this.html+='&lt;/d'+((prev.charAt(i)==';')?'t':'d')+'&gt;';
	switch(l_match[1].charAt(i)){
	  case'': case'*': case'#':
	    this.html+='&lt;/dl&gt;';
	}
      }
    }
    for (i=imatch;i&lt;l_match[1].length;i++){
      if(l_match[1].charAt(i)=='*'){this.html+='&lt;ul&gt;';}
      else if(l_match[1].charAt(i)=='#'){this.html+='&lt;ol&gt;';}
      else{
	switch(prev.charAt(i)){
	  case'':case'*':case'#':
	    this.html+='&lt;dl&gt;';
	}
	this.html+='&lt;d'+((l_match[1].charAt(i)==';')?'t':'d')+'&gt;';
      }
    }
    switch(l_match[1].charAt(l_match[1].length-1)) {
      case'*': case'#': this.html+='&lt;li&gt;'+_parse_inline_nowiki(l_match[2]); break;
      case';':
	dt_match=l_match[2].match(/(.*?) (:.*?)$/);
      if(dt_match) {
	this.html+=_parse_inline_nowiki(dt_match[1]);
	this.lines.unshift(dt_match[2]);}
      break;
      case':':
	this.html+=_parse_inline_nowiki(l_match[2]);
    }
    prev=l_match[1];
  }
  for(i=prev.length-1;i&gt;=0;i--){
    if(prev.charAt(i)=='*'){this.html+='&lt;/ul&gt;';}
    else if(prev.charAt(i)=='#'){this.html+='&lt;/ol&gt;';}
    else{this.html+='&lt;/d'+((prev.charAt(i)==';')?'t':'d')+'&gt;&lt;/dl&gt;';}
  }
};
WikiCode.prototype._parse_table=function(){var table_match=this.lines[0].match(/^\{\|( .*)$/);if(table_match){this._endline('&lt;table'+table_match[1]+'&gt;');}else{this._endline('&lt;table&gt;');}do{if(this.lines[0].charAt(0)=='|'){switch(this.lines[0].charAt(1)){case'}':this._endline('&lt;/table&gt;');return;case'-':this._endline('&lt;tr '+this.lines[0].match(/\|-*(.*)/)[1]+'&gt;');break;default:this._parse_table_data();}}else if(this.lines[0].charAt(0)=='!'){this._parse_table_data();}else{this.lines.shift();}}while(this.lines.length);};
function _parse_image(str){var attr=str.substring(window.lp.imageNamespace.length+3,str.length-2).split(/\s*\|\s*/);var filename=attr[0];var caption=attr[attr.length-1];var width,w_match;var thumb=false;var frame=false;var center=false;var align='';var html='';do{w_match=attr[0].match(/^(\d*)px$/);if(w_match){width=w_match[1];}else switch(attr[0]){case'thumb':case'thumbnail':thumb=true;case'frame':frame=true;break;case'none':case'right':case'left':center=false;align=attr[0];break;case'center':center=true;align='none';}attr.shift();}while(attr.length);if(frame){if(align===''){align='right';}html+=&quot;&lt;div class='thumb t&quot;+align+&quot;'&gt;&quot;;if(thumb){if(!width){width=window.lp.defaultThumbWidth;}html+=&quot;&lt;div style='width:&quot;+(2+parseInt(width,10))+&quot;px;'&gt;&quot;;html+=_make_image(filename,caption,width);html+=&quot;&lt;div class='thumbcaption'&gt;&lt;div class='magnify' style='float:right'&gt;&lt;a href='&quot;+window.lp.baseArticlePath+window.lp.imageNamespace+':'+filename+&quot;' class='internal' title='Enlarge'&gt;&lt;img src='&quot;+window.lp.skinMagnifyClip+&quot;' /&gt;&lt;/a&gt;&lt;/div&gt;&quot;+_parse_inline_nowiki(caption)+&quot;&lt;/div&gt;&quot;;}else{html+='&lt;div&gt;';html+=_make_image(filename,caption);html+=&quot;&lt;div class='thumbcaption'&gt;&quot;+_parse_inline_nowiki(caption)+&quot;&lt;/div&gt;&quot;;}html+='&lt;/div&gt;&lt;/div&gt;';}else if(align){html+=&quot;&lt;div class='float&quot;+align+&quot;'&gt;&lt;span&gt;&quot;+_make_image(filename,caption,width)+&quot;&lt;/span&gt;&lt;/div&gt;&quot;;}else{return _make_image(filename,caption,width);}if(center){return&quot;&lt;div class='center'&gt;&quot;+html+'&lt;/div&gt;';}else{return html;}}
function _parse_inline_nowiki(str){var start,lastend=0;var substart=0,nestlev=0,open,close,subloop;var html='';while(-1!=(start=str.indexOf('&lt;'+'nowiki&gt;',substart))){html+=_parse_inline_wiki(str.substring(lastend,start));start+=8;substart=start;subloop=true;do{open=str.indexOf('&lt;'+'nowiki&gt;',substart);close=str.indexOf('&lt;/nowiki&gt;',substart);if(close&lt;=open||open==-1){if(close==-1){return html+html_entities(str.substr(start));}substart=close+9;if(nestlev){nestlev--;}else{lastend=substart;html+=html_entities(str.substring(start,lastend-9));subloop=false;}}else{substart=open+8;nestlev++;}}while(subloop);}return html+_parse_inline_wiki(str.substr(lastend));};
function _make_image(filename,caption,width){filename=filename.charAt(0).toUpperCase()+filename.substr(1);filename=filename.replace(/ /g,'_');var md5=hex_md5(filename);var source=md5.charAt(0)+'/'+md5.substr(0,2)+'/'+filename;var img;if(window.lp.showImages){if(width){width=&quot;width='&quot;+width+&quot;px'&quot;;}img=&quot;&lt;img onerror='this.onerror=null;this.src=\&quot;&quot;+window.lp.imageFallbackPath+source+&quot;\&quot;;' src='&quot;+window.lp.imageBasePath+source+&quot;' alt='&quot;+caption+&quot;' &quot;+width+&quot;/&gt;&quot;;}else{img=window.lp.imageNamespace+':'+filename+&quot; &lt;em style='color:red;'&gt;(images disabled)&lt;/em&gt;&quot;;}caption=_strip_inline_wiki(caption);return&quot;&lt;a class='image' title='&quot;+caption+&quot;' href='&quot;+window.lp.baseArticlePath+window.lp.imageNamespace+':'+filename+&quot;'&gt;&quot;+img+&quot;&lt;/a&gt;&quot;;}
function _parse_inline_images(str){var start,substart=0,nestlev=0;var loop,close,open,wiki,html;while(-1!=(start=str.indexOf('[[',substart))){if(str.substr(start+2).match(RegExp('^'+window.lp.imageNamespace+':','i'))){loop=true;substart=start;do{substart+=2;close=str.indexOf(']]',substart);open=str.indexOf('[[',substart);if(close&lt;=open||open==-1){if(close==-1){return str;}substart=close;if(nestlev){nestlev--;}else{wiki=str.substring(start,close+2);html=_parse_image(wiki);str=str.replace(wiki,html);substart=start+html.length;loop=false;}}else{substart=open;nestlev++;}}while(loop);}else{break;}}return str;}

function _parse_inline_wiki(str){
  var aux_match,math_md5;
  str=_parse_inline_images(str);
  while (aux_match=str.match(/&lt;(?:)math&gt;(.*?)&lt;\/math&gt;/i)) {
    math_md5=hex_md5(aux_match[1]);
    str=str.replace(aux_match[0],&quot;&lt;img src='&quot;+window.lp.mathBasePath+math_md5+'.png'+&quot;' /&gt;&quot;);
  }
  //  log('livepreview: str='+str);
  return str.replace(/'''''(.*?)''(.*?)'''/g,'&lt;strong&gt;&lt;em&gt;$1&lt;/em&gt;$2&lt;/strong&gt;')
    .replace(/'''''(.*?)'''(.*?)''/g,'&lt;em&gt;&lt;strong&gt;$1&lt;/strong&gt;$2&lt;/em&gt;')
    .replace(/'''(.*?)''(.*?)'''''/g,'&lt;strong&gt;$1&lt;em&gt;$2&lt;/em&gt;&lt;/strong&gt;')
    .replace(/'''(.*?)'''/g,'&lt;strong&gt;$1&lt;/strong&gt;')
    .replace(/''(.*?)''/g,'&lt;em&gt;$1&lt;/em&gt;')
    .replace(/~{5}(?!~)/g,Date())
    .replace(/~{4}(?!~)/g,window.lp.signature+' '+Date())
    .replace(/~{3}(?!~)/g,window.lp.signature)
    .replace(RegExp('\\[\\[:((?:'+window.lp.categoryNamespace+'|'+window.lp.interwikiCodes+'):.*?)\\]\\]','gi'),
	     &quot;&lt;a href='&quot;+window.lp.baseArticlePath+&quot;$1'&gt;$1&lt;/a&gt;&quot;)
    .replace(RegExp('\\[\\[(?:'+window.lp.categoryNamespace+'|'+window.lp.interwikiCodes+'):.*?\\]\\]','gi'),'')
    .replace(/\[\[:?([^|]*?)\]\](\w*)/g,&quot;&lt;a href='&quot;+window.lp.baseArticlePath+&quot;$1'&gt;$1$2&lt;/a&gt;&quot;)
    .replace(/\[\[:?(.*?)\|([^\]]+?)\]\](\w*)/g,&quot;&lt;a href='&quot;+window.lp.baseArticlePath+&quot;$1'&gt;$2$3&lt;/a&gt;&quot;)
    .replace(/\[\[:?([^\]]*?:)?(.*?)( *\(.*?\))?\|\]\]/g,&quot;&lt;a href='&quot;+window.lp.baseArticlePath+&quot;$1$2$3'&gt;$2&lt;/a&gt;&quot;)
    .replace(/\[((https?|news|ftp|mailto|gopher|irc):(\/*)([^\]]*?)) (.*?)\]/g,&quot;&lt;a class='external' title='$1' href='$1'&gt;$5&lt;/a&gt;&quot;)
    .replace(/\[(https?:\/\/.*?)\]/g,&quot;&lt;a class='external' title='$1' href='$1'&gt;[#]&lt;/a&gt;&quot;)
    .replace(/\[((news|ftp|mailto|gopher|irc):(\/*)(.*?))\]/g,&quot;&lt;a class='external' title='$1' href='$1'&gt;$1&lt;/a&gt;&quot;)
    .replace(/(^| )((https?|news|ftp|mailto|gopher|irc):(\/*)([^ $]*))/g,&quot;$1&lt;a class='external' title='$2' href='$2'&gt;$2&lt;/a&gt;&quot;)
    .replace('__NOTOC__','')
    .replace('__NOEDITSECTION__','');
} /* comment for enscript */
function _strip_inline_wiki(str){return str.replace(/\[\[[^\]]*\|(.*?)\]\]/g,'$1').replace(/\[\[(.*?)\]\]/g,'$1').replace(/''(.*?)''/g,'$1');}
function max(a,b){if(a&gt;b){return a;}return b;}
function min(a,b){if(a&lt;b){return a;}return b;}
function str_imatch(str_a,str_b){var lim=min(str_a.length,str_b.length);for(var i=0;i&lt;lim;i++){if(str_a.charAt(i)!=str_b.charAt(i)){return i;}}return i;}
function strip_cr(str){return str.replace(/\n\r/g,&quot;\n&quot;).replace(/\r/g,'');}
function html_entities(str){return str.replace(/&amp;/g,&quot;&amp;amp;&quot;).replace(/&lt;/g,&quot;&amp;lt;&quot;).replace(/&gt;/g,&quot;&amp;gt;&quot;);}
//&lt;/math&gt;

// ENDFILE: livepreview.js
// STARTFILE: pageinfo.js
function popupFilterPageSize(data) {return formatBytes(data.length);}
function popupFilterCountLinks(data) {
  var num=countLinks(data);return String(num) + '&amp;nbsp;' + ((num!=1)?popupString('wikiLinks'):popupString('wikiLink'));
}

function popupFilterCountImages(data) {
  var num=countImages(data);return String(num) + '&amp;nbsp;' + ((num!=1)?popupString('images'):popupString('image'));
}

function popupFilterCountCategories(data) {
  var num=countCategories(data); return String(num) + '&amp;nbsp;' + ((num!=1)?popupString('categories'):popupString('category'));
}


function popupFilterLastModified(data,download) {
  var lastmod=download.lastModified;
  var now=new Date();
  var age=now-lastmod;
  if (lastmod &amp;&amp; getValueOf('popupLastModified')) {
    return (formatAge(age) + ' ' + popupString('old')).replace(RegExp(' ','g'), '&amp;nbsp;');
  }
  return '';
}

function formatAge(age) {
  // coerce into a number
  var a=0+age, aa=a;

  var seclen  = 1000;
  var minlen  = 60*seclen;
  var hourlen = 60*minlen;
  var daylen  = 24*hourlen;
  var weeklen = 7*daylen;

  var numweeks = (a-a%weeklen)/weeklen; a = a-numweeks*weeklen; var sweeks = addunit(numweeks, 'week');
  var numdays  = (a-a%daylen)/daylen;   a = a-numdays*daylen;   var sdays  = addunit(numdays, 'day');
  var numhours = (a-a%hourlen)/hourlen; a = a-numhours*hourlen; var shours = addunit(numhours,'hour');
  var nummins  = (a-a%minlen)/minlen;   a = a-nummins*minlen;   var smins  = addunit(nummins, 'minute');
  var numsecs  = (a-a%seclen)/seclen;   a = a-numsecs*seclen;   var ssecs  = addunit(numsecs, 'second');

  //alert( [numdays,numhours,nummins,numsecs].join(':') );

  if (aa &gt; 4*weeklen) { return sweeks; }
  if (aa &gt; weeklen)   { return sweeks + ' ' + sdays; }
  if (aa &gt; daylen)    { return sdays  + ' ' + shours; }
  if (aa &gt; 6*hourlen) { return shours; }
  if (aa &gt; hourlen)   { return shours + ' ' + smins; }
  if (aa &gt; 10*minlen) { return smins; }
  if (aa &gt; minlen)    { return smins  + ' ' + ssecs; }
  return ssecs;
}

function addunit(num,str) { return '' + num + ' ' + ((num!=1) ? popupString(str+'s') : popupString(str)) ;}

function runPopupFilters(list, data, download) {
  var ret=[];
  for (var i=0; i&lt;list.length; ++i) {
    if (list[i] &amp;&amp; typeof list[i] == 'function') {
      var s=list[i](data, download);
      if (s) { ret.push(s); }
    }
  }
  return ret;
}

function getPageInfo(data, download) {
  if (!data || data.length === 0) { return popupString('Empty page'); }

  var popupFilters=getValueOf('popupFilters') || [];
  var extraPopupFilters = getValueOf('extraPopupFilters') || [];
  var pageInfoArray = runPopupFilters(popupFilters.concat(extraPopupFilters), data, download);

  var pageInfo=pageInfoArray.join(', ');
  if (pageInfo !== '' ) { pageInfo = upcaseFirst(pageInfo); }
  return pageInfo;
}


// this could be improved!
function countLinks(wikiText) { return wikiText.split('[[').length - 1; }

// if N = # matches, n = # brackets, then
// String.parenSplit(regex) intersperses the N+1 split elements
// with Nn other elements. So total length is
// L= N+1 + Nn = N(n+1)+1. So N=(L-1)/(n+1).

function countImages(wikiText) {return (wikiText.parenSplit(pg.re.image).length - 1) / (pg.re.imageBracketCount + 1);}

function countCategories(wikiText) {return (wikiText.parenSplit(pg.re.category).length - 1) / (pg.re.categoryBracketCount + 1); }

function popupFilterStubDetect(data)     { return (isStub(data))     ? popupString('stub')     : ''; }
function popupFilterDisambigDetect(data) { return (isDisambig(data)) ? popupString('disambig') : ''; }

function formatBytes(num) {return (num &gt; 949) ? (Math.round(num/100)/10+popupString('kB')) : (num +'&amp;nbsp;' + popupString('bytes')) ;}

// ENDFILE: pageinfo.js
// STARTFILE: titles.js
/**
   @fileoverview Defines the {@link Title} class, and associated crufty functions.

   &lt;code&gt;Title&lt;/code&gt; deals with article titles and their various
   forms.  {@link Stringwrapper} is the parent class of
   &lt;code&gt;Title&lt;/code&gt;, which exists simply to make things a little
   neater.

*/

/**
   Creates a new Stringwrapper.
   @constructor

   @class the Stringwrapper class. This base class is not really
   useful on its own; it just wraps various common string operations.
*/
function Stringwrapper() {
  /**
     Wrapper for this.toString().indexOf()
     @param {String} x
     @type integer
  */
  this.indexOf=function(x){return this.toString().indexOf(x);};
  /**
     Returns this.value.
     @type String
   */
     this.toString=function(){return this.value;};
  /**
     Wrapper for {@link String#parenSplit} applied to this.toString()
     @param {RegExp} x
     @type Array
  */
  this.parenSplit=function(x){return this.toString().parenSplit(x);};
  /**
     Wrapper for this.toString().substring()
     @param {String} x
     @param {String} y (optional)
     @type String
  */
  this.substring=function(x,y){
	if (typeof y=='undefined') { return this.toString().substring(x); }
	return this.toString().substring(x,y);
  };
  /**
     Wrapper for this.toString().split()
     @param {String} x
     @type Array
  */
  this.split=function(x){return this.toString().split(x);};
  /**
     Wrapper for this.toString().replace()
     @param {String} x
     @param {String} y
     @type String
  */
  this.replace=function(x,y){ return this.toString().replace(x,y); };
}


/**
   Creates a new &lt;code&gt;Title&lt;/code&gt;.
   @constructor

   @class The Title class. Holds article titles and converts them into
   various forms. Also deals with anchors, by which we mean the bits
   of the article URL after a # character, representing locations
   within an article.

   @param {String} value The initial value to assign to the
   article. This must be the canonical title (see {@link
   Title#value}. Omit this in the constructor and use another function
   to set the title if this is unavailable.
*/
function Title(val) {
  /**
     The canonical article title. This must be in UTF-8 with no
     entities, escaping or nasties. Also, underscores should be
     replaced with spaces.
     @type String
     @private
  */
  this.value=null;
  this.setUtf(val);
  /**
     The canonical form of the anchor. This should by decoded utf-8 text.
     @type String
  */
  this.anchor='';
}
Title.prototype=new Stringwrapper();
/**
   Returns the canonical representation of the article title with anchor.
   @fixme Decide specs for anchor
   @return String The article title and the anchor.
*/
Title.prototype.toString=function() {
  return this.value + ( this.anchor ? '#' + this.anchor : '' );
};
Title.urlAnchor=function() {
  // FIXME FIXME FIXME
  return this.anchor;
}
Title.fromURL=function(h) {
  return new Title().fromURL(h);
};
Title.prototype.fromURL=function(h) {
  if (typeof h != 'string') {
    this.value=null;
    return this;
  }

  // NOTE : playing with decodeURI, encodeURI, escape, unescape,
  // we seem to be able to replicate the IE borked encoding

  // IE doesn't do this new-fangled utf-8 thing.
  // and it's worse than that.
  // IE seems to treat the query string differently to the rest of the url
  // the query is treated as bona-fide utf8, but the first bit of the url is pissed around with

  // we fix up &amp; for all browsers, just in case.
  var splitted=h.split('?');
  splitted[0]=splitted[0].split('&amp;').join('%26');

  if (pg.flag.linksLikeIE) {
    splitted[0]=encodeURI(decode_utf8(splitted[0]));
  }

  h=splitted.join('?');

  var contribs=pg.re.contribs.exec(h);
  if (contribs !== null) {
    this.value = this.decodeNasties(pg.ns.user + ':' + contribs[3]);
    return this;
  }

  var email=pg.re.email.exec(h);
  if (email !== null) {
    this.value=this.decodeNasties(pg.ns.user + ':' + email[3]);
    return this;
  }

  // no more special cases to check --
  // hopefully it's not a disguised user-related page
  var m=pg.re.main.exec(h);
  if(m===null) { this.value=null; }
  else { this.value=this.decodeNasties(m[2]); }
  return this;
};
Title.prototype.decodeNasties=function(txt) {
  return this.decodeEscapes(decodeURI(txt));
}
Title.prototype.decodeEscapes=function(txt) {
  var split=txt.parenSplit(/([%][0-9A-Fa-f]{2})/);
  var len=split.length;
  for (var i=1; i&lt;len; i=i+2) {
    split[i]=unescape(split[i]);
  }
  return split.join('');
};
Title.fromAnchor=function(a) {
  return new Title().fromAnchor(a);
};
Title.prototype.fromAnchor=function(a) {
  if (!a) { this.value=null; return this; }
  return this.fromURL(a.href);
};
Title.prototype.fromWikiText=function(txt) {
  // FIXME!!!
  if (!pg.flag.linksLikeIE) { txt=myDecodeURI(txt); }
  this.value=txt;
  return this;
};
Title.prototype.hintValue=function(){
  if(!this.value) { return ''; }
  return safeDecodeURI(this.value);
};
Title.prototype.toUserName=function(withNs) {
  //limitAlert(Title.prototype.toUserName, 4, 'toUserName'+'\nwithNs='+withNs+'\nthis.value='+this.value);
  if (!this.value) { return null; }
  var i=this.value.indexOf(pg.ns.user);
  var j=this.value.indexOf(':');
  if  (i !== 0 || j == -1) {
    this.value=null;
    return null;
  }
  var k=this.value.indexOf('/');
  if (k==-1) { this.value=this.value.substring(j+1); }
  else { this.value=this.value.substring(j+1,k); }
  if (withNs) { this.value = pg.ns.user + ':' + this.value; }
  //limitAlert(Title.prototype.toUserName, 4,'end of toUserName'+'\nwithNs='+withNs+'\nthis.value='+this.value);
  return this.value;
};
Title.prototype.userName=function(withNs) {
  var t=(new Title(this.value));
  t.toUserName(withNs);
  if (t.value) { return t; }
  return null;
};
Title.prototype.toTalkPage=function() {
  // convert article to a talk page, or if we can't return null
  // or, in other words, return null if this ALREADY IS a talk page
  // and return the corresponding talk page otherwise
  if (this.value===null) { return null; }
  var talkRegex=namespaceListToRegex(pg.ns.talkList);
  if (talkRegex.exec(this.value)) { this.value=null; return null;}

  var nsRegex=namespaceListToRegex(pg.ns.withTalkList);
  var splitted=this.value.parenSplit(nsRegex);
  if (splitted.length&lt;2) {
    this.value= (pg.ns.talkList[0]+':'+this.value).split(' ').join('_');
    return this.value;
  }
  for (var i=0; i&lt; pg.ns.withTalkList.length; ++i) {
    if (splitted[1]==pg.ns.withTalkList[i]) {
      splitted[1]=pg.ns.talkList[i];
      this.value=splitted.join(':').substring(1).split(' ').join('_');
      return this.value;
    }
  }
  this.value=null;
  return null;
};
Title.prototype.talkPage=function() {
  var t=new Title(this.value);
  t.toTalkPage();
  if (t.value) { return t; }
  return null;
};
Title.prototype.isTalkPage=function() {
  if (this.talkPage()===null) { return true; }
  return false;
};
Title.prototype.toArticleFromTalkPage=function() {
  var talkRegex=namespaceListToRegex(pg.ns.talkList);
  var splitted=this.value.parenSplit(talkRegex);
  if (splitted.length &lt; 2 || splitted[0].length &gt; 0) { this.value=null; return null; }
  if (splitted[1]==pg.ns.talkList[0]) {
    splitted[1]='';
    this.value=splitted.join(':').substring(2).split(' ').join('_');
    return this.value;
  }
  for (var i=1; i&lt; pg.ns.talkList.length; ++i) {
    if (splitted[1]==pg.ns.talkList[i]
	|| splitted[1]==pg.ns.talkList[i].split(' ').join('_')) {
      splitted[1]=pg.ns.withTalkList[i];
      this.value= splitted.join(':').substring(1).split(' ').join('_');
      return this.value;
    }
  }
  this.value=null;
  return this.value;
};
Title.prototype.articleFromTalkPage=function() {
  var t=new Title(this.value);
  t.toArticleFromTalkPage();
  if (t.value) { return t; }
  return null;
};
Title.prototype.articleFromTalkOrArticle=function() {
  var t=new Title(this.value);
  if ( t.toArticleFromTalkPage() ) { return t; }
  return this;
};
Title.prototype.stripNamespace=function(){ // returns a string, not a Title
  // this isn't very sophisticated
  // it just removes everything up to the final :
  // BUG: probably does silly things for images with colons in the name - check it out
  var list = this.value.split(':');
  return list[list.length-1];
};
Title.prototype.setUtf=function(value){
  if (!value) { this.value=''; return; }
  var anch=value.indexOf('#');
  if(anch &lt; 0) { this.value=value; this.anchor=''; return; }
  this.value=value.substring(0,anch);
  this.anchor=value.substring(anch+1);
  this.ns=null; // wait until namespace() is called
};
Title.prototype.namespace=function() {
  // FIXME
};
Title.prototype.setUrl=function(urlfrag) {
  var anch=urlfrag.indexOf('#');
  this.value=safeDecodeURI(urlfrag.substring(0,anch));
  this.anchor=value.substring(anch+1);
};
Title.prototype.append=function(x){
  this.setUtf(this.value + x);
};
Title.prototype.isIpUser=function() {
  return pg.re.ipUser.test(this.userName());
};
Title.prototype.urlString=function() {
  return encodeURI(this.value).split('&amp;').join('%26').split('?').join('%3F').split('+').join('%2B');
}


function paramValue(param, url) {
  var s=url.parenSplit(RegExp('[?&amp;]' + literalizeRegex(param) + '=([^?&amp;]*)'));
  if (!url) { return null; }
  return s[1] || null;
}

// all sorts of stuff here
// almost everything needs to be rewritten

function oldidFromAnchor(a) { return paramValue('oldid', a.href); }
function diffFromAnchor(a) { return paramValue('diff', a.href); }

function stripNamespace(article) {
  // FIXME used in images.js.... extend Title class to Image class?

  // this isn't very sophisticated
  // it just removes everything up to the final :
  // BUG: probably does silly things for images with colons in the name - check it out
  var list = article.split(':');
  return list[list.length-1];
}

// (a) myDecodeURI (first standard decodeURI, then pg.re.urlNoPopup)
// (b) change spaces to underscores
// (c) encodeURI (just the straight one, no pg.re.urlNoPopup)

function wikiMarkupToAddressFragment (str) { // for images
  var ret = safeDecodeURI(str);
  ret = ret.split(' ').join('_');
  ret = encodeURI(ret);
  return ret;
}

function myDecodeURI (str) {
  var ret;
  try { ret=decodeURI(str.toString()); }
  catch (summat) { return str; }
  for (var i=0; i&lt;pg.misc.decodeExtras.length; ++i) {
    var from=pg.misc.decodeExtras[i].from;
    var to=pg.misc.decodeExtras[i].to;
    ret=ret.split(from).join(to);
  }
  return ret;
}

function safeDecodeURI(str) { var ret=myDecodeURI(str); return ret || str; }

function myEncodeURI (str) {
  log ('myEncodeURI: str='+str);
  var ret=str;
  ret=encodeURI(ret);
  for (var i=0; i&lt;pg.misc.decodeExtras.length; ++i) {
    var from=pg.misc.decodeExtras[i].from;
    var to=pg.misc.decodeExtras[i].to;
    ret=ret.split(to).join(from);
  }
  return ret;
}

function Titleanchor() {
  // FIXME
  this.fromEncoded=function(str) {
    // FIXME probably incorrect!
    this.encoded=str;
    this.value=unesape(str.replace(RegExp('[.]([0-9A-F][0-9A-F])', 'g'), '%$1'));
  };
  this.getEncoded=function(str) {
    if (this.encoded) {
      return this.encoded;
    }
    // FIXME
    return 'Not yet implemented';
  };
  this.setUTF=function(str) {
    this.value=str;
    this.encoded=this.getEncoded();
  };
}
Titleanchor.prototype=new Stringwrapper();

function removeAnchor(article) {
  if (!article) { return null; }
  // is there a #? if not, we're done
  var i=article.indexOf('#');
  if (i == -1) { return article; }
  return article.substring(0,i);
}
function getAnchor(article) {
  if(!article) { return null; }
  var i=article.indexOf('#');
  if (i == -1) { return ''; }
  return article.substring(i+1);
}
function decodeAnchor(article) {
  var anch=getAnchor(article);
  if(!anch) { return ''; }
  anch=anch.replace(RegExp('[.]([0-9A-F][0-9A-F])', 'g'), '%$1');
  return unescape(anch);
}

///////////
// TESTS //
///////////

function isIpUser(user) {return pg.re.ipUser.test(user);}

function isStub(data) { return pg.re.stub.test(data); }
function isDisambig(data) {
  return ! pg.current.article.isTalkPage() &amp;&amp; pg.re.disambig.test(data);
}

function isValidImageName(str){ // extend as needed...
  return ( str.indexOf('{') == -1 );
}

function isInNamespaceOrTalk(article, namespace) {
  if (!article) { return false; }
  if (isInNamespace(article, namespace)) { return true; }
  // FIXME: internationalize this
  if  (article.indexOf(namespace+'_talk:') === 0) { return true; }
  return false;
};

function isInNamespace(article, namespace) {
  if (!article) { return false; }
  var list=namespace;
  if (typeof list == typeof '') list=[list];
  for (var i=0; i&lt;list.length; ++i) {
    if (article.indexOf(list[i]+':')===0) { return true; }
    // should also respect namespaces encoded with wikiMarkupToAddressFragment
    if (article.indexOf(wikiMarkupToAddressFragment(list[i]+':'))===0) { return true; }
  }
  return false;
};

function isInStrippableNamespace(article) {
  return isInNamespace(article, pg.ns.nonArticleList);
};
function isInMainNamespace(article) {
  return !isInStrippableNamespace(article);
}

function isImage(thing)     {return isInNamespaceOrTalk(thing, pg.ns.image);};
function isImagePage(thing) {return isInNamespace      (thing, pg.ns.image);};

function anchorContainsImage(a) {
  // iterate over children of anchor a
  // see if any are images
  if (a===null) { return false; }
  kids=a.childNodes;
  for (var i=0; i&lt;kids.length; ++i) { if (kids[i].nodeName=='IMG') { return true; } }
  return false;
};

function isPopupLink(a) {
  // NB for performance reasons, TOC links generally return true
  // they should be stripped out later

  // FIXME is this faster inline?
  if (a.onclick) { return false; }
  var h=a.href;
  return (
	  ( (
	     ( h.indexOf(pg.wiki.titlebase) === 0 || h.indexOf(pg.wiki.wikibase) === 0 )
	     &amp;&amp; !pg.re.urlNoPopup.test(h))
	    ||
	    (pg.re.contribs.test(h) &amp;&amp; h.indexOf('&amp;limit=') == -1 )
	    )
	  );
}

// ENDFILE: titles.js
// STARTFILE: cookies.js
//////////////////////////////////////////////////
// Cookie handling
// from http://www.quirksmode.org/js/cookies.html

var Cookie= {
  create: function(name,value,days)
  {
    var expires;
    if (days)
    {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      expires = &quot;; expires=&quot;+date.toGMTString();
    }
    else { expires = &quot;&quot;; }
    document.cookie = name+&quot;=&quot;+value+expires+&quot;; path=/&quot;;
  },

  read: function(name)
  {
    var nameEQ = name + &quot;=&quot;;
    var ca = document.cookie.split(';');
    for(var i=0;i &lt; ca.length;i++)
    {
      var c = ca[i];
      while (c.charAt(0)==' ') { c = c.substring(1,c.length); }
      if (c.indexOf(nameEQ) === 0) { return c.substring(nameEQ.length,c.length); }
    }
    return null;
  },

  erase: function(name)
  {
    Cookie.create(name,&quot;&quot;,-1);
  }
};

// ENDFILE: cookies.js
// STARTFILE: getpage.js
//////////////////////////////////////////////////
// Wiki-specific downloading
//

// Schematic for a getWiki call
//
//   getWiki-&gt;-getPageWithCaching
//                    |
//       false        |          true
// getPage&lt;-[findPictureInCache]-&gt;-onComplete(a fake download)
//   \.
//     (async)-&gt;addPageToCache(download)-&gt;-onComplete(download)

function getWiki(article, onComplete, oldid, owner) {
  // NB wikipage is a Title object
  log('getWiki, article='+article);
  var wikipage=article.urlString();
  // set ctype=text/css to get around opera bug
  var url = pg.wiki.titlebase + removeAnchor(wikipage) + '&amp;action=raw&amp;ctype=text/css';
  if (oldid || oldid===0 || oldid==='0') { url += '&amp;oldid='+oldid; }
  else { url += '&amp;maxage=0&amp;smaxage=0'; }

  getPageWithCaching(url, onComplete, owner);
};

// check cache to see if page exists

function getPageWithCaching(url, onComplete, owner) {
  log('getPageWithCaching, url='+url);
  var i=findInPageCache(url);
  if (i &gt; -1) return fakeDownload(url, pg.idNumber, onComplete, pg.cache.pages[i].data, pg.cache.pages[i].lastModified);
  var d=getPage(url, onComplete, owner);
  if (d &amp;&amp; owner &amp;&amp; owner.addDownload) {
    owner.addDownload(d);
    d.owner=owner;
  }
};

function getPage(url, onComplete, owner) {
  log('getPage');
  var callback= function (d) { if (!d.aborted) {addPageToCache(d); onComplete(d)} };
  return startDownload(url, pg.idNumber, callback);
};

function findInPageCache(url) {
  for (var i=0; i&lt;pg.cache.pages.length; ++i) if (url==pg.cache.pages[i].url) return i;
  return -1;
};

function addPageToCache(download) {
  log('addPageToCache '+download.url);
  var page = {url: download.url, data: download.data, lastModified: download.lastModified};
  return pg.cache.pages.push(page);
};

// ENDFILE: getpage.js
// STARTFILE: md5-2.2alpha.js
/*
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2-alpha Copyright (C) Paul Johnston 1999 - 2005
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

/*
 * Configurable variables. You may need to tweak these to be compatible with
 * the server-side, but the defaults work in most cases.
 */
var hexcase = 0;   /* hex output format. 0 - lowercase; 1 - uppercase        */
var b64pad  = &quot;&quot;; /* base-64 pad character. &quot;=&quot; for strict RFC compliance   */

/*
 * These are the functions you'll usually want to call
 * They take string arguments and return either hex or base-64 encoded strings
 */
function hex_md5(s)    { return rstr2hex(rstr_md5(str2rstr_utf8(s))); }
function b64_md5(s)    { return rstr2b64(rstr_md5(str2rstr_utf8(s))); }
function any_md5(s, e) { return rstr2any(rstr_md5(str2rstr_utf8(s)), e); }
function hex_hmac_md5(k, d)
  { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function b64_hmac_md5(k, d)
  { return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function any_hmac_md5(k, d, e)
  { return rstr2any(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d)), e); }

/*
 * Perform a simple self-test to see if the VM is working
 */
function md5_vm_test()
{
  return hex_md5(&quot;abc&quot;) == &quot;900150983cd24fb0d6963f7d28e17f72&quot;;
}

/*
 * Calculate the MD5 of a raw string
 */
function rstr_md5(s)
{
  return binl2rstr(binl_md5(rstr2binl(s), s.length * 8));
}

/*
 * Calculate the HMAC-MD5, of a key and some data (raw strings)
 */
function rstr_hmac_md5(key, data)
{
  var bkey = rstr2binl(key);
  if(bkey.length &gt; 16) bkey = binl_md5(bkey, key.length * 8);

  var ipad = Array(16), opad = Array(16);
  for(var i = 0; i &lt; 16; i++)
  {
    ipad[i] = bkey[i] ^ 0x36363636;
    opad[i] = bkey[i] ^ 0x5C5C5C5C;
  }

  var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
  return binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
}

/*
 * Convert a raw string to a hex string
 */
function rstr2hex(input)
{
  var hex_tab = hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;
  var output = &quot;&quot;;
  var x;
  for(var i = 0; i &lt; input.length; i++)
  {
    x = input.charCodeAt(i);
    output += hex_tab.charAt((x &gt;&gt;&gt; 4) &amp; 0x0F)
           +  hex_tab.charAt( x        &amp; 0x0F);
  }
  return output;
}

/*
 * Convert a raw string to a base-64 string
 */
function rstr2b64(input)
{
  var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;
  var output = &quot;&quot;;
  var len = input.length;
  for(var i = 0; i &lt; len; i += 3)
  {
    var triplet = (input.charCodeAt(i) &lt;&lt; 16)
                | (i + 1 &lt; len ? input.charCodeAt(i+1) &lt;&lt; 8 : 0)
                | (i + 2 &lt; len ? input.charCodeAt(i+2)      : 0);
    for(var j = 0; j &lt; 4; j++)
    {
      if(i * 8 + j * 6 &gt; input.length * 8) output += b64pad;
      else output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-j)) &amp; 0x3F);
    }
  }
  return output;
}

/*
 * Convert a raw string to an arbitrary string encoding
 */
function rstr2any(input, encoding)
{
  var divisor = encoding.length;
  var remainders = Array();
  var i, q, x, quotient;

  /* Convert to an array of 16-bit big-endian values, forming the dividend */
  var dividend = Array(input.length / 2);
  for(i = 0; i &lt; dividend.length; i++)
  {
    dividend[i] = (input.charCodeAt(i * 2) &lt;&lt; 8) | input.charCodeAt(i * 2 + 1);
  }

  /*
   * Repeatedly perform a long division. The binary array forms the dividend,
   * the length of the encoding is the divisor. Once computed, the quotient
   * forms the dividend for the next step. We stop when the dividend is zero.
   * All remainders are stored for later use.
   */
  while(dividend.length &gt; 0)
  {
    quotient = Array();
    x = 0;
    for(i = 0; i &lt; dividend.length; i++)
    {
      x = (x &lt;&lt; 16) + dividend[i];
      q = Math.floor(x / divisor);
      x -= q * divisor;
      if(quotient.length &gt; 0 || q &gt; 0)
        quotient[quotient.length] = q;
    }
    remainders[remainders.length] = x;
    dividend = quotient;
  }

  /* Convert the remainders to the output string */
  var output = &quot;&quot;;
  for(i = remainders.length - 1; i &gt;= 0; i--)
    output += encoding.charAt(remainders[i]);

  return output;
}

/*
 * Encode a string as utf-8.
 * For efficiency, this assumes the input is valid utf-16.
 */
function str2rstr_utf8(input)
{
  var output = &quot;&quot;;
  var i = -1;
  var x, y;

  while(++i &lt; input.length)
  {
    /* Decode utf-16 surrogate pairs */
    x = input.charCodeAt(i);
    y = i + 1 &lt; input.length ? input.charCodeAt(i + 1) : 0;
    if(0xD800 &lt;= x &amp;&amp; x &lt;= 0xDBFF &amp;&amp; 0xDC00 &lt;= y &amp;&amp; y &lt;= 0xDFFF)
    {
      x = 0x10000 + ((x &amp; 0x03FF) &lt;&lt; 10) + (y &amp; 0x03FF);
      i++;
    }

    /* Encode output as utf-8 */
    if(x &lt;= 0x7F)
      output += String.fromCharCode(x);
    else if(x &lt;= 0x7FF)
      output += String.fromCharCode(0xC0 | ((x &gt;&gt;&gt; 6 ) &amp; 0x1F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0xFFFF)
      output += String.fromCharCode(0xE0 | ((x &gt;&gt;&gt; 12) &amp; 0x0F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0x1FFFFF)
      output += String.fromCharCode(0xF0 | ((x &gt;&gt;&gt; 18) &amp; 0x07),
                                    0x80 | ((x &gt;&gt;&gt; 12) &amp; 0x3F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
  }
  return output;
}

/*
 * Encode a string as utf-16
 */
function str2rstr_utf16le(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode( input.charCodeAt(i)        &amp; 0xFF,
                                  (input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF);
  return output;
}

function str2rstr_utf16be(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode((input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF,
                                   input.charCodeAt(i)        &amp; 0xFF);
  return output;
}

/*
 * Convert a raw string to an array of little-endian words
 * Characters &gt;255 have their high-byte silently ignored.
 */
function rstr2binl(input)
{
  var output = Array(input.length &gt;&gt; 2);
  for(var i = 0; i &lt; output.length; i++)
    output[i] = 0;
  for(var i = 0; i &lt; input.length * 8; i += 8)
    output[i&gt;&gt;5] |= (input.charCodeAt(i / 8) &amp; 0xFF) &lt;&lt; (i%32);
  return output;
}

/*
 * Convert an array of little-endian words to a string
 */
function binl2rstr(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length * 32; i += 8)
    output += String.fromCharCode((input[i&gt;&gt;5] &gt;&gt;&gt; (i % 32)) &amp; 0xFF);
  return output;
}

/*
 * Calculate the MD5 of an array of little-endian words, and a bit length.
 */
function binl_md5(x, len)
{
  /* append padding */
  x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((len) % 32);
  x[(((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14] = len;

  var a =  1732584193;
  var b = -271733879;
  var c = -1732584194;
  var d =  271733878;

  for(var i = 0; i &lt; x.length; i += 16)
  {
    var olda = a;
    var oldb = b;
    var oldc = c;
    var oldd = d;

    a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
    d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
    c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
    b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
    a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
    d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
    c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
    b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
    a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
    d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
    c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
    b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
    a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
    d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
    c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
    b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);

    a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
    d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
    c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
    b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
    a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
    d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
    c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
    b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
    a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
    d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
    c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
    b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
    a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
    d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
    c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
    b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);

    a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
    d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
    c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
    b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
    a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
    d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
    c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
    b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
    a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
    d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
    c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
    b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
    a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
    d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
    c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
    b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);

    a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
    d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
    c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
    b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
    a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
    d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
    c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
    b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
    a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
    d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
    c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
    b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
    a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
    d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
    c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
    b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);

    a = safe_add(a, olda);
    b = safe_add(b, oldb);
    c = safe_add(c, oldc);
    d = safe_add(d, oldd);
  }
  return Array(a, b, c, d);
}

/*
 * These functions implement the four basic operations the algorithm uses.
 */
function md5_cmn(q, a, b, x, s, t)
{
  return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b);
}
function md5_ff(a, b, c, d, x, s, t)
{
  return md5_cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);
}
function md5_gg(a, b, c, d, x, s, t)
{
  return md5_cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);
}
function md5_hh(a, b, c, d, x, s, t)
{
  return md5_cmn(b ^ c ^ d, a, b, x, s, t);
}
function md5_ii(a, b, c, d, x, s, t)
{
  return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
}

/*
 * Add integers, wrapping at 2^32. This uses 16-bit operations internally
 * to work around bugs in some JS interpreters.
 */
function safe_add(x, y)
{
  var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
  var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
  return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
}

/*
 * Bitwise rotate a 32-bit number to the left.
 */
function bit_rol(num, cnt)
{
  return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));
}
// ENDFILE: md5-2.2alpha.js
// STARTFILE: parensplit.js
//////////////////////////////////////////////////
// parenSplit

// String.prototype.parenSplit should do what ECMAscript says
// String.prototype.split does, interspersing paren matches between
// the split elements

if (String('abc'.split(/(b)/))!='a,b,c') {
  // broken String.split, e.g. konq, IE
  String.prototype.parenSplit=function (re) {
    re=nonGlobalRegex(re);
    var s=this;
    var m=re.exec(s);
    var ret=[];
    while (m &amp;&amp; s) {
      // without the following loop, we have
      // 'ab'.parenSplit(/a|(b)/) != 'ab'.split(/a|(b)/)
      for(var i=0; i&lt;m.length; ++i) {
	if (typeof m[i]=='undefined') m[i]='';
      }
      ret.push(s.substring(0,m.index));
      ret = ret.concat(m.slice(1));
      s=s.substring(m.index + m[0].length);
      m=re.exec(s);
    }
    ret.push(s);
    return ret;
  };
} else {
  String.prototype.parenSplit=function (re) {return this.split(re);};
}
function nonGlobalRegex(re) {
  var s=re.toString();
  flags='';
  for (var j=s.length; s.charAt(j) != '/'; --j) {
    if (s.charAt(j) != 'g') flags += s.charAt(j);
  }
  var t=s.substring(1,j);
  return RegExp(t,flags);
}

// ENDFILE: parensplit.js
// STARTFILE: tools.js
// IE madness with encoding
// ========================
//
// suppose throughout that the page is in utf8, like wikipedia
//
// if a is an anchor DOM element and a.href should consist of
//
// http://host.name.here/wiki/foo?bar=baz
//
// then IE gives foo as &quot;latin1-encoded&quot; utf8; we have foo = decode_utf8(decodeURI(foo_ie))
// but IE gives bar=baz correctly as plain utf8
//
// ---------------------------------
//
// IE's xmlhttp doesn't understand utf8 urls. Have to use encodeURI here.
//
// ---------------------------------
//
// summat else

// Source: http://aktuell.de.selfhtml.org/artikel/javascript/utf8b64/utf8.htm
function encode_utf8(rohtext) {
  // dient der Normalisierung des Zeilenumbruchs
  rohtext = rohtext.replace(/\r\n/g,&quot;\n&quot;);
  var utftext = &quot;&quot;;
  for(var n=0; n&lt;rohtext.length; n++)
    {
      // ermitteln des Unicodes des  aktuellen Zeichens
      var c=rohtext.charCodeAt(n);
      // alle Zeichen von 0-127 =&gt; 1byte
      if (c&lt;128)
	utftext += String.fromCharCode(c);
      // alle Zeichen von 127 bis 2047 =&gt; 2byte
      else if((c&gt;127) &amp;&amp; (c&lt;2048)) {
	utftext += String.fromCharCode((c&gt;&gt;6)|192);
	utftext += String.fromCharCode((c&amp;63)|128);}
      // alle Zeichen von 2048 bis 66536 =&gt; 3byte
      else {
	utftext += String.fromCharCode((c&gt;&gt;12)|224);
	utftext += String.fromCharCode(((c&gt;&gt;6)&amp;63)|128);
	utftext += String.fromCharCode((c&amp;63)|128);}
    }
  return utftext;
}

function decode_utf8(utftext) {
  var plaintext = &quot;&quot;; var i=0; var c=c1=c2=0;
  // while-Schleife, weil einige Zeichen uebersprungen werden
  while(i&lt;utftext.length)
    {
      c = utftext.charCodeAt(i);
      if (c&lt;128) {
	plaintext += String.fromCharCode(c);
	i++;}
      else if((c&gt;191) &amp;&amp; (c&lt;224)) {
	c2 = utftext.charCodeAt(i+1);
	plaintext += String.fromCharCode(((c&amp;31)&lt;&lt;6) | (c2&amp;63));
	i+=2;}
      else {
	c2 = utftext.charCodeAt(i+1); c3 = utftext.charCodeAt(i+2);
	plaintext += String.fromCharCode(((c&amp;15)&lt;&lt;12) | ((c2&amp;63)&lt;&lt;6) | (c3&amp;63));
	i+=3;}
    }
  return plaintext;
}


function upcaseFirst(str) {
  if (typeof str != typeof '' || str=='') return '';
  return str.charAt(0).toUpperCase() + str.substring(1);
};

pop.runOnce=function(f, time) {
  var i=pop.runOnce.timers.length;
  var ff = function () { clearInterval(pop.runOnce.timers[i]); f() };
  var timer=setInterval(ff, time);
  pop.runOnce.timers.push(timer);
}
pop.runOnce.timers=[];

function literalizeRegex(str){
  return str.replace(RegExp('([-.()\\+?*^${}\\[\\]])', 'g'), '\\$1');
}

// ENDFILE: tools.js
// STARTFILE: dab.js
//////////////////////////////////////////////////
// Dab-fixing code
//

function listLinks(wikitext, oldTarget) {
  var reg=RegExp('\\[\\[([^|]*?)(\\||\\]\\])', 'gi');
  var ret=[];
  var splitted=wikitext.parenSplit(reg);
  // ^[a-z]+ should match interwiki links, hopefully (case-insensitive)
  // and ^[a-z]* should match those and [[:Category...]] style links too
  var omitRegex=RegExp('^[a-z]*:|^[Ss]pecial:|^[Ii]mage|^[Cc]ategory');
  var friendlyCurrentArticleName=pg.current.article.split('_').join(' ');

  for (var i=1; i&lt;splitted.length; i=i+3) {
    if (typeof splitted[i] == typeof 'string' &amp;&amp; splitted[i].length&gt;0 &amp;&amp; !omitRegex.test(splitted[i])) {
      ret.push(changeLinkTargetLink({newTarget: splitted[i],
	       text: splitted[i].split(' ').join('&amp;nbsp;'),
	       hint: tprintf('disambigHint', [splitted[i]]),
	       summary: simplePrintf(getValueOf('popupFixDabsSummary'), [friendlyCurrentArticleName, splitted[i] ]),
	       clickButton: 'wpDiff', minor: true, oldTarget: oldTarget, watch: getValueOf('popupWatchDisambiggedPages')
	       }));
    } /* if */
  } /* for loop */

  ret = rmDupesFromSortedList(ret.sort());

  ret.push(changeLinkTargetLink({ newTarget: null,
				  text: popupString('remove this link').split(' ').join('&amp;nbsp;'),
				  hint: popupString(&quot;remove all links to this disambig page from this article&quot;),
				  clickButton: &quot;wpDiff&quot;, oldTarget: oldTarget,
				  summary: simplePrintf(getValueOf('popupRmDabLinkSummary'), [friendlyCurrentArticleName]),
				  watch: getValueOf('popupWatchDisambiggedPages')}));
  return ret;

}

function rmDupesFromSortedList(list) {
  var ret=[];
  for (var i=0; i&lt;list.length; ++i) {
    if (ret.length===0 || list[i]!=ret[ret.length-1]) { ret.push(list[i]); }
  }
  return ret;
}

function makeFixDab(data, oldTarget) {
  var list=listLinks(data, oldTarget);
  if (list.length===0) { return null; }
  var html='&lt;hr&gt;' + popupString('Click to disambiguate this link to:') + '&lt;br&gt;';
  html+=list[0];
  for (var i=1; i&lt;list.length; ++i) { html += ', '+list[i]; }
  return html;
}


function makeFixDabs(wikiText, oldTarget)
{
  if (getValueOf('popupFixDabs') &amp;&amp; isDisambig(wikiText) &amp;&amp;
      location.href.indexOf(pg.ns.special+':') == -1 &amp;&amp;
      pg.current.article.talkPage() ) {
    setPopupHTML(makeFixDab(wikiText, oldTarget), 'popupFixDab', pg.idNumber);
  }
}

// ENDFILE: dab.js
// STARTFILE: htmloutput.js
// this has to use a timer loop as we don't know if the DOM element exists when we want to set the text
function setPopupHTML (str, elementId, popupId, onSuccess) {
  //log('setPopupHTML, str='+str.substring(0,100)+'..., \n elementId='+elementId+', popupId='+popupId);
  if (typeof popupId === 'undefined') popupId = pg.idNumber;
  var popupElement=document.getElementById(elementId+popupId);
  var timer;

  if (typeof pg.timer.popupHTML[elementId] == 'undefined') timer=null;
  else timer=pg.timer.popupHTML[elementId];

  if (popupElement != null) {
    if(timer) clearInterval(timer);
    pg.timer.popupHTML[elementId]=null;
    popupElement.innerHTML=str;
    if (onSuccess) onSuccess();
    return true;
  } else {
    // call this function again in a little while...
    var loopFunction=function() { setPopupHTML(str,elementId,popupId,onSuccess);}
    pg.misc.popupHTMLLoopFunctions[elementId] = loopFunction;
    if (!timer) {
      var doThis = 'pg.misc.popupHTMLLoopFunctions[&quot;'+elementId+'&quot;]()';
      pg.timer.popupHTML[elementId] = setInterval(doThis, 600);
    }
  }
  return null;
}

function setImageStatus(str, id) {return; } // setPopupHTML(str, 'popupImageStatus', id);};
function setPopupTrailer(str,id) {return setPopupHTML(str, 'popupData', id);};


function fillEmptySpans(args) { return fillEmptySpans2(args); }

function fillEmptySpans2(args) { // if redir is present and true then redirTarget is mandatory
  var redir=true;
  if (typeof args != 'object' || typeof args.redir == 'undefined' || !args.redir) redir=false;
  var a=pg.current.link;
  //log('fillEmptySpans: a='+a+', pg.current.link='+pg.current.link);
  if (!a) { log('*****\nfillEmptySpans: a is no good\n*****'); return; }

  var article, hint, oldid;
  if (redir &amp;&amp; typeof args.redirTarget == typeof {}) {
    article=args.redirTarget; hint=null;
  } else {
    article=(new Title()).fromAnchor(a);
    hint=a.originalTitle || article.hintValue();
    oldid=(getValueOf('popupHistoricalLinks')) ? oldidFromAnchor(a) : null;
  }
  //limitAlert(fillEmptySpans2, 4, 'fillEmptySpans2\n' + article+'\n'+(typeof article));
  var x={ article:article,
          hint: hint, oldid: oldid };

  //log('fillEmptySpans: redir='+redir+', article='+article);

  var structure=pg.structures[getValueOf('popupStructure')];
  if (typeof structure != 'object') {
    setPopupHTML('popupError', 'Unknown structure (this should never happen): '+ popupStructure);
    return;
  }
  var spans=flatten(pg.misc.layout);
  var numspans = spans.length;
  var redirs=pg.misc.redirSpans;
  //log('fillEmptySpans: spans.length='+spans.length);

  for (var i=0; i&lt;numspans; ++i) {
    var f=findThis(redirs, spans[i]);
    //log('redir='+redir+', f='+f+', spans[i]='+spans[i]);
    if ( (f!=null &amp;&amp; !redir) || (f==null &amp;&amp; redir) ) {
      //log('skipping this set of the loop');
      continue;
    }
    var structurefn=structure[spans[i]];
    switch (typeof structurefn) {
    case 'function':
      //log('running '+spans[i]+'({article:'+x.article+', hint:'+x.hint+', oldid: '+x.oldid+'})');
      setPopupHTML(structurefn(x), spans[i]);
      break;
    case 'string':
      setPopupHTML(structurefn, spans[i]);
      break;
    default:
      errlog('unknown thing with label '+spans[i]);
      break;
    }
  }
}

// flatten an array
function flatten(list, start) {
  var ret=[];
  if (typeof start == 'undefined') start=0;
  for (var i=start; i&lt;list.length; ++i) {
    if (typeof list[i] == typeof []) {
      return ret.concat(flatten(list[i])).concat(flatten(list, i+1));
    }
    else ret.push(list[i]);
  }
  return ret;
};

// Generate html for whole popup
function popupHTML (a) {
  getValueOf('popupStructure');
  var structure=pg.structures[pg.option.popupStructure];
  if (typeof structure != 'object') return 'Unknown structure: '+popupStructure +
                                      ( RegExp('^[\'&quot;]').test(popupStructure) ? '&lt;p&gt;There has been a breaking change - please do not&lt;br&gt;' +
                                        ' quote strings in options like popupStructure twice any longer&lt;br&gt; in your user javascript file.' : '');
  if (typeof structure.popupLayout != 'function') return 'Bad layout';
  pg.misc.layout=structure.popupLayout();
  if (typeof structure.popupRedirSpans == 'function') pg.misc.redirSpans=structure.popupRedirSpans();
  else pg.misc.redirSpans=[];
  return makeEmptySpans(pg.misc.layout);
};

function makeEmptySpans (list) {
  var ret='';
  for (var i=0; i&lt;list.length; ++i) {
    if (typeof list[i] == typeof '') {
      ret += emptySpanHTML(list[i], pg.idNumber);
    } else if (typeof list[i] == typeof [] &amp;&amp; list[i].length &gt; 0 ) {
      ret = ret.parenSplit(RegExp('(&lt;/[^&gt;]*?&gt;$)')).join(makeEmptySpans(list[i]));
    } else if (typeof list[i] == typeof {} &amp;&amp; list[i].nodeType ) {
      ret += emptySpanHTML(list[i].name, pg.idNumber, list[i].nodeType);
    }
  }
  return ret;
};

function popupRedlinkHTML() {
  var friendlyCurrentArticleName=pg.current.article.split('_').join(' ');

  return changeLinkTargetLink({ newTarget: null,
        text: popupString('remove this link').split(' ').join('&amp;nbsp;'),
        hint: popupString(&quot;remove all links to this page from this article&quot;),
        clickButton: &quot;wpDiff&quot;,
                                               //oldTarget: oldTarget,
        summary: simplePrintf(getValueOf('popupRedlinkSummary'), [friendlyCurrentArticleName])});
}

function emptySpanHTML(name, id, tag, classname) {
  tag = tag || 'span';
  classname = classname || name;
  return simplePrintf('&lt;%s id=&quot;%s&quot; class=&quot;%s&quot;&gt;&lt;/%s&gt;', [tag, name + id, classname, tag]);
}

// generate html for popup image
// &lt;a id=&quot;popupImageLinkn&quot;&gt;&lt;img id=&quot;popupImagen&quot;&gt;
// where n=pg.idNumber
function imageHTML(article) {
  var ret='';
  ret += '&lt;a id=&quot;popupImageLink' + pg.idNumber + '&quot;&gt;';
  ret += '&lt;img align=&quot;right&quot; valign=&quot;top&quot; id=&quot;popupImg' + pg.idNumber + '&quot; '
    + 'style=&quot;display: none;&quot;&gt;&lt;/img&gt;';
  ret += '&lt;/a&gt;';
  return ret;
};

// ENDFILE: htmloutput.js
// STARTFILE: mouseout.js
//////////////////////////////////////////////////
// fuzzy checks

function fuzzyCursorOffMenus(x,y, fuzz, parent) {
  if (!parent) parent=over;
  if (!parent) return null;
  var spans=parent.getElementsByTagName('span');
  for (var i=0; i&lt;spans.length; ++i) {
    if (spans[i].className=='popup_menu') {
      if (spans[i].offsetWidth &gt; 0) return false;
    } // else {document.title+='.';}
  }
  return true;
};

function checkPopupPosition () { // stop the popup running off the right of the screen
  pg.current.link.navpopup.limitHorizontalPosition();
};


function findPosX(obj)
{
    var curleft = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curleft += obj.offsetLeft
            obj = obj.offsetParent;
        }
    }
    else if (obj.x)
        curleft += obj.x;
    return curleft;
}

function findPosY(obj)
{
    var curtop = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curtop += obj.offsetTop
            obj = obj.offsetParent;
        }
    }
    else if (obj.y)
        curtop += obj.y;
    return curtop;
}

function mouseOutWikiLink () {
  log ('mouseOutWikiLink');
  var a=this;
  if (a.navpopup==null) return;
  if ( ! a.navpopup.isVisible() ) {
    a.navpopup.banish();
    return;
  }
  Navpopup.tracker.addHook(posCheckerHook(a.navpopup));
}

function posCheckerHook(navpop) {
  return function() {
    //~ if the navpopup isn't visible, or if it is and should stop
    //~ being...
    if (
        !navpop.isVisible() ||
        (!navpop.isWithin(Navpopup.tracker.x, Navpopup.tracker.y)
         &amp;&amp; fuzzyCursorOffMenus(Navpopup.tracker.x, Navpopup.tracker.y, navpop.fuzz, navpop.mainDiv))
        ) {
          //~ stop it being visible or appearing from a @tt{showSoon} call
          log('calling banish() from tracker hook function');
          navpop.banish();
          return true; // remove this hook
        }
    // return true; // remove this immediately
  };
}

function runStopPopupTimer(navpop) {
  // at this point, we should have left the link but remain within the popup
  // so we call this function again until we leave the popup.
  if (!navpop.stopPopupTimer) {
    navpop.stopPopupTimer=setInterval(posCheckerHook(navpop), 500);
    navpop.addHook(function(){clearInterval(navpop.stopPopupTimer);}, 'hide', 'before');
  }
}

// ENDFILE: mouseout.js
// STARTFILE: previewmaker.js
/**
   @fileoverview
   Defines the {@link Previewmaker} object, which generates short previews from wiki markup.
*/

/**
   Creates a new Previewmaker
   @constructor
   @class The Previewmaker class. Use an instance of this to generate short previews from Wikitext.
   @param {String} wikiText The Wikitext source of the page we wish to preview.
*/
function Previewmaker(wikiText) {
  /** The wikitext which is manipulated to generate the preview. */
  this.data=wikiText;
}
/** Remove HTML comments
    @private
 */
Previewmaker.prototype.killComments = function () {
  // this also kills trailing spaces and one trailing newline, eg [[diamyo]]
  this.data=this.data.replace(RegExp('&lt;!--(\\n|.)*?--&gt; *\\n?', 'g'), '');
}
/**
    @private
 */
Previewmaker.prototype.killDivs=function () {
  // say goodbye, divs (can be nested, so use * not *?)
  this.data=this.data.replace(RegExp('&lt; *div[^&gt;]* *&gt;[\\s\\S]*?&lt; */ *div *&gt;',
			   'gi'), '');
}
/**
    @private
 */
Previewmaker.prototype.killGalleries=function () {
  this.data=this.data.replace(RegExp('&lt; *gallery[^&gt;]* *&gt;[\\s\\S]*?&lt; */ *gallery *&gt;',
			   'gi'), '');
}
/**
    @private
 */
Previewmaker.prototype.killBoxTemplates=function () {
  // taxobox hack... in fact, there's a saudiprincebox_begin, so let's be more general
  this.data=this.data.replace(RegExp('[{][{][^}\\s|]*box[ _](begin|start)' +
			   '[\\s\\S]*?[^{\\s|]*box[ _](end|finish) *[}][}]\\s', 'gi'), '');

  // infoboxes etc
  // this should cope with templates in infoboxes, but only nested once
  this.data=this.data.replace(RegExp('[{][{][^}|]*(info|element)box[ _]' +
				     '\([^{]\|[\\s]\|[{][{][\\s\\S]*?[}][}]\)*?[}][}]\\s*',
				     'gi'), '');

  // also, have float_begin, ... float_end
  this.data=this.data.replace(RegExp('[{][{][^}\\s|]*float[ _]begin' +
			   '[\\s\\S]*?[^{\\s|]*float[ _]end.*?[}][}]',
			   'gi'), '');

  // from [[User:Zyxw/popups.js]]: kill frames too
  this.data=this.data.replace(RegExp('[{][{][^}\\s|]*[_ ]frame' +
				     '[\\s\\S]*?[^{\\s|]*[_ ]?end[_ ]+frame[}][}]', 'gi'), '');
}
/**
    @private
 */
Previewmaker.prototype.killTemplates = function () {
  this.data=this.data.replace(RegExp('[{][{]([{][{][^}]*[}][}]|[^{}])*[}][}]', 'g'), ' ');
}
/**
    @private
 */
Previewmaker.prototype.killTables=function () {
  // tables are bad, too
  this.data=this.data.replace
  (RegExp('[{]\\|([{][|]([^\\|]|\\|[^}]|[|][}][}])*[|][}]|[^\\|]|\\|[^}]|\\|[}][}])*\\|[}]', 'g')
   , '');
  // remove lines starting with a pipe
  this.data=this.data.replace(RegExp('^[|].*$', 'mg'), '');
}
/**
    @private
 */
Previewmaker.prototype.killImages=function () {
  // images are a nono
  // who says regexes aren't fun?
  // i think we should match:
  // [[image: ...... ]] where ....... consists of repetitions of any of:
  // 1. not [ or ]
  // 2. [[ (not ])* ]]
  // 3. [ (not ])* ]
  var imagedetector =
  '[[][[]\\s*('+
    pg.ns.image + '|' + pg.ns.category+
  ')\\s*:([^\\[\\]]|\\[\\[[^\\]]*\\]\\]|\\[[^\\]]*\\])*\\]\\]\\s*';
  var crudeImageRegex = RegExp(imagedetector, 'gi');
  this.data=this.data.replace(crudeImageRegex, '');
}
/**
    @private
 */
Previewmaker.prototype.killHTML=function () {
  // kill &lt;ref&gt;...&lt;/ref&gt;
  this.data=this.data.replace(RegExp('&lt;ref&gt;[\\s\\S]*?&lt;/ref&gt;', 'gi'), '');

  // kill html tables // this doesn't cope with embedded tables
  // may this is good enough?
  this.data=this.data.replace(RegExp('&lt;table.*?&gt;[\\s\\S]*?&lt;/\\s*table\\s*&gt;\\n+', 'gi'), '');

  // let's also delete entire lines starting with &lt;. it's worth a try.
  this.data=this.data.replace(RegExp('(^|\\n) *&lt;.*', 'g'), '\n');

  // and those pesky html tags, but not &lt;nowiki&gt;
  var splitted=this.data.parenSplit(/(&lt;.*?&gt;)/);
  var len=splitted.length;
  for (var i=1; i&lt;len; i=i+2) {
    switch (splitted[i]) {
    case '&lt;nowiki&gt;':
    case '&lt;/nowiki&gt;':
      break;
    default:
      splitted[i]='';
    }
  }
  this.data=splitted.join('');
}
/**
    @private
 */
Previewmaker.prototype.killChunks=function() { // heuristics alert
  // chunks of italic text? you crazy, man?
  var italicChunkRegex=new RegExp
    (&quot;((^|\\n)\\s*:*\\s*''[^']([^']|'''|'[^']){20}(.|\\n[^\\n])*''[.!?\\s]*\\n)*&quot;, 'g');
  this.data=this.data.replace(italicChunkRegex, '');
}
/**
    @private
 */
Previewmaker.prototype.mopup=function () {
  // we simply *can't* be doing with horizontal rules right now
  this.data=this.data.replace(RegExp('^-{4,}','mg'),'');

  // no indented lines
  this.data=this.data.replace(RegExp('(^|\\n) *:[^\\n]*','g'), '\n');

  // replace __TOC__, __NOTOC__ and whatever else there is
  // this'll probably do
  this.data=this.data.replace(RegExp('^__[A-Z_]*__ *$', 'gmi'),'');
}
/**
    @private
 */
Previewmaker.prototype.firstBit=function () {
  // dont't be givin' me no subsequent paragraphs, you hear me?
  /// first we &quot;normalize&quot; section headings, removing whitespace after, adding before

  this.data=this.data.replace(RegExp('\\s*(==+[^=]*==+)\\s*', 'g'), '\n\n$1 ');

  /// then we want to get rid of paragraph breaks whose text ends badly
  this.data=this.data.replace(RegExp('([:;]) *\\n{2,}', 'g'), '$1\n');

  this.data=this.data.replace(RegExp('^[\\s\\n]*'), '');
  stuff=(RegExp('^([^\\n]|\\n[^\\n\\s])*')).exec(this.data);
  var d;
  if (stuff) d = stuff[0];
  if (!getValueOf('popupPreviewFirstParOnly')) d = this.data;

  /// now put \n\n after sections so that bullets and numbered lists work
  d=d.replace(RegExp('(==+[^=]*==+)\\s*', 'g'), '$1\n\n');

  // superfluous sentences are RIGHT OUT.
  // note: exactly 1 set of parens here needed to make the slice work
  d = d.parenSplit(RegExp('([!?.]+[&quot;'+&quot;'&quot;+']*\\s)','g'));
  // leading space is bad, mmkay?
  d[0]=d[0].replace(RegExp('^\\s*'), '');

  var notSentenceEnds=RegExp('([^.][a-z][.][a-z]|etc|sic|Dr|Mr|Mrs|Ms|St|\\[[^\\]]*|\\s[A-Zvclm])$', 'i');

  d = this.fixSentenceEnds(d, notSentenceEnds);

  var maxChars=getValueOf('popupMaxPreviewCharacters');
  var n=getValueOf('popupMaxPreviewSentences');
  var dd;

  do {dd=this.firstSentences(d,n); --n; }
  while ( dd.length &gt; maxChars &amp;&amp; n &gt; 0 );

  this.data = dd;
}
/**
    @private
 */
Previewmaker.prototype.fixSentenceEnds=function(strs, reg) {
  // take an array of strings, strs
  // join strs[i] to strs[i+1] &amp; strs[i+2] if strs[i] matches regex reg

  for (var i=0; i&lt;strs.length-2; ++i) {
    if (reg.test(strs[i])) {
      a=[];
      for (var j=0; j&lt;strs.length; ++j) {
	if (j&lt;i)   a[j]=strs[j];
	if (j==i)  a[i]=strs[i]+strs[i+1]+strs[i+2];
	if (j&gt;i+2) a[j-2]=strs[j];
      }
      return this.fixSentenceEnds(a,reg);
    }
  }
  return strs;
}
/**
    @private
 */
Previewmaker.prototype.firstSentences=function(strs, howmany) {
  var t=strs.slice(0, 2*howmany);
  return t.join('');
}
/**
   Runs the various methods to generate the preview.
   The preview is stored in the &lt;code&gt;html&lt;/html&gt; field.
    @private
 */
Previewmaker.prototype.makePreview=function() {
  if (!isInNamespace(pg.current.article, 'Template')) {
    this.killComments();
    this.killDivs();
    this.killGalleries();
    this.killBoxTemplates();

    if (getValueOf('popupPreviewKillTemplates')) {
      this.killTemplates();
    } else {
      this.killMultilineTemplates();
    }

    this.killTables();
    this.killImages();
    this.killHTML();
    this.killChunks();
    this.mopup();

    this.firstBit();
  }

  this.html=wiki2html(this.data); // needs livepreview
  this.fixHTML();
  this.stripLongTemplates();
}

/** Test function for debugging preview problems one step at a time.
 */
function previewSteps(txt) {
  try {
    txt=txt || document.editform.wpTextbox1.value;
  } catch (err) {
    if (pg.cache.pages.length &gt; 0) {
      txt=pg.cache.pages[pg.cache.pages.length-1].data;
    } else {
      alert('provide text or use an edit page');
    }
  }
  var p=new Previewmaker(txt);
  if (!isInNamespace(pg.current.article, 'Template')) {
    p.killComments(); if (!confirm('done killComments(). Continue?\n---\n' + p.data)) { return; }
    p.killDivs(); if (!confirm('done killDivs(). Continue?\n---\n' + p.data)) { return; }
    p.killGalleries(); if (!confirm('done killGalleries(). Continue?\n---\n' + p.data)) { return; }
    p.killBoxTemplates(); if (!confirm('done killBoxTemplates(). Continue?\n---\n' + p.data)) { return; }

    if (getValueOf('popupPreviewKillTemplates')) {
      p.killTemplates(); if (!confirm('done killTemplates(). Continue?\n---\n' + p.data)) { return; }
    } else {
      p.killMultilineTemplates(); if (!confirm('done killMultilineTemplates(). Continue?\n---\n' + p.data)) { return; }
    }

    p.killTables(); if (!confirm('done killTables(). Continue?\n---\n' + p.data)) { return; }
    p.killImages(); if (!confirm('done killImages(). Continue?\n---\n' + p.data)) { return; }
    p.killHTML(); if (!confirm('done killHTML(). Continue?\n---\n' + p.data)) { return; }
    p.killChunks(); if (!confirm('done killChunks(). Continue?\n---\n' + p.data)) { return; }
    p.mopup(); if (!confirm('done mopup(). Continue?\n---\n' + p.data)) { return; }

    p.firstBit(); if (!confirm('done firstBit(). Continue?\n---\n' + p.data)) { return; }
  }

  p.html=wiki2html(p.data); // needs livepreview
  p.fixHTML(); if (!confirm('done fixHTML(). Continue?\n---\n' + p.html)) { return; }
  p.stripLongTemplates(); if (!confirm('done stripLongTemplates(). Continue?\n---\n' + p.html)) { return; }
  alert('finished preview - end result follows.\n---\n' + p.html);
}

/**
    Works around a quoting bug in livepreview.
    &lt;code&gt;wiki2html('[[Foo\'s &quot;bar&quot;]]')&lt;/code&gt; gives @literal{&lt;a href='Foo's &quot;bar&quot;'&gt;}
    which doesn't do very well. We change this into @literal{&lt;a href=&quot;Foo's %22bar%22&quot;&gt;}
    @private
 */
Previewmaker.prototype.fixHTML=function() {
  if(!this.html) return;
  var splitted=this.html.parenSplit(/href='([^&gt;]*)'/g);
  var ret='';
  for (var i=0; i&lt;splitted.length; ++i) {
    if(i%2==0) { ret += splitted[i]; continue; }
    if(i%2==1) { ret += 'href=&quot;' + splitted[i].split('&quot;').join('%22') + '&quot;'; }
  }
  this.html=ret;
}
/**
    Generates the preview and displays it in the current popup.

    Does nothing if the generated preview is invalid or consists of whitespace only.
    Also activates wikilinks in the preview for subpopups if the popupSubpopups option is true.
 */
Previewmaker.prototype.showPreview=function () {
  this.makePreview();
  if (typeof this.html != typeof '') return;
  if (RegExp('^\\s*$').test(this.html)) return;
  //if (getValueOf('popupNavLinks') || getValueOf('popupSummaryData'))
  var popTips=function() { setupTooltips(document.getElementById('popupPreview' + pg.idNumber)); };
  setPopupHTML('&lt;hr&gt;'+this.html, 'popupPreview', pg.idNumber,
    getValueOf('popupSubpopups') ? function() { pop.runOnce( popTips, 250 ); } : null );
}
/**
    @private
 */
Previewmaker.prototype.stripLongTemplates=function() {
  // operates on the HTML!
  this.html=this.html.replace(RegExp('^.{0,1000}[{][{][^}]*?(&lt;(p|br)( /)?&gt;\\s*){2,}([^{}]*?[}][}])?', 'gi'), '');
  this.html=this.html.split('\n').join(' '); // workaround for &lt;pre&gt; templates
  this.html=this.html.replace(RegExp('[{][{][^}]*&lt;pre&gt;[^}]*[}][}]','gi'), '');
  //this.html=this.html.replace(RegExp('[{][{]([^}]*|\\s){0,50}?&lt;pre&gt;[^{}]*?[}][}]', 'gi'), '');
  //window.h=this.html;
  //alert(this.html);
}
/**
    @private
 */
Previewmaker.prototype.killMultilineTemplates=function() {
  this.data=this.data.replace(RegExp('\\s*[{][{][^{}]*\\n[^{}]*[}][}]', 'g'), ' ');
  //this.data=this.data.replace(RegExp('[{][{]([{][{][^}]*[}][}]|[^{}])*\\n([{][{][^}]*[}][}]|[^{}])*[}][}]', 'g'), ' ');
}

// ENDFILE: previewmaker.js
// STARTFILE: debug.js
////////////////////////////////////////////////////////////////////
// Debugging functions
////////////////////////////////////////////////////////////////////

function time() { var d=new Date();  return d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds() +  '.' + (d.getTime() % 1000); };
var gMsg='';

function limitAlert(fn,max,s) {
  if (!fn.alertCount) fn.alertCount=0;
  if (true &amp;&amp; fn.alertCount &lt; max) {alert(s); fn.alertCount++;}
}

function setupDebugging() {
  // debugging - change DEBUG to NONE to switch off
  if (window.popupDebug) { // popupDebug is set from .version
    window.log=function(x) { //if(gMsg!='')gMsg += '\n'; gMsg+=time() + ' ' + x; };
      if (pg.debugLevel != log.None) window.logger.debug(x);
    }
     window.errlog=function(x) {
      if (pg.debugLevel != log.None) window.logger.error(x);
    }
    pg.debugLevel=Log.DEBUG;
    window.logger = new Log(pg.debugLevel, Log.popupLogger);
    log('Initializing logger');
  } else {
    window.log = function(x) {};
    window.errlog = function(x) {};
  }
}

// ENDFILE: debug.js
// STARTFILE: images.js
// How the URLs for images in the popup come about

//   loadPreview
//          |
//       getWiki
//          |&lt;----------------see other schematic for details
//    insertPreview      (insertPreview = onComplete)
//          |
//          |            insertPreview gets a wikiText fragment from
//          |                       the wikiText downloaded by getWiki
//          |
//  [wikiMarkupToAddressFragment]
//       |
//       |                     mouseOverWikiLink  (gets an &quot;address fragment&quot;,
//       |                            |            no processing needed)
//       \-&gt;-loadThisImage---&lt;----loadImages
//                 |
//           [image(Thumb)URL]--&gt;--hopefully valid image urls

function nextOne (array, value) {
  // NB if the array has two consecutive entries equal
  //    then this will loop on successive calls
  if (typeof array.length == 'undefined') return null;
  for (var i=0; i&lt;array.length-1; ++i) {
    if (array[i]==value) return array[i+1];
  }
  return null;
};

function findThis(array, value) {
  if (typeof array.length == 'undefined') return null;
  for (var i=0; i&lt;array.length; ++i) {
    if (array[i]==value) return i;
  }
  return null;
};

// global array for 404'ed image urls
pg.cache.badImageUrls=[];

function sequentialLoadThisImage (image) {
  if (!getValueOf('popupImages')) return false;
  if (!isValidImageName(image)) return false;

  var imageUrls=getImageUrls(image);
  if (!imageUrls) return null;

  var img=new Image();
  img.isNew=true;
  img.pg.idNumber=pg.idNumber;
  img.counter=1;

  img.onload = function () {
    // clear status thingy
    setImageStatus('');

    var i=findThis(imageUrls, this.src);
    var goodSrc=this.src;

    var setPopupImage=function () {
      var popupImage=document.getElementById(&quot;popupImage&quot;+this.pg.idNumber);
      if (popupImage &amp;&amp; typeof popupImage.src != 'undefined') {
	clearInterval(pg.timer.image);
	popupImage.src=goodSrc;
	popupImage.width=getValueOf('popupImageSize');
	popupImage.style.display='inline';
	setPopupImageLink(image, pg.wiki.imageSources[i].wiki);
	return true;
      } else return false;
    };
    pg.timer.image=setInterval(setPopupImage, 250);
    pg.cache.images.push(goodSrc);
  };

  img.onerror = function () {
    pg.cache.badImageUrls.push(this.src);
    // if the popup is visible, move on
    if (over &amp;&amp; over.style.visibility=='visible' &amp;&amp; this.pg.idNumber==pg.idNumber) this.setNext();
  };

  img.setNext = function () {
    var currentSrc=null;
    var newSrc;
    if (!this.isNew) currentSrc=this.src;
    this.isNew=false;

    newSrc= (currentSrc) ? nextOne(imageUrls, currentSrc) : imageUrls[0];

    while (findThis(pg.cache.badImageUrls, newSrc))  {
      newSrc=nextOne(imageUrls, newSrc);
      if (!newSrc) {
	setImageStatus (' :-(');
	return;
      }
    }
    setImageStatus(' '+findThis(imageUrls, newSrc));
    this.src=newSrc;
  }

  // start the ball rolling
  img.setNext();

};

function loadThisImageAtThisUrl(image, url) {
  log('loading &quot;best&quot; image:\n'+url);
  pg.misc.gImage=image;
  pg.misc.imageArray = [];
  pg.misc.imageArray[0] = new Image();
  pg.misc.imageArray[0].src=url;
  if (pg.timer.image != null) {
    clearInterval(pg.timer.image);
    pg.counter.checkImages=0;
  }
  pg.timer.image=setInterval(&quot;checkImages()&quot;, 250);
  return;
};

function loadImages(article) {if(! isImage(article) ) return null; return loadThisImage(article);};


// methinks this is unbelievably silly
// it dovetails with the parallel image loader function
function checkImages() {
  //log('checkImages: pg.counter.loop='+pg.counter.loop+'; pg.counter.checkImages='+pg.counter.checkImages);
  if (pg.timer.checkImages!=null) {
    clearInterval(pg.timer.checkImages);
    pg.timer.checkImages=null;
    if (pg.counter.loop &gt; 10); {pg.counter.loop=0; log('too many iterations of checkImages'); return;}
    pg.counter.loop++;
  } else pg.counter.checkImages++;

  var status =  ( pg.counter.checkImages % 2 ) ? ':' : '.' ;
  setImageStatus(status);

  if (pg.counter.checkImages &gt; 100) {pg.counter.checkImages = 0; log ('pg.counter.checkImages too big in checkImages; returning'); clearInterval(pg.timer.image);}

  var popupImage=null;
  popupImage=document.getElementById(&quot;popupImg&quot;+pg.idNumber);
  if (popupImage == null) {
    // this doesn't seem to happen any more in practise for some reason
    // still, I'll leave it in
    log('checkImages: document.getElementById(&quot;popupImg'+pg.idNumber+'&quot;) is null! retrying in 333ms...');
    pg.timer.checkImages=setInterval(&quot;checkImages()&quot;,333);
    return;
  }

  log('checkImages: found element popupImg'+pg.idNumber+', and src='+popupImage.src);

  // get the first image to successfully load
  // and put it in the popupImage
  for(var i = 0; i &lt; pg.misc.imageArray.length; ++i) {
    if(isImageOk(pg.misc.imageArray[i])) {
      // stop all the gubbins, assign the image and return

      log('checkImages: got at pos '+i+', src='+pg.misc.imageArray[i].src);
      clearInterval(pg.timer.image);

      if(isImage(pg.misc.gImage)) {
	popupImage.src=pg.misc.imageArray[i].src;
	popupImage.width=getValueOf('popupImageSize');
	popupImage.style.display='inline';
	// should we check to see if it's already there? maybe...
	pg.cache.images.push(pg.misc.imageArray[i].src);

	setPopupImageLink(pg.misc.gImage, pg.wiki.imageSources[i].wiki);
	stopImagesDownloading();
      }

      setImageStatus('');

      // reset evil nonconstant globals
      delete pg.misc.imageArray; pg.misc.imageArray=[];
      pg.timer.image=null;

      pg.counter.checkImages=0;
      pg.counter.loop=0;

      return popupImage.src;
    }
  }
  log('checkImages: no good image found. retrying in a tic...');
  pg.timer.checkImages=setInterval(&quot;checkImages()&quot;,333);
};

function stopImagesDownloading() {
  pg.misc.gImage=null;
  if (pg.misc.imageArray == null) return null;
  var i;
  for (i=0; i&lt;pg.misc.imageArray.length; ++i) {
    //pg.misc.imageArray[i].src=''; // this is a REALLY BAD IDEA
    delete pg.misc.imageArray[i];
    //pg.misc.imageArray[i] = new Image();
  }
  pg.misc.imageArray = [];
  return i;
};

function toggleSize() {
  var imgContainer=this;
  if (!imgContainer) { alert('imgContainer is null :/'); return;}
  img=imgContainer.firstChild;
  if (!img) { alert('img is null :/'); return;}
  if (!img.style.width || img.style.width=='') img.style.width='100%';
  else img.style.width=''; // popupImageSize+'px';
};

function setPopupImageLink (img, wiki) {
  if( wiki === null || img === null ) return null;

  var a=document.getElementById(&quot;popupImageLink&quot;+pg.idNumber);
  if (a === null) return null;

  var linkURL = imageURL(img, wiki);
  if (linkURL != null) {
    if (getValueOf('popupImagesToggleSize')) { a.onclick=toggleSize; a.title=popupString('Toggle image size'); }
    else { a.href=linkURL; a.title=popupString('Open full-size image'); }
  }
  return linkURL;
};

function isImageOk(img)
{
  // IE test
  if (!img.complete)
    return false;

  // gecko test
  if (typeof img.naturalWidth != &quot;undefined&quot; &amp;&amp; img.naturalWidth == 0)
    return false;

  // test for konqueror and opera

  // note that img.width must not be defined in the html with a width=&quot;...&quot;
  // for this to work.

  // konq seems to give &quot;broken images&quot; width 16, presumably an icon width
  // this test would probably work in gecko too, *except for very small images*
  if (typeof img.width == 'undefined' || img.width &lt;=  16) return false;

  // No other way of checking: assume it's ok.
  return true;
};

// those odd a/a5/ bits of image urls
function imagePathComponent(article) {
  var stripped=stripNamespace(article);
  var forhash=safeDecodeURI(stripped).split(' ').join('_');
  var hash=hex_md5(forhash);
  return hash.substring(0,1) + '/' + hash.substring(0,2) + '/';
}

function getImageUrlStart(wiki) { // this returns a trailing slash
  switch (wiki) {
    case 'en.wikipedia.org':  return 'http://upload.wikimedia.org/wikipedia/en/';
    case pg.wiki.commons:     return 'http://upload.wikimedia.org/wikipedia/commons/';
    case 'en.wiktionary.org': return 'http://en.wiktionary.org/upload/en/';
    default: // unsupported - take a guess
      if (pg.wiki.wikimedia) {
	return 'http://upload.wikimedia.org/wikipedia/' + pg.wiki.lang +'/';
      }
      else /* this should work for wikicities */
	return 'http://' + wiki + '/images/';
  }
}

function imageURL(img, wiki) {
  if (getValueOf('popupImagesFromThisWikiOnly') &amp;&amp; wiki != pg.wiki.hostname) return null;
  var imgurl=null;
  if (isImage(img)) {
    var pathcpt = imagePathComponent(img);
    var stripped=stripNamespace(img);
    imgurl=getImageUrlStart(wiki) + pathcpt + stripped;
  }
  return imgurl;
}

function imageThumbURL(img, wiki, width) {
  //
  // eg http://upload.wikimedia.org/wikipedia/en/thumb/6/61/
  //           Rubiks_cube_solved.jpg/120px-Rubiks_cube_solved.jpg
  //           ^^^^^^^^^^^^^^^^^^^^^^^
  //          wikicities omits this bit
  //  AND wikicities needs a new pathcpt for each filename including thumbs

  if (getValueOf('popupImagesFromThisWikiOnly') &amp;&amp; wiki != pg.wiki.hostname) return null;
  if (getValueOf('popupNeverGetThumbs')) return null;

  var imgurl=null;
  if (isImage(img)) {
    var stripped=stripNamespace(img);
    var pathcpt;
    if (pg.wiki.wikimedia) pathcpt = imagePathComponent(stripped);
    else pathcpt = imagePathComponent(width+'px-'+stripped);
    imgurl=getImageUrlStart(wiki) +  &quot;thumb/&quot; + pathcpt;
    if (pg.wiki.wikimedia) imgurl += stripped + '/';
    imgurl += width +&quot;px-&quot; + stripped;
  }
  return imgurl;
};

function loadThisImage(image) {
  if (getValueOf('popupLoadImagesSequentially')) return sequentialLoadThisImage(image);
  else return parallelLoadThisImage(image);
};

function getImageUrls(image) {
  var imageUrls=[];
  for (var i=0; i&lt;pg.wiki.imageSources.length; ++i) {
    var url;
    if (pg.wiki.imageSources[i].thumb)
      url=imageThumbURL(image, pg.wiki.imageSources[i].wiki, pg.wiki.imageSources[i].width);
    else
      url=imageURL(image, pg.wiki.imageSources[i].wiki);
    for (var j=0; j&lt;pg.cache.images.length; ++j) {
      if (url == pg.cache.images[j]) {
	loadThisImageAtThisUrl(image, url);
	return null;
      }
    }
    if (url!=null) imageUrls.push(url);
  }
  return imageUrls;
};


// this is probably very wasteful indeed of bandwidth
// hey ho

function parallelLoadThisImage (image) {
  if (!getValueOf('popupImages')) return;
  if (!isValidImageName(image)) return false;

  var imageUrls=getImageUrls(image);
  if (!imageUrls) return null;

  for (var i=0; i&lt;imageUrls.length; ++i) {
    var url = imageUrls[i];
    pg.misc.imageArray[i]=new Image();
    pg.misc.imageArray[i].src=url;
  }
  if (pg.timer.image != null) {
    clearInterval(pg.timer.image);
    pg.counter.checkImages=0;
  }
  pg.misc.gImage=image;
  pg.timer.image=setInterval(&quot;checkImages()&quot;, 250);
  return true;
};
function getValidImageFromWikiText(wikiText) {
  var imagePage=null;
  // nb in pg.re.image we're interested in the second bracketed expression
  // this may change if the regex changes :-(
  //var match=pg.re.image.exec(wikiText);
  var matched=null;
  var match;
  while ( match = pg.re.image.exec(wikiText) ) {
    // now find a sane image name - exclude templates by seeking {
    var m = match[2] || pg.ns.image + ':' + match[6];
    var pxWidth=match[4];
    if ( isValidImageName(m) &amp;&amp; (!pxWidth || parseInt(pxWidth) &gt;= getValueOf('popupMinImageWidth')) ) {
      matched=m;
      break;
    }
  }
  pg.re.image.lastIndex=0;
  if (!matched) return null;
  return pg.ns.image+':'+upcaseFirst(matched);
};

// ENDFILE: images.js
// STARTFILE: namespaces.js
// Set up namespaces and other non-strings.js localization
// (currently that means redirs too)

// Put the right namespace list into pg.ns.list, based on pg.wiki.lang
// Default to english if nothing seems to fit
function setNamespaceList() {
  var m=&quot;Media&quot;;
  var list = [m, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;, &quot;Portal&quot;, &quot;Portal talk&quot;];
  var nsLists = {
    &quot;af&quot;: [m, &quot;Spesiaal&quot;, &quot;Bespreking&quot;, &quot;Gebruiker&quot;, &quot;Gebruikerbespreking&quot;, &quot;Wikipedia&quot;, &quot;Wikipediabespreking&quot;, &quot;Beeld&quot;, &quot;Beeldbespreking&quot;, &quot;MediaWiki&quot;, &quot;MediaWikibespreking&quot;, &quot;Sjabloon&quot;, &quot;Sjabloonbespreking&quot;, &quot;Hulp&quot;, &quot;Hulpbespreking&quot;, &quot;Kategorie&quot;, &quot;Kategoriebespreking&quot;],
    &quot;als&quot;: [m, &quot;Spezial&quot;, &quot;Diskussion&quot;, &quot;Benutzer&quot;, &quot;Benutzer Diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskussion&quot;, &quot;Bild&quot;, &quot;Bild Diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskussion&quot;, &quot;Vorlage&quot;, &quot;Vorlage Diskussion&quot;, &quot;Hilfe&quot;, &quot;Hilfe Diskussion&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskussion&quot;],
    &quot;ar&quot;: [&quot;ملف&quot;, &quot;خاص&quot;, &quot;نقاش&quot;, &quot;مستخدم&quot;, &quot;نقاش المستخدم&quot;, &quot;ويكيبيديا&quot;, &quot;نقاش ويكيبيديا&quot;, &quot;صورة&quot;, &quot;نقاش الصورة&quot;, &quot;ميدياويكي&quot;, &quot;نقاش ميدياويكي&quot;, &quot;Template&quot;, &quot;نقاش Template&quot;, &quot;مساعدة&quot;, &quot;نقاش المساعدة&quot;, &quot;تصنيف&quot;, &quot;نقاش التصنيف&quot;],
    &quot;ast&quot;: [m, &quot;Especial&quot;, &quot;Discusión&quot;, &quot;Usuariu&quot;, &quot;Usuariu discusión&quot;, &quot;Uiquipedia&quot;, &quot;Uiquipedia discusión&quot;, &quot;Imaxen&quot;, &quot;Imaxen discusión&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki discusión&quot;, &quot;Plantilla&quot;, &quot;Plantilla discusión&quot;, &quot;Ayuda&quot;, &quot;Ayuda discusión&quot;, &quot;Categoría&quot;, &quot;Categoría discusión&quot;],
    &quot;be&quot;: [&quot;Мэдыя&quot;, &quot;Спэцыяльныя&quot;, &quot;Абмеркаваньне&quot;, &quot;Удзельнік&quot;, &quot;Гутаркі ўдзельніка&quot;, &quot;Вікіпэдыя&quot;, &quot;Абмеркаваньне Вікіпэдыя&quot;, &quot;Выява&quot;, &quot;Абмеркаваньне выявы&quot;, &quot;MediaWiki&quot;, &quot;Абмеркаваньне MediaWiki&quot;, &quot;Шаблён&quot;, &quot;Абмеркаваньне шаблёну&quot;, &quot;Дапамога&quot;, &quot;Абмеркаваньне дапамогі&quot;, &quot;Катэгорыя&quot;, &quot;Абмеркаваньне катэгорыі&quot;],
    &quot;bg&quot;: [&quot;Медия&quot;, &quot;Специални&quot;, &quot;Беседа&quot;, &quot;Потребител&quot;, &quot;Потребител беседа&quot;, &quot;Уикипедия&quot;, &quot;Уикипедия беседа&quot;, &quot;Картинка&quot;, &quot;Картинка беседа&quot;, &quot;МедияУики&quot;, &quot;МедияУики беседа&quot;, &quot;Шаблон&quot;, &quot;Шаблон беседа&quot;, &quot;Помощ&quot;, &quot;Помощ беседа&quot;, &quot;Категория&quot;, &quot;Категория беседа&quot;],
    &quot;bm&quot;: [m, &quot;Special&quot;, &quot;Discuter&quot;, &quot;Utilisateur&quot;, &quot;Discussion Utilisateur&quot;, &quot;Wikipedia&quot;, &quot;Discussion Wikipedia&quot;, &quot;Image&quot;, &quot;Discussion Image&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Modèle&quot;, &quot;Discussion Modèle&quot;, &quot;Aide&quot;, &quot;Discussion Aide&quot;, &quot;Catégorie&quot;, &quot;Discussion Catégorie&quot;],
    &quot;bn&quot;: [&quot;বিশেষ&quot;, &quot;আলাপ&quot;, &quot;ব্যবহারকারী&quot;, &quot;ব্যবহারকারী আলাপ&quot;, &quot;উইকিপেডিয়া&quot;, &quot;উইকিপেডিয়া আলাপ&quot;, &quot;চিত্র&quot;, &quot;চিত্র আলাপ&quot;, &quot;MediaWik i আলাপ&quot;, m, &quot;MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;br&quot;: [m, &quot;Dibar&quot;, &quot;Kaozeal&quot;, &quot;Implijer&quot;, &quot;Kaozeadenn Implijer&quot;, &quot;Wikipedia&quot;, &quot;Kaozeadenn Wikipedia&quot;, &quot;Skeudenn&quot;, &quot;Kaozeadenn Skeudenn&quot;, &quot;MediaWiki&quot;, &quot;Kaozeadenn MediaWiki&quot;, &quot;Patrom&quot;, &quot;Kaozeadenn Patrom&quot;, &quot;Skoazell&quot;, &quot;Kaozeadenn Skoazell&quot;, &quot;Rummad&quot;, &quot;Kaozeadenn Rummad&quot;],
    &quot;ca&quot;: [m, &quot;Especial&quot;, &quot;Discussió&quot;, &quot;Usuari&quot;, &quot;Usuari Discussió&quot;, &quot;Viquipèdia&quot;, &quot;Viquipèdia Discussió&quot;, &quot;Imatge&quot;, &quot;Imatge Discussió&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Discussió&quot;, &quot;Template&quot;, &quot;Template Discussió&quot;, &quot;Ajuda&quot;, &quot;Ajuda Discussió&quot;, &quot;Categoria&quot;, &quot;Categoria Discussió&quot;],
    &quot;cs&quot;: [&quot;Média&quot;, &quot;Speciální&quot;, &quot;Diskuse&quot;, &quot;Wikipedista&quot;, &quot;Wikipedista diskuse&quot;, &quot;Wikipedie&quot;, &quot;Wikipedie diskuse&quot;, &quot;Soubor&quot;, &quot;Soubor diskuse&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskuse&quot;, &quot;Šablona&quot;, &quot;Šablona diskuse&quot;, &quot;Nápověda&quot;, &quot;Nápověda diskuse&quot;, &quot;Kategorie&quot;, &quot;Kategorie diskuse&quot;],
    &quot;csb&quot;: [m, &quot;Specjalnô&quot;, &quot;Diskùsëjô&quot;, &quot;Brëkòwnik&quot;, &quot;Diskùsëjô brëkòwnika&quot;, &quot;Wiki&quot;, &quot;Diskùsëjô Wiki&quot;, &quot;Òbrôzk&quot;, &quot;Diskùsëjô òbrôzków&quot;, &quot;MediaWiki&quot;, &quot;Diskùsëjô MediaWiki&quot;, &quot;Szablóna&quot;, &quot;Diskùsëjô Szablónë&quot;, &quot;Pòmòc&quot;, &quot;Diskùsëjô Pòmòcë&quot;, &quot;Kategòrëjô&quot;, &quot;Diskùsëjô Kategòrëji&quot;],
    &quot;cv&quot;: [&quot;Медиа&quot;, &quot;Ятарлă&quot;, &quot;Сӳтсе явасси&quot;, &quot;Хутшăнакан&quot;, &quot;Хутшăнаканăн канашлу страници&quot;, &quot;Wikipedia&quot;, &quot;0&quot;, &quot;Ӳкерчĕк&quot;, &quot;Ӳкерчĕке сӳтсе явмалли&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki сӳтсе явмалли&quot;, &quot;Шаблон&quot;, &quot;Шаблона сӳтсе явмалли&quot;, &quot;Пулăшу&quot;, &quot;Пулăшăва сӳтсе явмалли&quot;, &quot;Категори&quot;, &quot;Категорине сӳтсе явмалли&quot;],
    &quot;cy&quot;: [m, &quot;Arbennig&quot;, &quot;Sgwrs&quot;, &quot;Defnyddiwr&quot;, &quot;Sgwrs Defnyddiwr&quot;, &quot;Wicipedia&quot;, &quot;Sgwrs Wicipedia&quot;, &quot;Delwedd&quot;, &quot;Sgwrs Delwedd&quot;, &quot;MediaWiki&quot;, &quot;Sgwrs MediaWiki&quot;, &quot;Nodyn&quot;, &quot;Sgwrs Nodyn&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;da&quot;: [m, &quot;Speciel&quot;, &quot;Diskussion&quot;, &quot;Bruger&quot;, &quot;Bruger diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia diskussion&quot;, &quot;Billede&quot;, &quot;Billede diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskussion&quot;, &quot;Skabelon&quot;, &quot;Skabelon diskussion&quot;, &quot;Hjælp&quot;, &quot;Hjælp diskussion&quot;, &quot;Kategori&quot;, &quot;Kategori diskussion&quot;],
    &quot;de&quot;: [m, &quot;Spezial&quot;, &quot;Diskussion&quot;, &quot;Benutzer&quot;, &quot;Benutzer Diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskussion&quot;, &quot;Bild&quot;, &quot;Bild Diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskussion&quot;, &quot;Vorlage&quot;, &quot;Vorlage Diskussion&quot;, &quot;Hilfe&quot;, &quot;Hilfe Diskussion&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskussion&quot;, &quot;Portal&quot;, &quot;Portal Diskussion&quot;],
    &quot;el&quot;: [&quot;Μέσον&quot;, &quot;Ειδικό&quot;, &quot;Συζήτηση&quot;, &quot;Χρήστης&quot;, &quot;Συζήτηση χρήστη&quot;, &quot;Βικιπαίδεια&quot;, &quot;Βικιπαίδεια συζήτηση&quot;, &quot;Εικόνα&quot;, &quot;Συζήτηση εικόνας&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Πρότυπο&quot;, &quot;Συζήτηση προτύπου&quot;, &quot;Βοήθεια&quot;, &quot;Συζήτηση βοήθειας&quot;, &quot;Κατηγορία&quot;, &quot;Συζήτηση κατηγορίας&quot;],
    &quot;eo&quot;: [m, &quot;Speciala&quot;, &quot;Diskuto&quot;, &quot;Vikipediisto&quot;, &quot;Vikipediista diskuto&quot;, &quot;Vikipedio&quot;, &quot;Vikipedio diskuto&quot;, &quot;Dosiero&quot;, &quot;Dosiera diskuto&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskuto&quot;, &quot;Ŝablono&quot;, &quot;Ŝablona diskuto&quot;, &quot;Helpo&quot;, &quot;Helpa diskuto&quot;, &quot;Kategorio&quot;, &quot;Kategoria diskuto&quot;],
    &quot;es&quot;: [m, &quot;Especial&quot;, &quot;Discusión&quot;, &quot;Usuario&quot;, &quot;Usuario Discusión&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Discusión&quot;, &quot;Imagen&quot;, &quot;Imagen Discusión&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Discusión&quot;, &quot;Plantilla&quot;, &quot;Plantilla Discusión&quot;, &quot;Ayuda&quot;, &quot;Ayuda Discusión&quot;, &quot;Categoría&quot;, &quot;Categoría Discusión&quot;],
    &quot;et&quot;: [&quot;Meedia&quot;, &quot;Eri&quot;, &quot;Arutelu&quot;, &quot;Kasutaja&quot;, &quot;Kasutaja arutelu&quot;, &quot;Vikipeedia&quot;, &quot;Vikipeedia arutelu&quot;, &quot;Pilt&quot;, &quot;Pildi arutelu&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki arutelu&quot;, &quot;Mall&quot;, &quot;Malli arutelu&quot;, &quot;Juhend&quot;, &quot;Juhendi arutelu&quot;, &quot;Kategooria&quot;, &quot;Kategooria arutelu&quot;],
    &quot;eu&quot;: [m, &quot;Aparteko&quot;, &quot;Eztabaida&quot;, &quot;Lankide&quot;, &quot;Lankide eztabaida&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia eztabaida&quot;, &quot;Irudi&quot;, &quot;Irudi eztabaida&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki eztabaida&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;fa&quot;: [&quot;مدیا&quot;, &quot;ویژه&quot;, &quot;بحث&quot;, &quot;کاربر&quot;, &quot;بحث کاربر&quot;, &quot;ویکی‌پدیا&quot;, &quot;بحث ویکی‌پدیا&quot;, &quot;تصویر&quot;, &quot;بحث تصویر&quot;, &quot;مدیاویکی&quot;, &quot;بحث مدیاویکی&quot;, &quot;الگو&quot;, &quot;بحث الگو&quot;, &quot;راهنما&quot;, &quot;بحث راهنما&quot;, &quot;رده&quot;, &quot;بحث رده&quot;],
    &quot;fi&quot;: [m, &quot;Toiminnot&quot;, &quot;Keskustelu&quot;, &quot;Käyttäjä&quot;, &quot;Keskustelu käyttäjästä&quot;, &quot;Wikipedia&quot;, &quot;Keskustelu Wikipediasta&quot;, &quot;Kuva&quot;, &quot;Keskustelu kuvasta&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Malline&quot;, &quot;Keskustelu mallineesta&quot;, &quot;Ohje&quot;, &quot;Keskustelu ohjeesta&quot;, &quot;Luokka&quot;, &quot;Keskustelu luokasta&quot;],
    &quot;fo&quot;: [&quot;Miðil&quot;, &quot;Serstakur&quot;, &quot;Kjak&quot;, &quot;Brúkari&quot;, &quot;Brúkari kjak&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia kjak&quot;, &quot;Mynd&quot;, &quot;Mynd kjak&quot;, &quot;MidiaWiki&quot;, &quot;MidiaWiki kjak&quot;, &quot;Fyrimynd&quot;, &quot;Fyrimynd kjak&quot;, &quot;Hjálp&quot;, &quot;Hjálp kjak&quot;, &quot;Bólkur&quot;, &quot;Bólkur kjak&quot;],
    &quot;fr&quot;: [m, &quot;Special&quot;, &quot;Discuter&quot;, &quot;Utilisateur&quot;, &quot;Discussion Utilisateur&quot;, &quot;Wikipédia&quot;, &quot;Discussion Wikipédia&quot;, &quot;Image&quot;, &quot;Discussion Image&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Modèle&quot;, &quot;Discussion Modèle&quot;, &quot;Aide&quot;, &quot;Discussion Aide&quot;, &quot;Catégorie&quot;, &quot;Discussion Catégorie&quot;, &quot;Portail&quot;, &quot;Discussion Portail&quot;],
    &quot;fur&quot;: [m, &quot;Speciâl&quot;, &quot;Discussion&quot;, &quot;Utent&quot;, &quot;Discussion utent&quot;, &quot;Vichipedie&quot;, &quot;Discussion Vichipedie&quot;, &quot;Figure&quot;, &quot;Discussion figure&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Model&quot;, &quot;Discussion model&quot;, &quot;Jutori&quot;, &quot;Discussion jutori&quot;, &quot;Categorie&quot;, &quot;Discussion categorie&quot;],
    &quot;fy&quot;: [m, &quot;Wiki&quot;, &quot;Oerlis&quot;, &quot;Meidogger&quot;, &quot;Meidogger oerlis&quot;, &quot;Wikipedy&quot;, &quot;Wikipedy oerlis&quot;, &quot;Ofbyld&quot;, &quot;Ofbyld oerlis&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki oerlis&quot;, &quot;Berjocht&quot;, &quot;Berjocht oerlis&quot;, &quot;Hulp&quot;, &quot;Hulp oerlis&quot;, &quot;Kategory&quot;, &quot;Kategory oerlis&quot;],
    &quot;ga&quot;: [&quot;Meán&quot;, &quot;Speisialta&quot;, &quot;Plé&quot;, &quot;Úsáideoir&quot;, &quot;Plé úsáideora&quot;, &quot;Vicipéid&quot;, &quot;Plé Vicipéide&quot;, &quot;Íomhá&quot;, &quot;Plé íomhá&quot;, &quot;MediaWiki&quot;, &quot;Plé MediaWiki&quot;, &quot;Teimpléad&quot;, &quot;Plé teimpléid&quot;, &quot;Cabhair&quot;, &quot;Plé cabhrach&quot;, &quot;Catagóir&quot;, &quot;Plé catagóire&quot;],
    &quot;gu&quot;: [m, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;વિકિપીડિયા&quot;, &quot;વિકિપીડિયા talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;he&quot;: [m, &quot;מיוחד&quot;, &quot;שיחה&quot;, &quot;משתמש&quot;, &quot;שיחת משתמש&quot;, &quot;ויקיפדיה&quot;, &quot;שיחת ויקיפדיה&quot;, &quot;תמונה&quot;, &quot;שיחת תמונה&quot;, &quot;MediaWiki&quot;, &quot;שיחת MediaWiki&quot;, &quot;תבנית&quot;, &quot;שיחת תבנית&quot;, &quot;עזרה&quot;, &quot;שיחת עזרה&quot;, &quot;קטגוריה&quot;, &quot;שיחת קטגוריה&quot;],
    &quot;hi&quot;: [m, &quot;विशेष&quot;, &quot;वार्ता&quot;, &quot;सदस्य&quot;, &quot;सदस्य वार्ता&quot;, &quot;विकिपीडिया&quot;, &quot;विकिपीडिया वार्ता&quot;, &quot;चित्र&quot;, &quot;चित्र वार्ता&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;श्रेणी&quot;, &quot;श्रेणी वार्ता&quot;, &quot;Help&quot;, &quot;Help talk&quot;],
    &quot;hr&quot;: [&quot;Mediji&quot;, &quot;Posebno&quot;, &quot;Razgovor&quot;, &quot;Suradnik&quot;, &quot;Razgovor sa suradnikom&quot;, &quot;Wikipedia&quot;, &quot;Razgovor Wikipedia&quot;, &quot;Slika&quot;, &quot;Razgovor o slici&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki razgovor&quot;, &quot;Predložak&quot;, &quot;Razgovor o predlošku&quot;, &quot;Pomoć&quot;, &quot;Razgovor o pomoći&quot;, &quot;Kategorija&quot;, &quot;Razgovor o kategoriji&quot;],
    &quot;hu&quot;: [&quot;Média&quot;, &quot;Speciális&quot;, &quot;Vita&quot;, &quot;User&quot;, &quot;User vita&quot;, &quot;Wikipédia&quot;, &quot;Wikipédia vita&quot;, &quot;Kép&quot;, &quot;Kép vita&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki vita&quot;, &quot;Sablon&quot;, &quot;Sablon vita&quot;, &quot;Segítség&quot;, &quot;Segítség vita&quot;, &quot;Kategória&quot;, &quot;Kategória vita&quot;],
    &quot;ia&quot;: [m, &quot;Special&quot;, &quot;Discussion&quot;, &quot;Usator&quot;, &quot;Discussion Usator&quot;, &quot;Wikipedia&quot;, &quot;Discussion Wikipedia&quot;, &quot;Imagine&quot;, &quot;Discussion Imagine&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;id&quot;: [m, &quot;Istimewa&quot;, &quot;Bicara&quot;, &quot;Pengguna&quot;, &quot;Bicara Pengguna&quot;, &quot;Wikipedia&quot;, &quot;Pembicaraan Wikipedia&quot;, &quot;Gambar&quot;, &quot;Pembicaraan Gambar&quot;, &quot;MediaWiki&quot;, &quot;Pembicaraan MediaWiki&quot;, &quot;Templat&quot;, &quot;Pembicaraan Templat&quot;, &quot;Bantuan&quot;, &quot;Pembicaraan Bantuan&quot;, &quot;Kategori&quot;, &quot;Pembicaraan Kategori&quot;],
    &quot;is&quot;: [&quot;Miðill&quot;, &quot;Kerfissíða&quot;, &quot;Spjall&quot;, &quot;Notandi&quot;, &quot;Notandaspjall&quot;, &quot;Wikipedia&quot;, &quot;Wikipediaspjall&quot;, &quot;Mynd&quot;, &quot;Myndaspjall&quot;, &quot;Melding&quot;, &quot;Meldingarspjall&quot;, &quot;Snið&quot;, &quot;Sniðaspjall&quot;, &quot;Hjálp&quot;, &quot;Hjálparspjall&quot;, &quot;Flokkur&quot;, &quot;Flokkaspjall&quot;],
    &quot;it&quot;: [m, &quot;Speciale&quot;, &quot;Discussione&quot;, &quot;Utente&quot;, &quot;Discussioni utente&quot;, &quot;Wikipedia&quot;, &quot;Discussioni Wikipedia&quot;, &quot;Immagine&quot;, &quot;Discussioni immagine&quot;, &quot;MediaWiki&quot;, &quot;Discussioni MediaWiki&quot;, &quot;Template&quot;, &quot;Discussioni template&quot;, &quot;Aiuto&quot;, &quot;Discussioni aiuto&quot;, &quot;Categoria&quot;, &quot;Discussioni categoria&quot;],
    &quot;ja&quot;: [m, &quot;特別&quot;, &quot;ノート&quot;, &quot;利用者&quot;, &quot;利用者‐会話&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia‐ノート&quot;, &quot;画像&quot;, &quot;画像‐ノート&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki‐ノート&quot;, &quot;Template&quot;, &quot;Template‐ノート&quot;, &quot;Help&quot;, &quot;Help‐ノート&quot;, &quot;Category&quot;, &quot;Category‐ノート&quot;],
    &quot;ka&quot;: [&quot;მედია&quot;, &quot;სპეციალური&quot;, &quot;განხილვა&quot;, &quot;მომხმარებელი&quot;, &quot;მომხმარებელი განხილვა&quot;, &quot;ვიკიპედია&quot;, &quot;ვიკიპედია განხილვა&quot;, &quot;სურათი&quot;, &quot;სურათი განხილვა&quot;, &quot;მედიავიკი&quot;, &quot;მედიავიკი განხილვა&quot;, &quot;თარგი&quot;, &quot;თარგი განხილვა&quot;, &quot;დახმარება&quot;, &quot;დახმარება განხილვა&quot;, &quot;კატეგორია&quot;, &quot;კატეგორია განხილვა&quot;],
    &quot;ko&quot;: [m, &quot;특수기능&quot;, &quot;토론&quot;, &quot;사용자&quot;, &quot;사용자토론&quot;, &quot;위키백과&quot;, &quot;위키백과토론&quot;, &quot;그림&quot;, &quot;그림토론&quot;, &quot;분류&quot;, &quot;분류토론&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;],
    &quot;ku&quot;: [&quot;Medya&quot;, &quot;Taybet&quot;, &quot;Nîqaş&quot;, &quot;Bikarhêner&quot;, &quot;Bikarhêner nîqaş&quot;, &quot;Wîkîpediya&quot;, &quot;Wîkîpediya nîqaş&quot;, &quot;Wêne&quot;, &quot;Wêne nîqaş&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki nîqaş&quot;, &quot;Şablon&quot;, &quot;Şablon nîqaş&quot;, &quot;Alîkarî&quot;, &quot;Alîkarî nîqaş&quot;, &quot;Kategorî&quot;, &quot;Kategorî nîqaş&quot;],
    &quot;la&quot;: [&quot;Specialis&quot;, &quot;Disputatio&quot;, &quot;Usor&quot;, &quot;Disputatio Usoris&quot;, &quot;Vicipaedia&quot;, &quot;Disputatio Vicipaediae&quot;, &quot;Imago&quot;, &quot;Disputatio Imaginis&quot;, &quot;MediaWiki&quot;, &quot;Disputatio MediaWiki&quot;, &quot;Formula&quot;, &quot;Disputatio Formulae&quot;, &quot;Auxilium&quot;, &quot;Disputatio Auxilii&quot;, &quot;Categoria&quot;, &quot;Disputatio Categoriae&quot;, m],
    &quot;li&quot;: [m, &quot;Speciaal&quot;, &quot;Euverlik&quot;, &quot;Gebroeker&quot;, &quot;Euverlik gebroeker&quot;, &quot;Wikipedia&quot;, &quot;Euverlik Wikipedia&quot;, &quot;Aafbeilding&quot;, &quot;Euverlik afbeelding&quot;, &quot;MediaWiki&quot;, &quot;Euverlik MediaWiki&quot;, &quot;Sjabloon&quot;, &quot;Euverlik sjabloon&quot;, &quot;Help&quot;, &quot;Euverlik help&quot;, &quot;Kategorie&quot;, &quot;Euverlik kategorie&quot;],
    &quot;lt&quot;: [&quot;Medija&quot;, &quot;Specialus&quot;, &quot;Aptarimas&quot;, &quot;Naudotojas&quot;, &quot;Naudotojo aptarimas&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia aptarimas&quot;, &quot;Vaizdas&quot;, &quot;Vaizdo aptarimas&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki aptarimas&quot;, &quot;Šablonas&quot;, &quot;Šablono aptarimas&quot;, &quot;Pagalba&quot;, &quot;Pagalbos aptarimas&quot;, &quot;Kategorija&quot;, &quot;Kategorijos aptarimas&quot;],
    &quot;mk&quot;: [&quot;Медија&quot;, &quot;Специјални&quot;, &quot;Разговор&quot;, &quot;Корисник&quot;, &quot;Корисник разговор&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia разговор&quot;, &quot;Слика&quot;, &quot;Слика разговор&quot;, &quot;МедијаВики&quot;, &quot;МедијаВики разговор&quot;, &quot;Шаблон&quot;, &quot;Шаблон разговор&quot;, &quot;Помош&quot;, &quot;Помош разговор&quot;, &quot;Категорија&quot;, &quot;Категорија разговор&quot;],
    &quot;ms&quot;: [m, &quot;Istimewa&quot;, &quot;Perbualan&quot;, &quot;Pengguna&quot;, &quot;Perbualan Pengguna&quot;, &quot;Wikipedia&quot;, &quot;Perbualan Wikipedia&quot;, &quot;Imej&quot;, &quot;Imej Perbualan&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Perbualan&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;mt&quot;: [m, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;Wikipedija&quot;, &quot;Wikipedija talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;nap&quot;: [m, &quot;Speciale&quot;, &quot;Discussione&quot;, &quot;Utente&quot;, &quot;Discussioni utente&quot;, &quot;Wikipedia&quot;, &quot;Discussioni Wikipedia&quot;, &quot;Immagine&quot;, &quot;Discussioni immagine&quot;, &quot;MediaWiki&quot;, &quot;Discussioni MediaWiki&quot;, &quot;Template&quot;, &quot;Discussioni template&quot;, &quot;Aiuto&quot;, &quot;Discussioni aiuto&quot;, &quot;Categoria&quot;, &quot;Discussioni categoria&quot;],
    &quot;nds&quot;: [m, &quot;Spezial&quot;, &quot;Diskuschoon&quot;, &quot;Bruker&quot;, &quot;Bruker Diskuschoon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskuschoon&quot;, &quot;Bild&quot;, &quot;Bild Diskuschoon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskuschoon&quot;, &quot;Vörlaag&quot;, &quot;Vörlaag Diskuschoon&quot;, &quot;Hülp&quot;, &quot;Hülp Diskuschoon&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskuschoon&quot;],
    &quot;nl&quot;: [m, &quot;Speciaal&quot;, &quot;Overleg&quot;, &quot;Gebruiker&quot;, &quot;Overleg gebruiker&quot;, &quot;Wikipedia&quot;, &quot;Overleg Wikipedia&quot;, &quot;Afbeelding&quot;, &quot;Overleg afbeelding&quot;, &quot;MediaWiki&quot;, &quot;Overleg MediaWiki&quot;, &quot;Sjabloon&quot;, &quot;Overleg sjabloon&quot;, &quot;Help&quot;, &quot;Overleg help&quot;, &quot;Categorie&quot;, &quot;Overleg categorie&quot;],
    &quot;nn&quot;: [&quot;Filpeikar&quot;, &quot;Spesial&quot;, &quot;Diskusjon&quot;, &quot;Brukar&quot;, &quot;Brukardiskusjon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia-diskusjon&quot;, &quot;Fil&quot;, &quot;Fildiskusjon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki-diskusjon&quot;, &quot;Mal&quot;, &quot;Maldiskusjon&quot;, &quot;Hjelp&quot;, &quot;Hjelpdiskusjon&quot;, &quot;Kategori&quot;, &quot;Kategoridiskusjon&quot;],
    &quot;no&quot;: [&quot;Medium&quot;, &quot;Spesial&quot;, &quot;Diskusjon&quot;, &quot;Bruker&quot;, &quot;Brukerdiskusjon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia-diskusjon&quot;, &quot;Bilde&quot;, &quot;Bildediskusjon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki-diskusjon&quot;, &quot;Mal&quot;, &quot;Maldiskusjon&quot;, &quot;Hjelp&quot;, &quot;Hjelpdiskusjon&quot;, &quot;Kategori&quot;, &quot;Kategoridiskusjon&quot;],
    &quot;nv&quot;: [m, &quot;Special&quot;, &quot;Naaltsoos baa yinísht'į́&quot;, &quot;Choinish'įįhí&quot;, &quot;Choinish'įįhí baa yinísht'į́&quot;, &quot;Wikiibíídiiya&quot;, &quot;Wikiibíídiiya baa yinísht'į́&quot;, &quot;E'elyaaígíí&quot;, &quot;E'elyaaígíí baa yinísht'į́&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki baa yinísht'į́&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Aná'álwo'&quot;, &quot;Aná'álwo' baa yinísht'į́&quot;, &quot;T'ááłáhági át'éego&quot;, &quot;T'ááłáhági át'éego baa yinísht'į́&quot;],
    &quot;oc&quot;: [&quot;Especial&quot;, &quot;Discutir&quot;, &quot;Utilisator&quot;, &quot;Discutida Utilisator&quot;, &quot;Oiquipedià&quot;, &quot;Discutida Oiquipedià&quot;, &quot;Image&quot;, &quot;Discutida Image&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, m, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;os&quot;: [m, &quot;Сæрмагонд&quot;, &quot;Дискусси&quot;, &quot;Архайæг&quot;, &quot;Архайæджы дискусси&quot;, &quot;Wikipedia&quot;, &quot;0&quot;, &quot;Ныв&quot;, &quot;Нывы тыххæй дискусси&quot;, &quot;MediaWiki&quot;, &quot;Дискусси MediaWiki&quot;, &quot;Шаблон&quot;, &quot;Шаблоны тыххæй дискусси&quot;, &quot;Æххуыс&quot;, &quot;Æххуысы тыххæй дискусси&quot;, &quot;Категори&quot;, &quot;Категорийы тыххæй дискусси&quot;],
    &quot;pa&quot;: [&quot;ਮੀਡੀਆ&quot;, &quot;ਖਾਸ&quot;, &quot;ਚਰਚਾ&quot;, &quot;ਮੈਂਬਰ&quot;, &quot;ਮੈਂਬਰ ਚਰਚਾ&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia ਚਰਚਾ&quot;, &quot;ਤਸਵੀਰ&quot;, &quot;ਤਸਵੀਰ ਚਰਚਾ&quot;, &quot;ਮੀਡੀਆਵਿਕਿ&quot;, &quot;ਮੀਡੀਆਵਿਕਿ ਚਰਚਾ&quot;, &quot;ਨਮੂਨਾ&quot;, &quot;ਨਮੂਨਾ ਚਰਚਾ&quot;, &quot;ਮਦਦ&quot;, &quot;ਮਦਦ ਚਰਚਾ&quot;, &quot;ਸ਼੍ਰੇਣੀ&quot;, &quot;ਸ਼੍ਰੇਣੀ ਚਰਚਾ&quot;],
    &quot;pl&quot;: [m, &quot;Specjalna&quot;, &quot;Dyskusja&quot;, &quot;Wikipedysta&quot;, &quot;Dyskusja Wikipedysty&quot;, &quot;Wikipedia&quot;, &quot;Dyskusja Wikipedii&quot;, &quot;Grafika&quot;, &quot;Dyskusja grafiki&quot;, &quot;MediaWiki&quot;, &quot;Dyskusja MediaWiki&quot;, &quot;Szablon&quot;, &quot;Dyskusja szablonu&quot;, &quot;Pomoc&quot;, &quot;Dyskusja pomocy&quot;, &quot;Kategoria&quot;, &quot;Dyskusja kategorii&quot;, &quot;Portal&quot;, &quot;Dyskusja portalu&quot;],
    &quot;pt&quot;: [m, &quot;Especial&quot;, &quot;Discussão&quot;, &quot;Usuário&quot;, &quot;Usuário Discussão&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Discussão&quot;, &quot;Imagem&quot;, &quot;Imagem Discussão&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Discussão&quot;, &quot;Predefinição&quot;, &quot;Predefinição Discussão&quot;, &quot;Ajuda&quot;, &quot;Ajuda Discussão&quot;, &quot;Categoria&quot;, &quot;Categoria Discussão&quot;],
    &quot;ro&quot;: [m, &quot;Special&quot;, &quot;Discuţie&quot;, &quot;Utilizator&quot;, &quot;Discuţie Utilizator&quot;, &quot;Wikipedia&quot;, &quot;Discuţie Wikipedia&quot;, &quot;Imagine&quot;, &quot;Discuţie Imagine&quot;, &quot;MediaWiki&quot;, &quot;Discuţie MediaWiki&quot;, &quot;Format&quot;, &quot;Discuţie Format&quot;, &quot;Ajutor&quot;, &quot;Discuţie Ajutor&quot;, &quot;Categorie&quot;, &quot;Discuţie Categorie&quot;],
    &quot;ru&quot;: [&quot;Медиа&quot;, &quot;Служебная&quot;, &quot;Обсуждение&quot;, &quot;Участник&quot;, &quot;Обсуждение участника&quot;, &quot;Википедия&quot;, &quot;Обсуждение Википедии&quot;, &quot;Изображение&quot;, &quot;Обсуждение изображения&quot;, &quot;MediaWiki&quot;, &quot;Обсуждение MediaWiki&quot;, &quot;Шаблон&quot;, &quot;Обсуждение шаблона&quot;, &quot;Справка&quot;, &quot;Обсуждение справки&quot;, &quot;Категория&quot;, &quot;Обсуждение категории&quot;],
    &quot;sc&quot;: [&quot;Speciale&quot;, &quot;Contièndha&quot;, &quot;Utente&quot;, &quot;Utente discussioni&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia discussioni&quot;, &quot;Immàgini&quot;, &quot;Immàgini contièndha&quot;, m, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;sk&quot;: [&quot;Médiá&quot;, &quot;Špeciálne&quot;, &quot;Diskusia&quot;, &quot;Redaktor&quot;, &quot;Diskusia s redaktorom&quot;, &quot;Wikipédia&quot;, &quot;Diskusia k Wikipédii&quot;, &quot;Obrázok&quot;, &quot;Diskusia k obrázku&quot;, &quot;MediaWiki&quot;, &quot;Diskusia k MediaWiki&quot;, &quot;Šablóna&quot;, &quot;Diskusia k šablóne&quot;, &quot;Pomoc&quot;, &quot;Diskusia k pomoci&quot;, &quot;Kategória&quot;, &quot;Diskusia ku kategórii&quot;],
    &quot;sl&quot;: [m, &quot;Posebno&quot;, &quot;Pogovor&quot;, &quot;Uporabnik&quot;, &quot;Uporabniški pogovor&quot;, &quot;Wikipedija&quot;, &quot;Pogovor k Wikipediji&quot;, &quot;Slika&quot;, &quot;Pogovor k sliki&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;sq&quot;: [m, &quot;Speciale&quot;, &quot;Diskutim&quot;, &quot;Përdoruesi&quot;, &quot;Përdoruesi diskutim&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia diskutim&quot;, &quot;Figura&quot;, &quot;Figura diskutim&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskutim&quot;, &quot;Stampa&quot;, &quot;Stampa diskutim&quot;, &quot;Ndihmë&quot;, &quot;Ndihmë diskutim&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;sr&quot;: [m, &quot;Посебно&quot;, &quot;Разговор&quot;, &quot;Корисник&quot;, &quot;Разговор са корисником&quot;, &quot;Википедија&quot;, &quot;Разговор о Википедији&quot;, &quot;Слика&quot;, &quot;Разговор о слици&quot;, &quot;МедијаВики&quot;, &quot;Разговор о МедијаВикију&quot;, &quot;Шаблон&quot;, &quot;Разговор о шаблону&quot;, &quot;Помоћ&quot;, &quot;Разговор о помоћи&quot;, &quot;Категорија&quot;, &quot;Разговор о категорији&quot;, &quot;Портал&quot;, &quot;Разговор о порталу&quot;],
    &quot;sv&quot;: [m, &quot;Special&quot;, &quot;Diskussion&quot;, &quot;Användare&quot;, &quot;Användardiskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipediadiskussion&quot;, &quot;Bild&quot;, &quot;Bilddiskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskussion&quot;, &quot;Mall&quot;, &quot;Malldiskussion&quot;, &quot;Hjälp&quot;, &quot;Hjälp diskussion&quot;, &quot;Kategori&quot;, &quot;Kategoridiskussion&quot;],
    &quot;ta&quot;: [&quot;ஊடகம்&quot;, &quot;சிறப்பு&quot;, &quot;பேச்சு&quot;, &quot;பயனர்&quot;, &quot;பயனர் பேச்சு&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia பேச்சு&quot;, &quot;படிமம்&quot;, &quot;படிமப் பேச்சு&quot;, &quot;மீடியாவிக்கி&quot;, &quot;மீடியாவிக்கி பேச்சு&quot;, &quot;வார்ப்புரு&quot;, &quot;வார்ப்புரு பேச்சு&quot;, &quot;உதவி&quot;, &quot;உதவி பேச்சு&quot;, &quot;பகுப்பு&quot;, &quot;பகுப்பு பேச்சு&quot;],
    &quot;th&quot;: [m, &quot;พิเศษ&quot;, &quot;พูดคุย&quot;, &quot;ผู้ใช้&quot;, &quot;คุยเกี่ยวกับผู้ใช้&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia talk&quot;, &quot;ภาพ&quot;, &quot;คุยเกี่ยวกับภาพ&quot;, &quot;MediaWiki&quot;, &quot;คุยเกี่ยวกับ MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;],
    &quot;tlh&quot;: [&quot;Doch&quot;, &quot;le'&quot;, &quot;ja'chuq&quot;, &quot;lo'wI'&quot;, &quot;lo'wI' ja'chuq&quot;, &quot;wIqIpe'DIya&quot;, &quot;wIqIpe'DIya ja'chuq&quot;, &quot;nagh beQ&quot;, &quot;nagh beQ ja'chuq&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki ja'chuq&quot;, &quot;chen'ay'&quot;, &quot;chen'ay' ja'chuq&quot;, &quot;QaH&quot;, &quot;QaH ja'chuq&quot;, &quot;Segh&quot;, &quot;Segh ja'chuq&quot;],
    &quot;tr&quot;: [m, &quot;Özel&quot;, &quot;Tartışma&quot;, &quot;Kullanıcı&quot;, &quot;Kullanıcı mesaj&quot;, &quot;Vikipedi&quot;, &quot;Vikipedi tartışma&quot;, &quot;Resim&quot;, &quot;Resim tartışma&quot;, &quot;MedyaViki&quot;, &quot;MedyaViki tartışma&quot;, &quot;Şablon&quot;, &quot;Şablon tartışma&quot;, &quot;Yardım&quot;, &quot;Yardım tartışma&quot;, &quot;Kategori&quot;, &quot;Kategori tartışma&quot;],
    &quot;tt&quot;: [m, &quot;Maxsus&quot;, &quot;Bäxäs&quot;, &quot;Äğzä&quot;, &quot;Äğzä bäxäse&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia bäxäse&quot;, &quot;Räsem&quot;, &quot;Räsem bäxäse&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki bäxäse&quot;, &quot;Ürnäk&quot;, &quot;Ürnäk bäxäse&quot;, &quot;Yärdäm&quot;, &quot;Yärdäm bäxäse&quot;, &quot;Törkem&quot;, &quot;Törkem bäxäse&quot;],
    &quot;uk&quot;: [&quot;Медіа&quot;, &quot;Спеціальні&quot;, &quot;Обговорення&quot;, &quot;Користувач&quot;, &quot;Обговорення користувача&quot;, &quot;Wikipedia&quot;, &quot;Обговорення Wikipedia&quot;, &quot;Зображення&quot;, &quot;Обговорення зображення&quot;, &quot;MediaWiki&quot;, &quot;Обговорення MediaWiki&quot;, &quot;Шаблон&quot;, &quot;Обговорення шаблону&quot;, &quot;Довідка&quot;, &quot;Обговорення довідки&quot;, &quot;Категорія&quot;, &quot;Обговорення категорії&quot;],
    &quot;vi&quot;: [&quot;Phương tiện&quot;, &quot;Đặc biệt&quot;, &quot;Thảo luận&quot;, &quot;Thành viên&quot;, &quot;Thảo luận Thành viên&quot;, &quot;Wikipedia&quot;, &quot;Thảo luận Wikipedia&quot;, &quot;Hình&quot;, &quot;Thảo luận Hình&quot;, &quot;MediaWiki&quot;, &quot;Thảo luận MediaWiki&quot;, &quot;Tiêu bản&quot;, &quot;Thảo luận Tiêu bản&quot;, &quot;Trợ giúp&quot;, &quot;Thảo luận Trợ giúp&quot;, &quot;Thể loại&quot;, &quot;Thảo luận Thể loại&quot;],
    &quot;wa&quot;: [m, &quot;Sipeciås&quot;, &quot;Copene&quot;, &quot;Uzeu&quot;, &quot;Uzeu copene&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia copene&quot;, &quot;Imådje&quot;, &quot;Imådje copene&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki copene&quot;, &quot;Modele&quot;, &quot;Modele copene&quot;, &quot;Aidance&quot;, &quot;Aidance copene&quot;, &quot;Categoreye&quot;, &quot;Categoreye copene&quot;]
  }
  pg.ns.list = nsLists[pg.wiki.lang] || list;
}

function namespaceListToRegex(list) {return RegExp('^('+list.join('|').split(' ').join('[ _]')+'):');};
// function setNamespaceList is ugly as sin, moved to later in the code

function setNamespaces() {
  setNamespaceList();
  pg.ns.withTalkList=[null]; // NB root (article) corresponds with this entry, null
  pg.ns.talkList=[pg.ns.list[2]];

  // if the number of namespaces changes then this will have to be changed
  // maybe the easiest way is to specify the arrays by hand as in the comments following the loop

  for (var i=3; i+1&lt;pg.ns.list.length; i=i+2) {
    pg.ns.withTalkList.push(pg.ns.list[i]);
    pg.ns.talkList.push(pg.ns.list[i+1]);
  }

  // ALERT! SILLY HARDCODED VALUES FOLLOW!
  pg.ns.special   = pg.ns.list[1];
  pg.ns.image     = pg.ns.list[7];
  pg.ns.user      = pg.ns.list[3];
  pg.ns.category  = pg.ns.list[15];
  pg.ns.nonArticleList=pg.ns.list.slice(0,2).concat(pg.ns.list.slice(2));
}


function setRedirs() {
  var r='redirect';
  var R='REDIRECT';
  var redirLists={
    'be':  [ r, 'перанакіраваньне' ],
    'bg':  [ r, 'пренасочване', 'виж' ],
    'cs':  [ R, 'PŘESMĚRUJ' ],
    'cy':  [ r, 'ail-cyfeirio' ],
    'et':  [ r, 'suuna' ],
    'ga':  [ r, 'athsheoladh' ],
    'is':  [ 'tilvísun', 'TILVÍSUN', r ],
    'mk':  [ r, 'пренасочување', 'види' ],
    'nds': [ r, 'wiederleiden' ],
    'nn':  [ r, 'omdiriger' ],
    'pt':  [ R, 'redir' ],
    'ru':  [ R, 'ПЕРЕНАПРАВЛЕНИЕ', 'ПЕРЕНАПР'],
    'sk':  [ r, 'presmeruj' ],
    'sr':  [ 'Преусмери', r, 'преусмери', 'ПРЕУСМЕРИ' ],
    'tt':  [ 'yünältü' ],
    'vi':  [ r , 'đổi' ] // no comma
  }
  var redirList=redirLists[ pg.wiki.lang ] || [r, R];
  // Mediawiki is very tolerant about what comes after the #redirect at the start
  pg.re.redirect=RegExp('^\\s*[#](' + redirList.join('|') + ').*?\\[{2}([^\\|\\]]*)(|[^\\]]*)?\\]{2}\\s*(.*)', 'i');
}

function setInterwiki() {
  if (pg.wiki.wikimedia) {
    pg.wiki.interwiki='aa|ab|af|ak|als|am|an|ang|ar|arc|as|ast|av|ay|az|ba|be|ber|bg|bh|bi|bm|bn|bdf|bo|br|bs|ca|ce|ceb|ch|cho|chr|chy|co|commons|cr|cs|csb|cu|cv|cy|da|de|dv|dz|el|en|eo|es|et|eu|fa|ff|fi|fiu-vro|fj|fo|fr|fur|fy|ga|gd|gil|gl|gn|got|gu|gv|ha|haw|he|hi|ho|hr|ht|hu|hy|hz|ia|id|ie|ig|ii|ik|io|is|it|iu|ja|jbo|jv|ka|kg|ki|kj|kk|kl|km|kn|ko|kr|ks|ku|kv|kw|ky|la|lad|lan|lb|lg|li|ln|lo|lt|lu|lv|mg|mh|mi|mk|ml|mn|mo|mr|ms|mt|mus|my|na|nah|nap|nb|nd|nds|ne|ng|nl|nn|no|nr|nv|ny|oc|oj|om|or|os|pa|pam|pi|pl|ps|pt|qu|rm|rn|ro|roa-rup|ru|rw|sa|sc|scn|sco|sd|se|sg|sh|si|simple|sk|sl|sm|smg|sn|so|sq|sr|ss|st|su|sv|sw|ta|te|tg|th|ti|tk|tl|tlh|tn|to|tpi|tr|ts|tt|tum|tw|ty|ug|uk|ur|uz|ve|vi|vk|vo|wa|war|wen|wo|xh|yi|yo|za|zh|zh-min-nan|zu';
    pg.re.interwiki=RegExp('^'+pg.wiki.interwiki+':');
  } else {
    pg.wiki.interwiki=null;
    pg.re.interwiki=RegExp('^$');
  }
}

// ENDFILE: namespaces.js
// STARTFILE: selpop.js
window.getEditboxSelection=function() {
  // see http://www.webgurusforum.com/8/12/0
  try {
    var editbox=document.editform.wpTextbox1;
  } catch (dang) { return; }
  // IE, Opera
  if (document.selection) { return document.selection.createRange().text; }
  // Mozilla
  var selStart = editbox.selectionStart;
  var selEnd = editbox.selectionEnd;
  return (editbox.value).substring(selStart, selEnd);
}
window.doSelectionPopup=function() {
  // popup if the selection looks like [[foo|anything afterwards at all
  // or [[foo|bar]]text without ']]'
  // or [[foo|bar]]
  var sel=getEditboxSelection();
  var open=sel.indexOf('[[');  var pipe=sel.indexOf('|');  var close=sel.indexOf(']]');
  if (open == -1 || ( pipe == -1 &amp;&amp; close == -1) ) return;
  if (pipe != -1 &amp;&amp; open &gt; pipe || close != -1 &amp;&amp; open &gt; close) return;
  var article=sel.substring(open+2, (pipe &lt; 0) ? close : pipe);
  if (close &gt; 0 &amp;&amp; sel.substring(close+2).indexOf('[[') &gt;= 0) return;
  var a=document.createElement('a');
  a.href=pg.wiki.titlebase + article;
  mouseOverWikiLink2(a);
  //mouseOutWikiLink.apply(a, []);
  if (a.navpopup) {
    a.navpopup.addHook(function(){runStopPopupTimer(a.navpopup);}, 'unhide', 'after');
  }
}

// ENDFILE: selpop.js
// STARTFILE: navpopup.js
/**
   @fileoverview  Defines two classes: {@link Navpopup} and {@link Mousetracker}.

   &lt;code&gt;Navpopup&lt;/code&gt; describes popups: when they appear, where, what
   they look like and so on.

   &lt;code&gt;Mousetracker&lt;/code&gt; &quot;captures&quot; the mouse using
   &lt;code&gt;document.onmousemove&lt;/code&gt;.
*/


/**
    Creates a new Mousetracker.
    @constructor
    @class The Mousetracker class. This monitors mouse movements and manages associated hooks.
*/
function Mousetracker() {
  /**
     Flag - are we switched on?
     @type Boolean
   */
  this.active=false;
  /**
      Array of hook functions.
      @private
      @type Array
  */
  this.hooks=[];
}

/**
   Adds a hook, to be called when we get events.
   @param {Function} f A function which is called as
   &lt;code&gt;f(x,y)&lt;/code&gt;. It should return &lt;code&gt;true&lt;/code&gt; when it
   wants to be removed, and &lt;code&gt;false&lt;/code&gt; otherwise.
*/
Mousetracker.prototype.addHook = function (f) {
  this.hooks.push(f);
};

/**
   Runs hooks, passing them the x
   and y coords of the mouse.  Hook functions that return true are
   passed to {@link Mousetracker#removeHooks} for removal.
   @private
*/
Mousetracker.prototype.runHooks = function () {
  var remove=false;
  var removeObj={};
  // this method gets called a LOT -
  // pre-cache some variables
  var x=this.x, y=this.y, len = this.hooks.length;

  for (var i=0; i&lt;len; ++i) {
    //~ run the hook function, and remove it if it returns true
    if (this.hooks[i](x, y)===true) {
      remove=true;
      removeObj[i]=true;
    }
  }
  if (remove) { this.removeHooks(removeObj); }
};

/**
   Removes hooks.
   @private
   @param {Object} removeObj An object whose keys are the index
   numbers of functions for removal, with values that evaluate to true
*/
Mousetracker.prototype.removeHooks = function(removeObj) {
  var newHooks=[];
  var len = this.hooks.length;
  for (var i=0; i&lt;len; ++i) {
    if (! removeObj[i]) { newHooks.push(this.hooks[i]); }
  }
  this.hooks=newHooks;
};


/**
   Event handler for mouse wiggles.
   We simply grab the event, set x and y and run the hooks.
   This makes the cpu all hot and bothered :-(
   @private
   @param {Event} e Mousemove event
*/
Mousetracker.prototype.track=function (e) {
  //log ('Mousetracker.track');
  //~ Apparently this is needed in IE.
  e = e || window.event;
  var x, y;
  if (e) {
    if (e.pageX) { x=e.pageX; y=e.pageY; }
    else if (typeof e.clientX!='undefined') {
      var left, top, docElt = window.document.documentElement;

      if (docElt) { left=docElt.scrollLeft; }
      left = left || window.document.body.scrollLeft || window.document.scrollLeft || 0;

      if (docElt) { top=docElt.scrollTop; }
      top = top || window.document.body.scrollTop || window.document.scrollTop || 0;

      x=e.clientX + left;
      y=e.clientY + top;
    } else { return; }
    this.x = x;
    this.y = y;
    if (this.hooks.length === 0) { return; }
    if (typeof this.lastHook_x != 'number') { this.lastHook_x = -100; this.lastHook_y=-100; }
    var diff = (this.lastHook_x - x)*(this.lastHook_y - y);
    diff = (diff &gt;= 0) ? diff : -diff;
    if ( diff &gt; 1 ) {
      this.lastHook_x=x;
      this.lastHook_y=y;
      this.runHooks();
    }
  }
};

/**
    Sets things in motion, unless they are already that is, registering an event handler on &lt;code&gt;document.onmousemove&lt;/code&gt;.
    A half-hearted attempt is made to preserve the old event handler if there is one.
*/
Mousetracker.prototype.enable = function () {
  if (this.active) { return; }
  this.active=true;
  //~ Save the current handler for mousemove events. This isn't too
  //~ robust, of course.
  this.savedHandler=document.onmousemove;
  //~ Gotta save @tt{this} again for the closure, and use apply for
  //~ the member function.
  var savedThis=this;
  document.onmousemove=function (e) {savedThis.track.apply(savedThis, [e]);};
};

/**
   Disables the tracker, removing the event handler.
*/
Mousetracker.prototype.disable = function () {
  if (!this.active) { return; }
  if (typeof this.savedHandler=='function') {
    document.onmousemove=this.savedHandler;
  } else { delete document.onmousemove; }
  this.active=false;
};

/**
   Creates a new Navpopup.
   Gets a UID for the popup and
   @param init Contructor object. If &lt;code&gt;init.draggable&lt;/code&gt; is true or absent, the popup becomes draggable.
   @constructor
   @class The Navpopup class. This generates popup hints, and does some management of them.
*/
function Navpopup(init) {
  //alert('new Navpopup(init)');
  /** UID for each Navpopup instance.
      Read-only.
      @type integer
   */
  this.uid=Navpopup.uid++;
  /**
     Read-only flag for current visibility of the popup.
     @type boolean
     @private
   */
  this.visible=false;
  /** Flag to be set when we want to cancel a previous request to
      show the popup in a little while.
      @private
      @type boolean
  */
  this.noshow=false;
  /** Categorised list of hooks.
      @see #runHooks
      @see #addHook
      @private
      @type Object
  */
  this.hooks={
    'create': [],
    'unhide': [],
    'hide': []
  };
  /** List of downloads associated with the popup.
      @private
      @type Array
   */
  this.downloads=[];
  /** Number of uncompleted downloads.
      @type integer
  */
  this.pending=null;
  /** Tolerance in pixels when detecting whether the mouse has left the popup.
      @type integer
   */
  this.fuzz=5;
  /** Flag to toggle running {@link #limitHorizontalPosition} to regulate the popup's position.
      @type boolean
  */
  this.constrained=true;
  /** The popup width in pixels.
      @private
      @type integer
  */
  this.width=0;
  /** The popup width in pixels.
      @private
      @type integer
  */
  this.height=0;
  /** The main content DIV element.
      @type HTMLDivElement
  */
  this.mainDiv=null;
  this.createMainDiv();

  if (!init || typeof init.draggable=='undefined' || init.draggable) {
    this.makeDraggable();
  }
}

/**
   A UID for each Navpopup. This constructor property is just a counter.
   @type integer
   @private
*/
Navpopup.uid=0;

/**
   Retrieves the {@link #visible} attribute, indicating whether the popup is currently visible.
   @type boolean
*/
Navpopup.prototype.isVisible=function() {
  return this.visible;
};

/**
   Repositions popup using CSS style.
   @private
   @param {integer} x x-coordinate (px)
   @param {integer} y y-coordinate (px)
   @param {boolean} noLimitHor Don't call {@link #limitHorizontalPosition}
*/
Navpopup.prototype.reposition= function (x,y, noLimitHor) {
  log ('reposition('+x+','+y+','+noLimitHor+')');
  if (typeof x != 'undefined' &amp;&amp; x!==null) { this.left=x; }
  if (typeof y != 'undefined' &amp;&amp; y!==null) { this.top=y; }
  if (typeof this.left != 'undefined' &amp;&amp; typeof this.top != 'undefined') {
    this.mainDiv.style.left=this.left + 'px';
    this.mainDiv.style.top=this.top + 'px';
  }
  if (!noLimitHor) { this.limitHorizontalPosition(); }
};

/**
   Prevents popups from being in silly locations. Hopefully.
   Should not be run if {@link #constrained} is true.
   @private
*/
Navpopup.prototype.limitHorizontalPosition=function() {
  if (!this.constrained || this.tooWide) { return; }
  //var x=this.left; //findPosX(this.mainDiv);
  var x=parseInt(this.mainDiv.style.left, 10);
  var w=parseInt(this.mainDiv.offsetWidth, 10);
  var cWidth=document.body.clientWidth;
  log('limitHorizontalPosition: x='+x+
      ', this.left=' + this.left +
      ', this.width=' + this.width +
      ', cWidth=' + cWidth);
  if ( (x+w) &gt;= cWidth ||
       ( x &gt; 0 &amp;&amp; this.maxWidth &amp;&amp; this.width &lt; this.maxWidth &amp;&amp; this.height &gt; this.width
	 &amp;&amp; x &gt; cWidth - this.maxWidth ) ) {
    // This is a very nasty hack. There has to be a better way!
    // We find the &quot;natural&quot; width of the div by positioning it at the far left
    // then reset it so that it should be flush right (well, nearly)
    this.mainDiv.style.left='-10000px';
    this.mainDiv.style.width = this.maxWidth + 'px';
    var naturalWidth=parseInt(this.mainDiv.offsetWidth, 10);
    var newLeft=cWidth - naturalWidth - 1;
    if (newLeft &lt; 0) { newLeft = 0; this.tooWide=true; } // still unstable for really wide popups?
    log ('limitHorizontalPosition: moving to ('+newLeft + ','+ this.top+');' +
	 ' naturalWidth=' + naturalWidth + ', clientWidth=' + cWidth);
    this.reposition(newLeft, null, true);
  }
};

/**
 Counter indicating the z-order of the &quot;highest&quot; popup.
 We start the z-index at 1000 so that popups are above everything
 else on the screen.
 @private
 @type integer
*/
Navpopup.highest=1000;

/**
 Brings popup to the top of the z-order.
 We increment the {@link #highest} property of the contructor here.
 @private
*/
Navpopup.prototype.raise = function () {
  this.mainDiv.style.zIndex=Navpopup.highest + 1;
  ++Navpopup.highest;
};

/**
   Shows the popup provided {@link #noshow} is not true.
   Updates the position, brings the popup to the top of the z-order and unhides it.
*/
Navpopup.prototype.show = function () {
  //document.title+='s';
  if (this.noshow) { return; }
  //document.title+='t';
  this.reposition();
  this.raise();
  this.unhide();
};


/**
    Runs the {@link #show} method in a little while, unless we're
    already visible.
    @param {integer} time Delay in milliseconds
    @see #showSoonIfStable
*/
Navpopup.prototype.showSoon = function (time) {
  if (this.visible) { return; }
  this.noshow=false;
  //~ We have to save the value of @tt{this} so that the closure below
  //~ works.
  var savedThis=this;
  //this.start_x = Navpopup.tracker.x;
  //this.start_y = Navpopup.tracker.y;
  pop.runOnce(function () {
    if (Navpopup.tracker.active) {
      savedThis.reposition.apply(savedThis, [Navpopup.tracker.x + 2, Navpopup.tracker.y + 2]);
    }
    //~ Have to use apply to invoke his member function here
    savedThis.show.apply(savedThis, []);
  }, time);
};

/**
 Checks to see if the mouse pointer has
 stabilised (checking every &lt;code&gt;time&lt;/code&gt;/2 milliseconds) and runs the
 {@link #show} method if it has. This method makes {@link #showSoon} redundant.
 @param {integer} time The minimum time (ms) before the popup may be shown.
*/
Navpopup.prototype.showSoonIfStable = function (time) {
  log ('showSoonIfStable, time='+time);
  if (this.visible) { return; }
  this.noshow = false;

  //~ initialize these variables so that we never run @tt{show} after
  //~ just half the time
  this.stable_x = -10000; this.stable_y = -10000;

  var stableShow = function() {
    log('stableShow called');
    var new_x = Navpopup.tracker.x, new_y = Navpopup.tracker.y;
    var dx = savedThis.stable_x - new_x, dy = savedThis.stable_y - new_y;
    var fuzz2 = 0; // savedThis.fuzz * savedThis.fuzz;
    //document.title += '[' + [savedThis.stable_x,new_x, savedThis.stable_y,new_y, dx, dy, fuzz2].join(',') + '] ';
    if ( dx * dx &lt;= fuzz2 &amp;&amp; dy * dy &lt;= fuzz2 ) {
      log ('mouse is stable');
      clearInterval(savedThis.showSoonStableTimer);
      savedThis.reposition.apply(savedThis, [new_x + 2, new_y + 2]);
      savedThis.show.apply(savedThis, []);
      return;
    }
    savedThis.stable_x = new_x; savedThis.stable_y = new_y;
  };
  var savedThis = this;
  this.showSoonStableTimer = setInterval(stableShow, time/2);
};

/**
    Makes the popup unhidable until we call {@link #unstick}.
 */
Navpopup.prototype.stick=function() {
  this.noshow=false;
  this.sticky=true;
};

/**
    Allows the popup to be hidden.
 */
Navpopup.prototype.unstick=function() {
  this.sticky=false;
};

/**
   Sets the {@link #noshow} flag and hides the popup. This should be called
   when the mouse leaves the link before
   (or after) it's actually been displayed.
*/
Navpopup.prototype.banish = function () {
  log ('banish called');
  // hide and prevent showing with showSoon in the future
  this.noshow=true;
  if (this.showSoonStableTimer) {
    log('clearing showSoonStableTimer');
    clearInterval(this.showSoonStableTimer);
  }
  this.hide();
};

/**
   Runs hooks added with {@link #addHook}.
   @private
   @param {String} key Key name of the {@link #hooks} array - one of 'create', 'unhide', 'hide'
   @param {String} when Controls exactly when the hook is run: either 'before' or 'after'
*/
Navpopup.prototype.runHooks = function (key, when) {
  if (!this.hooks[key]) { return; }
  var keyHooks=this.hooks[key];
  var len=keyHooks.length;
  for (var i=0; i&lt; len; ++i) {
    if (keyHooks[i].when == when) { keyHooks[i].hook.apply(this, []); }
  }
};

/**
   Adds a hook to the popup. Hook functions are run with &lt;code&gt;this&lt;/code&gt; set to refer to the Navpopup instance, and no arguments.
   @param {Function} hook The hook function.
   @param {String} key Key name of the {@link #hooks} array - one of 'create', 'unhide', 'hide'
   @param {String} when Controls exactly when the hook is run: either 'before' or 'after'
*/
Navpopup.prototype.addHook = function ( hook, key, when ) {
  when = when || 'after';
  if (!this.hooks[key]) { return; }
  this.hooks[key].push( {hook: hook, when: when} );
};

/**
   Creates the main DIV element, which contains all the actual popup content.
   Runs hooks with key 'create'.
   @private
*/
Navpopup.prototype.createMainDiv = function () {
  if (this.mainDiv) { return; }
  this.runHooks('create', 'before');
  var mainDiv=document.createElement('div');

  var savedThis=this;
  mainDiv.onclick=function(e) {savedThis.onclickHandler(e);};
  mainDiv.className=(this.className) ? this.className : 'navpopup_maindiv';
  mainDiv.id=mainDiv.className + this.uid;

  mainDiv.style.position='absolute';
  mainDiv.style.display='none';
  mainDiv.className='navpopup';

  // easy access to javascript object through DOM functions
  mainDiv.navpopup=this;

  this.mainDiv=mainDiv;
  document.body.appendChild(mainDiv);
  this.runHooks('create', 'after');
};
/**
   Calls the {@link #raise} method.
   @private
*/
Navpopup.prototype.onclickHandler=function(e) {
  this.raise();
};
/**
   Makes the popup draggable, using a {@link Drag} object.
   @private
*/
Navpopup.prototype.makeDraggable=function(e) {
  if (!this.mainDiv) { this.createMainDiv(); }
  var drag=new Drag();
  drag.startCondition=function(e) {
    try { if (!e.shiftKey) { return false; } } catch (err) { return false; }
    return true;
  };
  var np=this;
  drag.endHook=function(x,y) { np.reposition(x,y); };
  drag.init(this.mainDiv);
};

/** Hides the popup using CSS. Runs hooks with key 'hide'.
    Sets {@link #visible} appropriately.     {@link #banish} should be called externally instead of this method.

    @private
*/
Navpopup.prototype.hide = function () {
  this.runHooks('hide', 'before');
  this.abortDownloads();
  if (this.sticky) { return; }
  if (typeof this.visible != 'undefined' &amp;&amp; this.visible) {
    this.mainDiv.style.display='none';
    this.visible=false;
  }
  this.runHooks('hide', 'after');
};

/** Shows the popup using CSS. Runs hooks with key 'unhide'.
    Sets {@link #visible} appropriately.   {@link #show} should be called externally instead of this method.
    @private
*/
Navpopup.prototype.unhide = function () {
  this.runHooks('unhide', 'before');
  if (typeof this.visible != 'undefined' &amp;&amp; !this.visible) {
    this.mainDiv.style.display='inline';
    this.visible=true;
  }
  this.runHooks('unhide', 'after');
};

/**
 Sets the &lt;code&gt;innerHTML&lt;/code&gt; attribute of the main div containing the popup content.
 @param {String} html The HTML to set.
*/
Navpopup.prototype.setInnerHTML = function (html) {
  this.mainDiv.innerHTML = html;
};

/**
   Updates the {@link #width} and {@link #height} attributes with the CSS properties.
   @private
*/
Navpopup.prototype.updateDimensions = function () {
  this.width=parseInt(this.mainDiv.offsetWidth, 10);
  this.height=parseInt(this.mainDiv.offsetHeight, 10);
};

/**
   Checks if the point (x,y) is within {@link #fuzz} of the
   {@link #mainDiv}.
   @param {integer} x x-coordinate (px)
   @param {integer} y y-coordinate (px)
   @type boolean
*/
Navpopup.prototype.isWithin = function(x,y) {
  //~ If we're not even visible, no point should be considered as
  //~ being within the popup.
  if (!this.visible) { return false; }
  this.updateDimensions();
  var fuzz=this.fuzz || 0;
  //  document.title=''+fuzz+';'+x+';'+y+'|'+this.left+','+(this.left+this.width)+';'+this.top+','+(this.top+this.height);
  //~ Use a simple box metric here.
  return (x+fuzz &gt;= this.left &amp;&amp; x-fuzz &lt;= this.left + this.width &amp;&amp;
	  y+fuzz &gt;= this.top  &amp;&amp; y-fuzz &lt;= this.top  + this.height);
};

/**
   Adds a download to {@link #downloads}.
   @param {Downloader} download
*/
Navpopup.prototype.addDownload=function(download) {
  if (!download) { return; }
  this.downloads.push(download);
};
/**
    Aborts the downloads listed in {@link #downloads}.
    @see Downloader#abort
*/
Navpopup.prototype.abortDownloads=function() {
  for(var i=0; i&lt;this.downloads.length; ++i) {
    var d=this.downloads[i];
    if (d &amp;&amp; d.abort) { d.abort(); }
  }
  this.downloads=[];
}


/**
 A {@link Mousetracker} instance which is a property of the constructor (pseudo-global).
*/
Navpopup.tracker=new Mousetracker();

// ENDFILE: navpopup.js
// STARTFILE: diff.js
/*
 * Javascript Diff Algorithm
 *  By John Resig (http://ejohn.org/) and [[:en:User:Lupin]]
 *
 * More Info:
 *  http://ejohn.org/projects/javascript-diff-algorithm/
 */

function diffEscape(n) {
    return n.replace(/&amp;/g, &quot;&amp;amp;&quot;).replace(/&lt;/g, &quot;&amp;lt;&quot;).replace(/&gt;/g, &quot;&amp;gt;&quot;).replace(RegExp('&quot;','g'), &quot;&amp;quot;&quot;);
}
function delFmt(x) {
  if (!x.length) { return ''; }
  return &quot;&lt;del style='background:#FFE6E6;'&gt;&quot; + /*diffEscape*/(x.join('')).split('\n').join('&amp;para;\n') +&quot;&lt;/del&gt;&quot;;
}
function insFmt(x) {
  if (!x.length) { return ''; }
  return &quot;&lt;ins style='background:#AAFFEE;'&gt;&quot; + /*diffEscape*/(x.join('')).split('\n').join('&amp;para;\n') +&quot;&lt;/ins&gt;&quot;;
}

function copyDiffObj(x){
  var ret=[];
  for (var i=0; i&lt;x.length; ++i) {
    if (typeof x[i] == 'string') { ret[i]=x[i]; }
    else {
      ret[i]={};
      for (var prop in x[i]) { ret[i][prop]=x[i][prop]; }
    }
  }
  return ret;
}

function countCrossings(a, b, i, eject) {
  // count the crossings on the edge starting at b[i]
  if (b[i].row==null) { return -1; }
  var count=0;
  for (var j=0; j&lt;a.length; ++j) {
    if (!a[j].row || a[j].row === 0) { continue; }
    if ( (j-b[i].row)*(i-a[j].row) &gt; 0) {
      if(eject) { return true; }
      count++;
    }
  }
  return count;
}

//de=document.createElement('div');
//de.id='debug'
//ti=document.getElementsByTagName('h1')[0];
//ti.parentNode.appendChild(de);

//function debug(s){
//  try {document.getElementById('debug').innerHTML+=s+'&lt;br&gt;'; } catch(foo) {};
//}

function untangle( a, b) {
  // try to remove crossing edges from an ordered bipartite graph,
  // removing the least number possible
  var aa=copyDiffObj(a);
  var bb=copyDiffObj(b);

  // remove the edge with the largest number of crossings until no
  // crossings remain
  do {
    var maxCrossings=0;
    var worstEdge=null;
    for (var i=0; i&lt;bb.length; ++i) {
      var c=countCrossings(aa,bb,i);
      if (c &gt; maxCrossings) { maxCrossings=c; worstEdge=i; }
    }
    if (worstEdge!=null) {
      aa[ bb[worstEdge].row ] = aa[ bb[worstEdge].row ].text;
      bb[worstEdge] = bb[worstEdge].text;
    }
  } while (maxCrossings &gt; 0);
  return { a: aa, b: bb };
}

function max(a,b){return a&lt;b ? b : a;}
function min(a,b){return a&gt;b ? b : a;}

function shortenDiffString(str, context) {
  var re=RegExp('(&lt;del[\\s\\S]*?&lt;/del&gt;|&lt;ins[\\s\\S]*?&lt;/ins&gt;)');
  var splitted=str.parenSplit(re);
  var ret=[''];
  for (var i=0; i&lt;splitted.length; i+=2) {
    if (splitted[i].length &lt; 2*context) {
      ret[ret.length-1] += splitted[i];
      if (i+1&lt;splitted.length) { ret[ret.length-1] += splitted[i+1]; }
      continue;
    }
    else {
      if (i &gt; 0) { ret[ret.length-1] += splitted[i].substring(0,context); }
      if (i+1 &lt; splitted.length) { ret.push(splitted[i].substring(splitted[i].length-context) + splitted[i+1]); }
    }
  }
  while (ret.length &gt; 0 &amp;&amp; !ret[0]) {
    ret = ret.slice(1);
  }
  return ret;
}


function diffString( o, n, simpleSplit, slow ) {
  var splitRe=RegExp('([[]{2}|[\]]{2}|[{]{2,3}|[}]{2,3}|[|]|=|[*:]+|\\b)');

  o=diffEscape(o); n=diffEscape(n);
  var out, i;
  if (simpleSplit) { out = diff( o.split(/\b/), n.split(/\b/) ); }
  else out = diff( o.parenSplit(splitRe), n.parenSplit(splitRe) );
  var str = &quot;&quot;;
  var acc=[]; // accumulator for prettier output

  // crossing pairings -- 'A B' vs 'B A' -- cause problems, so let's iron them out
  if (slow) {
    var untangled=untangle(out.o, out.n); // &lt;-- too slow!
    out.o=untangled.a; out.n=untangled.b;
  } else {
    var maxOutputPair=0;
    for (i=0; i&lt;out.n.length; ++i) {
      if ( out.n[i].row != null) {
	if( maxOutputPair &gt; out.n[i].row ) {
	  // tangle - delete pairing
	  out.o[ out.n[i].row ]=out.o[ out.n[i].row ].text;
	  out.n[i]=out.n[i].text;
	}
	if (maxOutputPair &lt; out.n[i].row) { maxOutputPair = out.n[i].row; }
      }
    }
  }

  // output the stuff preceding the first paired old line
  for (i=0; i&lt;out.o.length &amp;&amp; out.o[i].text == null; ++i) acc.push( out.o[i] );
  str += delFmt(acc); acc=[];

  // main loop
  for ( i = 0; i &lt; out.n.length; ++i ) {
    // output unpaired new &quot;lines&quot;
    while ( i &lt; out.n.length &amp;&amp; out.n[i].text == null ) { acc.push( out.n[i++] ); }
    str += insFmt(acc); acc=[];
    if ( i &lt; out.n.length ) { // this new &quot;line&quot; is paired with the (out.n[i].row)th old &quot;line&quot;
      str += out.n[i].text;
      // output unpaired old rows starting after this new line's partner
      var m = out.n[i].row + 1;
      while ( m &lt; out.o.length &amp;&amp; out.o[m].text == null ) { acc.push ( out.o[m++] ); }
      str += delFmt(acc); acc=[];
    }
  }
  return str;
}

window.jsReservedProperties=RegExp('^((un)?watch|toString|eval)$');
window.diffBugAlerts='';


function diffBugAlert(word) {
  if (diffBugAlerts.indexOf(word+'\n')==-1) {
    diffBugAlerts+=word+'\n';
    alert('Bad word: '+word+'\n\nPlease report this bug.');
  }
}

function diff( o, n ) {
  var ns = {};
  var os = {};
  var i;

  // pass 1: make hashtable ns with new rows as keys
  for ( i = 0; i &lt; n.length; i++ ) {
    if ( jsReservedProperties.test(n[i]) ) { n[i] += '&lt;!-- --&gt;'; }
    if ( ns[ n[i] ] == null ) {
      ns[ n[i] ] = { rows: [], o: null };
    }
    try { ns[ n[i] ].rows.push( i ); } catch (err) { diffBugAlert(n[i]); }
  }

  // pass 2: make hashtable os with old rows as keys
  for ( i = 0; i &lt; o.length; i++ ) {
    if ( jsReservedProperties.test(o[i]) ) { o[i] += '&lt;!-- --&gt;'; }
    if ( os[ o[i] ] == null ) {
      os[ o[i] ] = { rows: [], n: null };
    }
    try {os[ o[i] ].rows.push( i ); } catch (err) { diffBugAlert(n[i]); }
  }

  // pass 3: pair unique new rows and matching unique old rows
  for ( i in ns ) {
    if ( ns[i].rows.length == 1 &amp;&amp; typeof(os[i]) != &quot;undefined&quot; &amp;&amp; os[i].rows.length == 1 ) {
      n[ ns[i].rows[0] ] = { text: n[ ns[i].rows[0] ], row: os[i].rows[0] };
      o[ os[i].rows[0] ] = { text: o[ os[i].rows[0] ], row: ns[i].rows[0] };
    }
  }

  // pass 4: pair matching rows immediately following paired rows (not necessarily unique)
  for ( i = 0; i &lt; n.length - 1; i++ ) {
    if ( n[i].text != null &amp;&amp; n[i+1].text == null &amp;&amp;
	 n[i].row &lt; o.length - 1 &amp;&amp; o[ n[i].row + 1 ].text == null &amp;&amp;
	 n[i+1] == o[ n[i].row + 1 ] ) {
      n[i+1] = { text: n[i+1], row: n[i].row + 1 };
      o[n[i].row+1] = { text: o[n[i].row+1], row: i + 1 };
    }
  }

  // pass 5: pair matching rows immediately preceding paired rows (not necessarily unique)
  for ( i = n.length - 1; i &gt; 0; i-- ) {
    if ( n[i].text != null &amp;&amp; n[i-1].text == null &amp;&amp;
	 n[i].row &gt; 0 &amp;&amp; o[ n[i].row - 1 ].text == null &amp;&amp;
	 n[i-1] == o[ n[i].row - 1 ] ) {
      n[i-1] = { text: n[i-1], row: n[i].row - 1 };
      o[n[i].row-1] = { text: o[n[i].row-1], row: i - 1 };
    }
  }

  return { o: o, n: n };
}

// ENDFILE: diff.js
// STARTFILE: init.js
function setSiteInfo() {
  pg.wiki.hostname = location.hostname; // use in preference to location.hostname for flexibility (?)
  pg.wiki.lang = pg.wiki.hostname.split('.')[0];
  pg.wiki.wikimedia=RegExp('wiki([pm]edia|source|books|news|quote)\\.org|wiktionary\\.org').test(pg.wiki.hostname);
  pg.wiki.wikicites=RegExp('wikicities[.]com$', 'i').test(pg.wiki.hostname);
  pg.wiki.isLocal=RegExp('^localhost').test(pg.wiki.hostname);
  pg.wiki.commons='commons.wikimedia.org';
}

function setTitleBase() {
  pg.wiki.articlePath='/wiki/';
  pg.wiki.botInterfacePath = '/wiki';
  if (pg.wiki.wikimedia) { pg.wiki.botInterfacePath = '/w' }
  else if (pg.wiki.wikicities) { pg.wiki.botInterfacePath = ''; }
  titletail =  pg.wiki.botInterfacePath + '/index.php?title=';
  // other sites may need to add code here to set titletail depending on how their urls work

  pg.wiki.titlebase = location.protocol + '//' + pg.wiki.hostname + titletail;
  pg.wiki.wikibase  = location.protocol + '//' + pg.wiki.hostname + pg.wiki.botInterfacePath;
}


//////////////////////////////////////////////////
// Global regexps

function setMainRegex() {
  var reStart='[^:]*://';
  var preTitles='wiki/|w/index\\.php\\?title=';

  if (!pg.wiki.wikimedia) {
    preTitles = 'wiki/index\\.php\\?title=|wiki/index\\.php/|' + preTitles + '|index\\.php\\?title=' ;
  }
  var reEnd='/(' + preTitles + ')([^&amp;?]*)';
  pg.re.main = RegExp(reStart + pg.wiki.hostname.split('.').join('\\.') + reEnd);
}

function setRegexps() {
  setMainRegex();
  pg.re.stub= RegExp('stub[}][}]|This .*-related article is a .*stub', 'im') ;
  pg.re.disambig=RegExp('([{][{]\\s*disambig|disambig\\s*[}][}]|disamb\\s*[}][}]|dab\\s*[}][}])' +
      '|[{][{]\\s*(geo|hn)dis.*[}][}]' +
      '|[{][{]\\s*[234][Cc][Cc]\\s*[}][}]' + // explicit, whole template names on this line
      '|is a .*disambiguation.*page', 'im') ;

  pg.re.urlNoPopup=RegExp('((title=|/)' + pg.ns.special + ':|section=[0-9])') ;
  pg.re.contribs  =RegExp('(title=|/)'  + pg.ns.special + ':Contributions' + '(&amp;target=|/|/' + pg.ns.user+':)(.*)') ;
  pg.re.email     =RegExp('(title=|/)'  + pg.ns.special + ':Emailuser'     + '(&amp;target=|/|/' + pg.ns.user+':)(.*)') ;

  // note: tries to get images in infobox templates too, e.g. movie pages, album pages etc
  //                      (^|\[\[)image: *([^|\]]*[^|\] ]) *
  //                      (^|\[\[)image: *([^|\]]*[^|\] ])([^0-9\]]*([0-9]+) *px)?
  //                                                        $4 = 120 as in 120px
   pg.re.image = RegExp('(^|\\[\\[)' + pg.ns.image + ': *([^|\\]]*[^|\\] ])([^0-9\\]]*([0-9]+) *px)?|\\n *[|]? *(image|cover) *= *([^|]*?) *[|]? *\\n', 'img') ;
   pg.re.imageBracketCount = 6;

   pg.re.category = RegExp('\\[\\[' +pg.ns.category + ': *([^|\\]]*[^|\\] ]) *', 'i');
   pg.re.categoryBracketCount = 1;

   pg.re.ipUser=RegExp('('+pg.ns.user+':)?' + '((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}' +
		       '(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])');

   // FIXME replace with general parameter parsing function, this is daft
   pg.re.oldid=RegExp('[?&amp;]oldid=([^&amp;]*)');
   pg.re.diff=RegExp('[?&amp;]diff=([^&amp;]*)');
}


//////////////////////////////////////////////////
// Image sources

function setImageSources() {
  pg.wiki.imageSources=[];

  // frequently seen thumbs
  pg.wiki.imageSources.push(
  {wiki: pg.wiki.hostname, thumb: true,  width: 180}, // default
  {wiki: pg.wiki.hostname, thumb: true,  width: 120} // gallery
  );

  // frequently seen thumbs on commons
  if (pg.wiki.wikimedia &amp;&amp; pg.wiki.hostname!=pg.wiki.commons) {
    pg.wiki.imageSources.push(
    {wiki: pg.wiki.commons, thumb: true,  width: 180},
    {wiki: pg.wiki.commons, thumb: true,  width: 120}
    );
  }

  // unusual thumb sizes and full-size
  pg.wiki.imageSources.push(
  {wiki: pg.wiki.hostname, thumb: true,  width: 200}, // common?
  {wiki: pg.wiki.hostname, thumb: true,  width: 250}, // common?
  {wiki: pg.wiki.hostname, thumb: true,  width: 300},
  {wiki: pg.wiki.hostname, thumb: true,  width: 210},
  {wiki: pg.wiki.hostname, thumb: true,  width: 230},
  {wiki: pg.wiki.hostname, thumb: false, width: 0} // no comma
  );

  // full-size on commons
  if (pg.wiki.wikimedia &amp;&amp; pg.wiki.hostname!=pg.wiki.commons) {
    pg.wiki.imageSources.push({wiki: pg.wiki.commons, thumb: false, width: 0});
  }
}

//////////////////////////////////////////////////
// miscellany

function setMisc() {
  pg.current.link=null;

  // downloading images are put here
  pg.misc.imageArray=[];

  // page caching
  pg.cache.pages = [];
  pg.cache.images = [];

  // FIXME what is this for?
  pg.misc.gImage=null; // global for image

  // check to see if images are done with this timer
  pg.timer.image=null;

  // These are for checkImages()
  pg.counter.checkImages=0;
  pg.timer.checkImages=null;
  pg.timer.checkPopupPosition=null;
  pg.counter.loop=0;

  // ids change with each popup: popupImage0, popupImage1 etc
  pg.idNumber=0;

  // for myDecodeURI
  pg.misc.decodeExtras = [
      {from: '%2C', to: ',' },
      {from: '_',   to: ' ' },
      {from: '%24', to: '$'},
      {from: '%26',   to: '&amp;' } // no ,
  ];

  // for setPopupHTML - needed for timers and stuff
  pg.timer.popupHTML=[];
  pg.misc.popupHTMLLoopFunctions = [];

  // FIXME - eliminate this
  pg.counter.redir=0;
}

function setBrowserHacks() {
  // browser-specific hacks
  if (typeof window.opera != 'undefined') {
    setDefault('popupStructure','original');
  } else if (navigator.appName=='Konqueror') {
    setDefault('popupNavLinkSeparator', ' &amp;bull; ');
    pg.flag.isKonq=true;
  } else if ( navigator.vendor &amp;&amp; navigator.vendor.toLowerCase().indexOf('apple computer')===0) {
    pg.flag.isSafari=true;
  } else if (navigator.appName.indexOf(&quot;Microsoft&quot;)!=-1) {
    setDefault('popupNavLinkSeparator', ' &amp;#183; ');
    setDefault('popupStructure','original');
    pg.flag.isIE=true;
  }
  if (pg.flag.isIE || pg.flag.isKonq || pg.flag.isSafari) {
    pg.flag.linksLikeIE=true;
  }
}

function setupPopups() {
  // NB translatable strings should be set up first (strings.js)

  // basics
  setSiteInfo();
  setTitleBase();

  // namespaces etc
  setNamespaces();
  setInterwiki();

  // regexps
  setRegexps();
  setRedirs();

  // other stuff
  setImageSources();
  setOptions(); // see options.js
  setBrowserHacks();
  setMisc();
  setupDebugging();
  setupLivePreview();

  // main deal here
  setupTooltips();
  Navpopup.tracker.enable();

}

// ENDFILE: init.js
// STARTFILE: navlinks.js
//////////////////////////////////////////////////
// navlinks... let the fun begin
//

function defaultNavlinkSpec() {
  var str='';
  str += '&lt;b&gt;&lt;&lt;mainlink|shortcut= &gt;&gt;&lt;/b&gt;';
  if (getValueOf('popupLastEditLink')) str += '*&lt;&lt;lastEdit|shortcut=/&gt;&gt;|&lt;&lt;lastContrib&gt;&gt;|&lt;&lt;sinceMe&gt;&gt;if(oldid){|&lt;&lt;oldEdit&gt;&gt;|&lt;&lt;diffCur&gt;&gt;}';
  str+='&lt;&lt;imagestatus&gt;&gt;';

  // user links
  // contribs - log - count - email - block
  // count only if applicable; block only if popupAdminLinks
  str += 'if(user){&lt;br&gt;&lt;&lt;contribs|shortcut=c&gt;&gt;*&lt;&lt;userlog|shortcut=L|log&gt;&gt;';
  str+='if(ipuser){*&lt;&lt;arin&gt;&gt;}if(wikimedia){*&lt;&lt;count|shortcut=#&gt;&gt;}';
  str+='if(ipuser){}else{*&lt;&lt;email|shortcut=E&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}}';

  // editing links
  // talkpage   -&gt; edit|new - history - un|watch - article|edit
  // other page -&gt; edit - history - un|watch - talk|edit|new
  var editstr='&lt;&lt;edit|shortcut=e&gt;&gt;';
  var editOldidStr='if(oldid){&lt;&lt;editOld|shortcut=e&gt;&gt;|&lt;&lt;revert|shortcut=v|rv&gt;&gt;|&lt;&lt;edit|cur&gt;&gt;}else{' + editstr + '}'
  var historystr='&lt;&lt;history|shortcut=h&gt;&gt;if(mainspace){|&lt;&lt;editors|shortcut=E|&gt;&gt;}';
  var watchstr='&lt;&lt;unwatch|unwatchShort&gt;&gt;|&lt;&lt;watch|shortcut=w|watchThingy&gt;&gt;';

  str+='&lt;br&gt;if(talk){' +
    editOldidStr+'|&lt;&lt;new|shortcut=+&gt;&gt;' + '*' + historystr+'*'+watchstr + '*' + '&lt;b&gt;&lt;&lt;article|shortcut=a&gt;&gt;&lt;/b&gt;|&lt;&lt;editArticle|edit&gt;&gt;'
    + '}else{' // not a talk page
    + editOldidStr + '*' + historystr + '*' + watchstr + '*' + '&lt;b&gt;&lt;&lt;talk|shortcut=t&gt;&gt;&lt;/b&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;'
    + '}';

  // misc links
  str += '&lt;br&gt;&lt;&lt;whatLinksHere|shortcut=l&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r&gt;&gt;*&lt;&lt;move|shortcut=m&gt;&gt;';

  // admin links
  str += 'if(admin){&lt;br&gt;&lt;&lt;unprotect|unprotectShort&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*' + '&lt;&lt;undelete|undeleteShort&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;}';
  return str;
};

function navLinksHTML (article, hint, oldid) {
  var str = '&lt;span class=&quot;popupNavLinks&quot;&gt;';
  var style=getValueOf('popupNavLinkStyle');
  switch (style) {
  case 'default':
    str += defaultNavlinkSpec();
    break;
  default:
    if (typeof style == 'function') str += style();
    else str+=String(style);
  }
  str += '&lt;/span&gt;';

  // BAM
  return navlinkStringToHTML(str, article, oldid);
};

function expandConditionalNavlinkString(s,article,oldid,recursionCount) {
  // nested conditionals (up to 10 deep) are ok, hopefully! (work from the inside out)
  if (typeof recursionCount!=typeof 0) recursionCount=0;
  var conditionalSplitRegex=RegExp(
   //(1     if    \\(    (2    2)    \\)      {(3    3)}  (4   else      {(5     5)}  4)1)
    '(;?\\s*if\\s*\\(\\s*([a-z]*)\\s*\\)\\s*\\{([^{}]*)\\}(\\s*else\\s*\\{([^{}]*?)\\}|))', 'i');
  var splitted=s.parenSplit(conditionalSplitRegex);
  // $1: whole conditional
  // $2: test condition
  // $3: true expansion
  // $4: else clause (possibly empty)
  // $5: false expansion (possibly null)
  var numParens=5;
  ret = splitted[0];
  for (var i=1; i&lt;splitted.length; i=i+numParens+1) {

    var testString=splitted[i+2-1];
    var trueString=splitted[i+3-1];
    var falseString=splitted[i+5-1];
    if (typeof falseString=='undefined' || !falseString) falseString='';
    var testResult=null;

    switch (testString) {
    case 'user':
      testResult=(article.userName())?true:false;
      break;
    case 'talk':
      testResult=(article.talkPage())?false:true; // talkPage converts _articles_ to talkPages
      break;
    case 'admin':
      testResult=getValueOf('popupAdminLinks')?true:false;
      break;
    case 'oldid':
      testResult=(typeof oldid != 'undefined' &amp;&amp; oldid)?true:false;
      break;
    case 'ipuser':
      testResult=(article.isIpUser())?true:false;
      break;
    case 'mainspace':
      testResult=isInMainNamespace(article);
      break;
    case 'wikimedia':
      testResult=(pg.wiki.wikimedia) ? true : false;
      break;
    }

    switch(testResult) {
    case null: ret+=splitted[i];  break;
    case true: ret+=trueString;   break;
    case false: ret+=falseString; break;
    }

    // append non-conditional string
    ret += splitted[i+numParens];
  }
  if (conditionalSplitRegex.test(ret) &amp;&amp; recursionCount &lt; 10)
    return expandConditionalNavlinkString(ret,article,oldid,recursionCount+1);
  else return ret;
};

function navlinkStringToArray(s, article, oldid) {
  s=expandConditionalNavlinkString(s,article,oldid);
  var splitted=s.parenSplit(RegExp('&lt;&lt;(.*?)&gt;&gt;'));
  var ret=[];
  for (var i=0; i&lt;splitted.length; ++i) {
    if (i%2) { // i odd, so s is a tag
      var t=new navlinkTag();
      var ss=splitted[i].split('|');
      t.id=ss[0];
      for (var j=1; j&lt;ss.length; ++j) {
	var sss=ss[j].split('=');
	if (sss.length&gt;1)
	  t[sss[0]]=sss[1];
	else // no assignment (no &quot;=&quot;), so treat this as a title (overwriting the last one)
	  t.text=popupString(sss[0]);
      }
      t.article=article;
      if (typeof oldid != 'undefined' &amp;&amp; oldid != null) t.oldid=oldid;
      if (!t.text &amp;&amp; t.id != 'mainlink') t.text=popupString(t.id);
      ret.push(t);
    }
    else { // plain HTML
      ret.push(splitted[i].split('*').join(getValueOf('popupNavLinkSeparator'))
	       .split('&lt;line&gt;').join('&lt;span class=&quot;popup_menu_row&quot;&gt;').split('&lt;/line&gt;').join('&lt;/span&gt;'));
    }
  }
  return ret;
};

// navlinkString: * becomes the separator
//                &lt;&lt;foo|bar=baz|fubar&gt;&gt; becomes a foo-link with attribute bar='baz'
//                                      and visible text 'fubar'
//                if(test){...} and if(test){...}else{...} work too (nested ok)

function navlinkStringToHTML(s,article,oldid) {
  //limitAlert(navlinkStringToHTML, 5, 'navlinkStringToHTML\n' + article + '\n' + (typeof article));
  var p=navlinkStringToArray(s,article,oldid);
  var html='';
  for (var i=0; i&lt;p.length; ++i) {
    if (typeof p[i] == typeof '') {
      html+=p[i];
    } else if (typeof p[i].type != 'undefined' &amp;&amp; p[i].type=='navlinkTag') {
      html+=p[i].html();
    }
  }
  return html;
}

function navlinkTag() {this.type='navlinkTag';};

navlinkTag.prototype.html=function () {
  this.getNewWin();
  this.getPrintFunction();
  var html='';
  if (typeof this.print!='function') {
    errlog ('Oh dear - invalid print function for a navlinkTag, id='+this.id);
  } else {
    html=this.print(this);
    if (typeof html != typeof '') {html='';}
    else if (typeof this.shortcut!='undefined') html=addPopupShortcut(html, this.shortcut);
  }
  return '&lt;span class=&quot;popup_'+this.id+'&quot;&gt;'+html+'&lt;/span&gt;';
};

navlinkTag.prototype.getNewWin=function() {
  getValueOf('popupLinksNewWindow');
  if (typeof pg.option.popupLinksNewWindow[this.id] === 'undefined') this.newWin=null;
  this.newWin=pg.option.popupLinksNewWindow[this.id];
}

navlinkTag.prototype.getPrintFunction=function() { //think about this some more
  // this.id and this.article should already be defined
  if (typeof this.id!=typeof '' || typeof this.article!=typeof {} ) return;
  var html='';
  var a,t;

  switch (this.id) {
  case 'email':     case 'contribs':  case 'block':     case 'unblock':
  case 'userlog':   case 'userSpace':
    this.article=this.article.userName();
  }

  switch (this.id) {
  case 'userTalk': case 'newUserTalk': case 'editUserTalk':
  case 'userPage': case 'monobook': case 'editMonobook': case 'blocklog':
    delete this.oldid;
    this.article=this.article.userName(true);
  }

  if (this.id=='editMonobook' || this.id=='monobook') { this.article.append('/monobook.js'); }

  if (this.id != 'mainlink') {
    // FIXME anchor handling should be done differently with Title object
    // this.article=removeAnchor(this.article);
    // if (typeof this.text=='undefined') this.text=popupString(this.id);
  }

  switch (this.id) {
  case 'undelete':       this.print=specialLink; this.specialpage='Undelete'; this.sep='/'; break;
  case 'whatLinksHere':  this.print=specialLink; this.specialpage='Whatlinkshere'; break;
  case 'relatedChanges': this.print=specialLink; this.specialpage='Recentchangeslinked'; break;
  case 'move':           this.print=specialLink; this.specialpage='Movepage'; break;
  case 'contribs':       this.print=specialLink; this.specialpage='Contributions'; break;
  case 'email':          this.print=specialLink; this.specialpage='Emailuser'; break;
  case 'block':          this.print=specialLink; this.specialpage='Blockip'; this.sep='&amp;ip='; break;
  case 'unblock':        this.print=specialLink; this.specialpage='Ipblocklist'; this.sep='&amp;action=unblock&amp;ip='; break;
  case 'userlog':        this.print=specialLink; this.specialpage='Log'; this.sep='&amp;user='; break;
  case 'blocklog':       this.print=specialLink; this.specialpage='Log'; this.sep='&amp;type=block&amp;page='; break;
  case 'userSpace':      this.print=specialLink; this.specialpage='Prefixindex'; this.sep='&amp;namespace=2&amp;from='; break;
  case 'search':         this.print=specialLink; this.specialpage='Search'; this.sep='&amp;fulltext=Search&amp;search='; break;
  case 'history': case 'unwatch': case 'watch':
  case 'unprotect': case 'protect':
    this.print=wikiLink; this.action=this.id; break;

  case 'delete':
    this.print=wikiLink; this.action='delete';
    if (isImagePage(this.article)) {
      var img=this.article.stripNamespace();
      this.action+='&amp;image='+img;
    }
  break;

  case 'edit': case 'view':
    this.print=wikiLink;
    delete this.oldid;
    this.action=this.id; break;
  case 'new':
    this.print=wikiLink; this.action='edit&amp;section=new'; break;
  case 'mainlink':
    if (typeof this.text=='undefined') this.text=safeDecodeURI(this.article);
    if (getValueOf('popupSimplifyMainLink') &amp;&amp; isInStrippableNamespace(this.article)) {
      var s=this.text.split('/'); this.text=s[s.length-1];
      if (this.text=='' &amp;&amp; s.length &gt; 1) this.text=s[s.length-2];
    }
    this.print=titledWikiLink;
    if (typeof this.title=='undefined' &amp;&amp; pg.current.link &amp;&amp; typeof pg.current.link.href != 'undefined') {
      this.title=safeDecodeURI((pg.current.link.originalTitle)?pg.current.link.originalTitle:this.article);
      if (typeof this.oldid != 'undefined' &amp;&amp; this.oldid) {
	this.title=tprintf('Revision %s of %s', [this.oldid, this.title]);
      }
    }
    this.action='view'; break;
  case 'userPage':
  case 'article':
  case 'monobook':
  case 'editMonobook':
  case 'editArticle':
  //alert(this.id+'\n'+this.article + '\n'+ typeof this.article);
    this.article=this.article.articleFromTalkOrArticle();
  //alert(this.id+'\n'+this.article + '\n'+ typeof this.article);
    this.print=wikiLink;
    this.action='view'; break;
    if (this.id.indexOf('edit')==0) {
      this.action='edit';
    } else { this.action='view';}
    break;
  case 'userTalk':
  case 'talk':
    this.article=this.article.talkPage();
    this.print=wikiLink;
    this.action='view'; break;
  case 'arin':
    this.print=arinLink; break;
  case 'count':
    this.print=kateLink; break;
  case 'google':
    this.print=googleLink; break;
  case 'contribsTree':
    this.print=contribsTreeLink; break
  case 'editors':
    this.print=editorListLink; break;
  case 'globalsearch':
    this.print=globalSearchLink; break;
  case 'lastEdit':
    this.print=titledDiffLink;
    this.title=popupString('Show the last edit');
    this.from='prev'; this.to='cur'; break;
  case 'oldEdit':
    this.print=titledDiffLink;
    this.title=popupString('Show the edit made to get revision') + ' ' + this.oldid;
    this.from='prev'; this.to=this.oldid; break;
  case 'editOld':
    this.print=wikiLink; this.action='edit'; break;
  case 'revert':
    this.print=wikiLink; this.action='revert'; break;
  case 'nullEdit':
    this.print=wikiLink; this.action='nullEdit'; break;
  case 'diffCur':
    this.print=titledDiffLink;
    this.title=tprintf('Show changes since revision %s', [this.oldid]);
    this.from=this.oldid; this.to='cur'; break;
  case 'editUserTalk':
  case 'editTalk':
    this.article=this.article.talkPage();
    this.action='edit'; this.print=wikiLink; break;
  case 'newUserTalk':
  case 'newTalk':
    this.article=this.article.talkPage();
    this.action='edit&amp;section=new'; this.print=wikiLink; break;
  case 'imagestatus':
    this.print=function () { return emptySpanHTML('popupImageStatus', pg.idNumber); }
    break;
  case 'lastContrib':
  case 'sinceMe':
    this.print=magicHistoryLink;
  break;
  default:
    this.print=function () {return 'Unknown navlink type: '+this.id+''};
  }
};

//
//  end navlinks
//////////////////////////////////////////////////

// ENDFILE: navlinks.js
// STARTFILE: shortcutkeys.js
function popupHandleKeypress(evt) {
  var keyCode = window.event ? window.event.keyCode : ( evt.keyCode ? evt.keyCode : evt.which);
  if (!keyCode || !pg.current.link || !pg.current.link.navpopup) { return; }
  if (keyCode==27) { // escape
    killPopup();
    return false; // swallow keypress
  }

  var letter=String.fromCharCode(keyCode);
  var links=pg.current.link.navpopup.mainDiv.getElementsByTagName('A');
  var startLink=0;
  var i,j;

  if (popupHandleKeypress.lastPopupLinkSelected) {
    for (i=0; i&lt;links.length; ++i) {
      if (links[i]==popupHandleKeypress.lastPopupLinkSelected) startLink=i;
    }
  }
  for (j=0; j&lt;links.length; ++j) {
    i=(startLink + j + 1) % links.length;
    if (links[i].getAttribute('popupkey')==letter) {
      if (evt &amp;&amp; evt.preventDefault) evt.preventDefault();
      links[i].focus();
      popupHandleKeypress.lastPopupLinkSelected=links[i];
      return false; // swallow keypress
    }
  }

  // pass keypress on
  if (document.oldPopupOnkeypress) return document.oldPopupOnkeypress(evt);
  else return true;
};

function addPopupShortcuts() {
  if (document.onkeypress &amp;&amp; document.onkeypress.toString()==popupHandleKeypress.toString()) return;
  document.oldPopupOnkeypress=document.onkeypress;
  document.onkeypress=popupHandleKeypress;
};

function rmPopupShortcuts() {
  popupHandleKeypress.lastPopupLinkSelected=null;
  try {
    if (document.oldPopupOnkeypress &amp;&amp; document.oldPopupOnkeypress.toString()==popupHandleKeypress.toString()) {
      // panic
      document.onkeypress=null; //function () {};
      return;
    }
    document.onkeypress=document.oldPopupOnkeypress;
  } catch (nasties) { /* IE goes here */ }
};


function addLinkProperty(html, property) {
  // take &quot;&lt;a href=...&gt;...&lt;/a&gt; and add a property
  // not sophisticated at all, easily broken
  var i=html.indexOf('&gt;');
  if (i&lt;0) return html;
  return html.substring(0,i) + ' ' + property + html.substring(i);
};

function addPopupShortcut(html, key) {
  if (!getValueOf('popupShortcutKeys')) return html;
  var ret= addLinkProperty(html, 'popupkey=&quot;'+key+'&quot;');
  if (key==' ') key=popupString('spacebar');
  return ret.replace(RegExp('^(.*?)(title=&quot;)(.*?)(&quot;.*)$', 'i'),'$1$2$3 ['+key+']$4');
};

// ENDFILE: shortcutkeys.js
// STARTFILE: diffpreview.js
function loadDiff(article, oldid, diff) {
  pg.diffData={}; // FIXME this is very unreliable; should be done on a per-popup basis
  var oldRev, newRev;
  switch (diff) {
  case 'cur':
    if (  oldid===null || oldid=='' ) {
      // eg newmessages diff link
      oldRev='0&amp;direction=prev';
      newRev=0;
    } else {
      oldRev = oldid;
      newRev = 0;
    }
    break;
  case 'prev':
    oldRev = ( oldid || 0 ) + '&amp;direction=prev'; newRev = oldid; break;
  case 'next':
    oldRev = oldid; newRev = oldid + '&amp;direction=next';
    break;
  default:
    oldRev = oldid || 0; newRev = diff || 0; break;
  }
  oldRev = oldRev || 0;
  newRev = newRev || 0;

  getWiki(article, doneDiffNew, newRev);
  getWiki(article, doneDiffOld, oldRev);
}

function doneDiffNew(download) {
  if (download.id != pg.idNumber) { return; }
  pg.diffData.New=download;
  if (pg.diffData.Old &amp;&amp; pg.diffData.Old.id == pg.idNumber) { insertDiff(); }
}

function doneDiffOld(download) {
  if (download.id != pg.idNumber) { return; }
  pg.diffData.Old=download;
  if (pg.diffData.New &amp;&amp; pg.diffData.New.id == pg.idNumber) { insertDiff(); }
}


function rmBoringLines(a,b,context) {

  if (typeof context == 'undefined') { context=2; }
  // this is fairly slow... i think it's quicker than doing a word-based diff from the off, though
  var aa=[], aaa=[];
  var bb=[], bbb=[];
  var i, j;

  // first, gather all disconnected nodes in a and all crossing nodes in a and b
  for (i=0; i&lt;a.length; ++i ) {
    if(!a[i].row || a[i].row===0) { aa[i]=1; }
    else if (countCrossings(b,a,i, true)) {
      aa[i]=1;
      bb[ a[i].row ] = 1;
    }
  }

  // pick up remaining disconnected nodes in b
  for (i=0; i&lt;b.length; ++i ) {
    if (bb[i]==1) { continue; }
    if(!b[i].row || b[i].row===0) { bb[i]=1; }
  }

  // another pass to gather context: we want the neighbours of included nodes which are not yet included
  // we have to add in partners of these nodes, but we don't want to add context for *those* nodes in the next pass
  for (i=0; i&lt;b.length; ++i) {
    if ( bb[i] == 1 ) {
      for (j=max(0,i-context); j &lt; min(b.length, i+context); ++j) {
	if ( !bb[j] ) { bb[j] = 1; aa[ b[j].row ] = 0.5; }
      }
    }
  }

  for (i=0; i&lt;a.length; ++i) {
    if ( aa[i] == 1 ) {
      for (j=max(0,i-context); j &lt; min(a.length, i+context); ++j) {
	if ( !aa[j] ) { aa[j] = 1; bb[ a[j].row ] = 0.5; }
      }
    }
  }

  for (i=0; i&lt;bb.length; ++i) {
    if (bb[i] &gt; 0) { // it's a row we need
      if (b[i].row || b[i].row===0) { bbb.push(b[i].text); } // joined; partner should be in aa
      else {
	bbb.push(b[i]);
      }
    }
  }
  for (i=0; i&lt;aa.length; ++i) {
    if (aa[i] &gt; 0) { // it's a row we need
      if (a[i].row || a[i].row===0) { aaa.push(a[i].text); } // joined; partner should be in aa
      else {
	aaa.push(a[i]);
      }
    }
  }

  return { a: aaa, b: bbb};
}

function stripOuterCommonLines(a,b,context) {
  var i=0;
  while (i&lt;a.length &amp;&amp; i &lt; b.length &amp;&amp; a[i]==b[i]) { ++i; }
  var j=a.length-1; var k=b.length-1;
  while ( j&gt;=0 &amp;&amp; k&gt;=0 &amp;&amp; a[j]==b[k] ) { --j; --k; }

  return { a: a.slice(max(0,i - 1 - context), min(a.length+1, j + context+1)),
	   b: b.slice(max(0,i - 1 - context), min(b.length+1, k + context+1)) };
}

function insertDiff() {
  // for speed reasons, we first do a line-based diff, discard stuff that seems boring, then do a word-based diff
  // FIXME: sometimes this gives misleading diffs as distant chunks are squashed together
  var oldlines=pg.diffData.Old.data.split('\n');
  var newlines=pg.diffData.New.data.split('\n');
  getValueOf('popupDiffContextLines');
  var inner=stripOuterCommonLines(oldlines,newlines,pg.option.popupDiffContextLines);
  oldlines=inner.a; newlines=inner.b;
  var truncated=false;
  getValueOf('popupDiffMaxLines');
  if (oldlines.length &gt; pg.option.popupDiffMaxLines || newlines.length &gt; pg.option.popupDiffMaxLines) {
    // truncate
    truncated=true;
    inner=stripOuterCommonLines(oldlines.slice(0,pg.option.popupDiffMaxLines),
				    newlines.slice(0,pg.option.popupDiffMaxLines),
				    pg.option.popupDiffContextLines);
    oldlines=inner.a; newlines=inner.b;
  }

  var lineDiff=diff(oldlines, newlines);
  var lines2=rmBoringLines(lineDiff.o, lineDiff.n);
  var oldlines2=lines2.a; var newlines2=lines2.b;

  var simpleSplit = (String.prototype.parenSplit.toString().indexOf('native code')==-1);
  var html='&lt;hr&gt;';
  try {
    if (getValueOf('popupDiffDates')) {
      html+='&lt;table class=&quot;popup_diff_dates&quot;&gt;';
      html += '&lt;tr&gt;&lt;td&gt;' + tprintf('New revision') + '&lt;/td&gt;&lt;td&gt;' + pg.diffData.New.lastModified.toLocaleString() + '&lt;/td&gt;&lt;/tr&gt;';
      html += '&lt;tr&gt;&lt;td&gt;' + tprintf('Old revision') + '&lt;/td&gt;&lt;td&gt;' + pg.diffData.Old.lastModified.toLocaleString() + '&lt;/td&gt;&lt;/tr&gt;';
      html += '&lt;/table&gt;&lt;hr&gt;';
    }
  } catch (cockup) {
    // nothing here - maybe the download failed or something. anyway, not too fussed.
  }
  html += shortenDiffString(
		      diffString(oldlines2.join('\n'), newlines2.join('\n'), simpleSplit),
		      getValueOf('popupDiffContextCharacters') ).join('&lt;hr&gt;');
  setPopupHTML(html.split('\n').join('&lt;br&gt;') +
	       (truncated ? '&lt;hr&gt;&lt;b&gt;'+popupString('Diff truncated for performance reasons')+'&lt;/b&gt;' : '') ,
	       'popupPreview');
}

// ENDFILE: diffpreview.js
// STARTFILE: links.js
/////////////////////
// LINK GENERATION //
/////////////////////

// titledDiffLink --&gt; titledWikiLink --&gt; generalLink
// wikiLink       --&gt; titledWikiLink --&gt; generalLink
// kateLink --&gt; generalLink

function titledDiffLink(l) { // article, text, title, from, to) {
  return titledWikiLink({article: l.article, action: l.to + '&amp;oldid=' + l.from,
				    newWin: l.newWin,
				    text: l.text, title: l.title,
				    /* hack: no oldid here */
				    actionName: 'diff'});
};


window.wikiLink=function(l) {
  //{article:article, action:action, text:text, oldid}) {
  if (! (typeof l.article == typeof {}
	 &amp;&amp; typeof l.action == typeof '' &amp;&amp; typeof l.text==typeof '')) return null;
  if (typeof l.oldid == 'undefined') l.oldid=null;
  if (l.action!='edit' &amp;&amp; l.action!='view' &amp;&amp; l.action != 'revert') l.oldid=null;
  var hint=popupString(l.action + 'Hint');
  switch (l.action) {
  case 'edit&amp;section=new': hint = popupString('newSectionHint');  break;
  case 'revert':
    l.action='edit&amp;autoclick=wpSave&amp;autosummary=' + revertSummary(l.oldid);
    if (getValueOf('popupRevertSummaryPrompt')) { l.action += '&amp;autosummaryprompt=true'; }
    break;
  case 'nullEdit':
    l.action='edit&amp;autoclick=wpSave&amp;autosummary=null';
    break;
  }

  if (hint) {
    if (l.oldid) {
      hint = simplePrintf(hint, [tprintf('revision %s of %s', [l.oldid, safeDecodeURI(l.article)])]);
    }
    else {
      hint = simplePrintf(hint, [safeDecodeURI(l.article)]);
    }
  }
  else hint = safeDecodeURI(l.article + '&amp;action=' + l.action)
	 + (l.oldid) ? '&amp;oldid='+l.oldid : '';

  return titledWikiLink({article: l.article, action: l.action, text: l.text, newWin:l.newWin,
				    title: hint, oldid: l.oldid});
};

function revertSummary(oldid) {
  var historyPage=(document.title.split(' - ')[1] === popupString('History'));
  if (historyPage) {
    var links=document.links;
    var numlinks=links.length;
    var date=null, editor=null;
    for (var i=0; i&lt;numlinks-1; ++i) {
      if (RegExp('oldid='+oldid).test(links[i].href)
	  &amp;&amp; RegExp('^[0-9]{2}:[0-9]{2},.*[1-3][0-9]{3}$').test(links[i].innerHTML)) {
	date=links[i].innerHTML;
	editor=Title.fromURL(links[i+1].href).userName();
	break;
      }
    }
    if (date &amp;&amp; editor) {
      return simplePrintf(getValueOf('popupExtendedRevertSummary'), [date, editor, oldid]);
    }
  }
  return simplePrintf(getValueOf('popupRevertSummary'), [ oldid ]);
}

function titledWikiLink(l) {
  // possible properties of argument:
  // article, action, text, title, oldid, actionName, className
  // oldid = null is fine here

  // article and action are mandatory args

  if (typeof l.article == 'undefined' || typeof l.action=='undefined') {
    errlog('got undefined article or actino in titledWikiLink');
    return null;
  }

  var base = pg.wiki.titlebase +  l.article.urlString();
  var url=base;

  if (typeof l.actionName=='undefined' || !l.actionName) { l.actionName='action'; }

  // no need to add &amp;action=view, and this confuses anchors
  if (l.action != 'view') { url = base + '&amp;' + l.actionName + '=' + l.action; }

  if (typeof l.oldid!='undefined' &amp;&amp; l.oldid) { url+='&amp;oldid='+l.oldid; }

  var cssClass=pg.misc.defaultNavlinkClassname;
  if (typeof l.className!='undefined' &amp;&amp; l.className) { cssClass=l.className; }

  return generalNavLink({url: url, newWin: l.newWin,
			     title: (typeof l.title != 'undefined') ? l.title : null,
			     text: (typeof l.text!='undefined')?l.text:null,
			     className: cssClass});
};

function getLastContrib(wikipage, newWin) {
  getHistoryInfo(wikipage, function(x){processLastContribInfo(x,{page: wikipage, newWin: newWin})});
}
function processLastContribInfo(info, stuff) {
  if(!info.edits || !info.edits.length) { alert('Popups: an odd thing happened. Please retry.'); return; }
  if(!info.firstNewEditor) {
    alert(tprintf('Only found one editor: %s made %s edits', [info.edits[0].editor,info.edits.length]));
    return;
  }
  var newUrl=pg.wiki.titlebase + stuff.page + '&amp;diff=cur&amp;oldid='+info.firstNewEditor.oldid;
  displayUrl(newUrl, stuff.newWin);
}
function getDiffSinceMyEdit(wikipage, newWin) {
  getHistoryInfo(wikipage, function(x){processDiffSinceMyEdit(x,{page: wikipage, newWin: newWin})});
}
function processDiffSinceMyEdit(info, stuff) {
  if(!info.edits || !info.edits.length) { alert('Popups: something fishy happened. Please try again.'); return; }
  var friendlyName=stuff.page.split('_').join(' ');
  if(!info.myLastEdit) {
    alert(tprintf('Couldn\'t find an edit by %s\nin the last %s edits to\n%s',
		  [info.userName, getValueOf('popupHistoryLimit'), friendlyName]));
    return;
  }
  if(info.myLastEdit.index==0) {
    alert(tprintf(&quot;%s seems to be the last editor to the page %s&quot;, [info.userName, friendlyName]));
    return;
  }
  var newUrl=pg.wiki.titlebase + stuff.page + '&amp;diff=cur&amp;oldid='+ info.myLastEdit.oldid;
  displayUrl(newUrl, stuff.newWin);
}
function displayUrl(url, newWin){
  if(newWin) window.open(url);
  else document.location=url;
}


function magicHistoryLink(l) {
  // FIXME use onclick change href trick to sort this out instead of window.open

  var jsUrl='', title='';
  switch(l.id) {
  case 'lastContrib':
    jsUrl=simplePrintf('javascript:getLastContrib(\'%s\', %s)', [l.article.split(&quot;'&quot;).join(&quot;\\'&quot;), l.newWin]);
    title=popupString('lastContribHint');
    break;
  case 'sinceMe':
    jsUrl=simplePrintf('javascript:getDiffSinceMyEdit(\'%s\', %s)', [l.article.split(&quot;'&quot;).join(&quot;\\'&quot;), l.newWin]);
    title=popupString('sinceMeHint');
    break;
  }

  return generalNavLink({url: jsUrl, newWin: false, // can't have new windows with JS links, I think
			     title: title,
			     text: l.text});
}

function specialLink(l) {
  // properties: article, specialpage, text, sep
  if (typeof l.specialpage=='undefined'||!l.specialpage) return null;
  var base = pg.wiki.titlebase +  pg.ns.special+':'+l.specialpage;
  if (typeof l.sep == 'undefined' || l.sep===null) l.sep='&amp;target=';
  var article=l.article.urlString();
  var hint=popupString(l.specialpage+'Hint');
  switch (l.specialpage) {
  case 'Log': hint=(l.sep=='&amp;user=') ? popupString('userLogHint') : popupString('blockLogHint'); break;
  case 'Search':  article=l.article.toString(); break;
  }
  if (hint) hint = simplePrintf(hint, [safeDecodeURI(l.article)]);
  else hint = safeDecodeURI(l.specialpage+':'+l.article) ;

  var url = base + l.sep + article;
  return generalNavLink({url: url, title: hint, text: l.text, newWin:l.newWin});
};

function generalLink(l) {
  // l.url, l.text, l.title, l.newWin, l.className

  if (typeof l.url=='undefined') return null;

  // only quotation marks in the url can screw us up now... I think
  var url=l.url.split('&quot;').join('%22');

  var ret='&lt;a href=&quot;' + url + '&quot;';
  if (typeof l.title!='undefined' &amp;&amp; l.title) ret += ' title=&quot;' + l.title + '&quot;';
  var newWin;
  if (typeof l.newWin=='undefined' || l.newWin===null) newWin=getValueOf('popupNewWindows');
  else newWin=l.newWin;
  if (newWin) ret += ' target=&quot;_blank&quot;';
  if (typeof l.className!='undefined'&amp;&amp;l.className) ret+=' class=&quot;'+l.className+'&quot;';
  ret += '&gt;';
  if (typeof l.text==typeof '') ret+= l.text;
  ret +='&lt;/a&gt;';
  return ret;
}

function appendParamsToLink(linkstr, params) {
  var sp=linkstr.parenSplit(RegExp('(href=&quot;[^&quot;]+?)&quot;', 'i'));
  if (sp.length&lt;2) return null;
  var ret=sp.shift() + sp.shift();
  ret += '&amp;' + params + '&quot;';
  ret += sp.join('');
 return ret;
};

function changeLinkTargetLink(x) { // newTarget, text, hint, summary, clickButton, minor) {
  if (x.newTarget) {
    log ('changeLinkTargetLink: newTarget=' + x.newTarget);
  }
  // optional: oldTarget (in wikitext)
  // if x.newTarget omitted or null, remove the link

  // escape '&amp;' and other nasties
  if(x.newTarget) {
    x.newTarget=encodeURI(x.newTarget);
    log('changeLinkTargetLink: newTarget encoded to ' + x.newTarget);
  }
  //x.text=encodeURI(x.text);  // this buggers things up on zh.wikipedia.org and doesn't seem necessary
  x.clickButton=encodeURI(x.clickButton);

  // this'll break if charAt(0) is nasty
  if (typeof x.oldTarget != typeof '') x.oldTarget=safeDecodeURI(pg.current.article);
  var cA=literalizeRegex(x.oldTarget);
  var chs=cA.charAt(0).toUpperCase();
  chs='['+chs + chs.toLowerCase()+']';
  var currentArticleRegexBit=chs+cA.substring(1);
  currentArticleRegexBit=currentArticleRegexBit
    .split(RegExp('[_ ]+', 'g')).join('[_ ]+')
    .split('\\(').join('(?:%2528|\\()')
    .split('\\)').join('(?:%2529|\\))');
  currentArticleRegexBit = '\\s*(' + currentArticleRegexBit + ')\\s*';
  // e.g. Computer (archaic) -&gt; \s*([Cc]omputer[_ ](?:%2528|\()archaic(?:%2528|\)))\s*

  // autoedit=s~\[\[([Cc]ad)\]\]~[[Computer-aided%20design|$1]]~g;s~\[\[([Cc]AD)[|]~[[Computer-aided%20design|~g

  // get the page to edit from the title
  try {
    //var title=document.getElementsByTagName('h1')[0].innerHTML.replace(RegExp(' ', 'g'), '_');
    var title=document.title.split(' - ');
    title[title.length-1]='';
    title=title.join(' - ').replace(/ - $/, '');
  } catch (err) { return; }

  var lk=titledWikiLink({article: new Title(title), newWin:x.newWin,
				    action:  'edit',
				    text:    x.text,
				    title:   x.hint,
				    className: 'popup_change_title_link'
				    });
  var cmd='';
  if (x.newTarget) {
    cmd +='s~\\[\\['+currentArticleRegexBit+'\\]\\]~[['+x.newTarget+'|$1]]~g;';
    cmd +=  's~\\[\\['+currentArticleRegexBit+'[|]~[['+x.newTarget+'|~g';
  } else {
    cmd += 's~\\[\\['+currentArticleRegexBit+'\\]\\]~$1~g;';
    cmd += 's~\\[\\['+currentArticleRegexBit+'[|](.*?)\\]\\]~$2~g';
  }
  cmd += '&amp;autoclick='+x.clickButton;
  cmd += ( x.minor == null ) ? '' : '&amp;autominor='+x.minor;
  cmd += ( x.watch == null ) ? '' : '&amp;autowatch='+x.watch;
  cmd += '&amp;autosummary='+x.summary;
  return appendParamsToLink(lk, 'autoedit='+cmd);
}


function redirLink(redirMatch) {
  // NB redirMatch is in wikiText
  var ret='';

  if (getValueOf('popupAppendRedirNavLinks') &amp;&amp; getValueOf('popupNavLinks')) {
    ret += '&lt;hr&gt;';
    if (getValueOf('popupFixRedirs') &amp;&amp; typeof autoEdit != 'undefined' &amp;&amp; autoEdit) {
      log('redirLink: newTarget=' + redirMatch);
      ret += addPopupShortcut(
			      changeLinkTargetLink({newTarget: redirMatch, text: popupString('Redirects'), hint: popupString('Fix this redirect'),
						   summary: simplePrintf(getValueOf('popupFixRedirsSummary'),
							  [pg.current.article.split('_').join(' '), redirMatch ]),
						   clickButton: getValueOf('popupRedirAutoClick'), minor: true,
						   watch: getValueOf('popupWatchRedirredPages')})
			      , 'R');
      ret += popupString(' to ');
    }
    else ret += popupString('Redirects') + popupString(' to ');
    return ret;
  }

  else return '&lt;br&gt; ' + popupString('Redirects') + popupString(' to ') +
	 titledWikiLink({article: new Title().fromWikiText(redirMatch), action: 'view',  /* FIXME: newWin */
			text: safeDecodeURI(redirMatch), title: popupString('Bypass redirect')});
}

function arinLink(l) {
  if (!saneLinkCheck(l)) { return null; }
  if ( ! l.article.isIpUser() || ! pg.wiki.wikimedia) return null;

  var uN=safeDecodeURI(l.article.userName());

  return generalNavLink({url:'http://ws.arin.net/cgi-bin/whois.pl?queryinput=' + uN, newWin:l.newWin,
			    title: tprintf('Look up %s in ARIN whois database', [uN]),
			    text: l.text});
}

function toolDbName() {
  var ret=null;
  var theWiki=pg.wiki.hostname.split('.')[1];
  switch(theWiki) {
  case 'wikipedia':
    ret = pg.wiki.lang + 'wiki';
    break;
  default:
    ret = theWiki;
    break;
  }
  ret+= '_p';
  return ret;
}

function saneLinkCheck(l) {
  if (typeof l.article != typeof {} || typeof l.text != typeof '') { return false; }
  return true;
}
function kateLink(l) {
  if(!saneLinkCheck(l)) return null;
  if (! pg.wiki.wikimedia) return null;
  var uN=safeDecodeURI(l.article.userName());

  var url='http://tools.wikimedia.de/~' + getValueOf('popupEditCounterTool') + '/cgi-bin/count_edits?dbname=';
  url += toolDbName() + '&amp;user=' + uN;

  return generalNavLink({url:url, title: tprintf('katelinkHint', [uN]), newWin:l.newWin, text: l.text});
};


function contribsTreeLink(l) {
  if(!saneLinkCheck(l)) return null;
  if (! pg.wiki.wikimedia) return null;
  var uN=safeDecodeURI(l.article.userName());

  var url='http://tools.wikimedia.de/~interiot/cgi-bin/contribution_tree?dbname=';
  url += toolDbName() + '&amp;user='+ uN;

  return generalNavLink({url:url, title: tprintf('contribsTreeHint', [uN]), newWin:l.newWin, text: l.text});
}

function globalSearchLink(l) {
  if(!saneLinkCheck(l)) return null;

  var base='http://vs.aka-online.de/cgi-bin/globalwpsearch.pl?timeout=120&amp;search=';
  var article=safeDecodeURI(l.article);

  return generalNavLink({url:base + article, newWin:l.newWin,
			    title: tprintf('globalSearchHint', [article]),
			    text: l.text});
}

function googleLink(l) {
  if(!saneLinkCheck(l)) return null;

  var base='http://www.google.com/search?q=';
  var article=safeDecodeURI(l.article);

  return generalNavLink({url:base + '%22' + article + '%22', newWin:l.newWin,
			    title: tprintf('googleSearchHint', [article]),
			    text: l.text});
}

function editorListLink(l) {
  if(!saneLinkCheck(l)) return null;
  var article= safeDecodeURI(l.article.articleFromTalkPage() || l.article);
  var base='http://tools.wikimedia.de/~tim/counter/?page=';
  return generalNavLink({url:base+article, title: tprintf('editorListHint', [article]), newWin:l.newWin, text: l.text});
}

function generalNavLink(l) {
  l.className = (l.className==null) ? 'popupNavLink' : l.className;
  return generalLink(l);
}

//////////////////////////////////////////////////
// magic history links
//

window.getHistoryInfo=function(wikipage, whatNext) {
  getHistory(wikipage, whatNext ? function(d){whatNext(processHistory(d));} : processHistory);
}
window.getHistory=function(wikipage, onComplete) {
  var url = pg.wiki.titlebase + removeAnchor(wikipage) + '&amp;action=history' + '&amp;limit=' + getValueOf('popupHistoryLimit');
  return startDownload(url, pg.idNumber+'history', onComplete);
}
window.processHistory=function(download) {
  // screen scrape alert
  var histInfo={};

  var d=download.data;
  // pg.misc.data=d; // for debugging

  var edits=[];
  var split=d.split('&lt;li&gt;');

  for (var i=0; i&lt;split.length; ++i) {
    var match=RegExp('^[(].*?type=&quot;radio&quot; value=&quot;([0-9]*)&quot;.*?class=\'history-user\'&gt;&lt;a href=&quot;(/wiki/User:|/w/index.php[?]title=(Special:Contributions&amp;amp;target=|User:))([^&amp;&quot;]*)').exec(split[i]);
    if (match) {
      edits.push({ oldid: match[1], editor: match[4] });
    }
  }
  histInfo.edits=edits;

  var userName=getValueOf('popupUserName') || Cookie.read('enwikiUserName').split('+').join('_');
  histInfo.userName=userName;

  for (var i=0; i&lt;edits.length; ++i) {
    if (typeof histInfo.myLastEdit == 'undefined' &amp;&amp; userName &amp;&amp; edits[i].editor==userName)
      histInfo.myLastEdit={index: i, oldid: edits[i].oldid, previd: (i==0 ? null : edits[i-1].oldid)} ;
    if (typeof histInfo.firstNewEditor == 'undefined' &amp;&amp; edits[i].editor != edits[0].editor)
      histInfo.firstNewEditor={index:i, oldid:edits[i].oldid, previd: (i==0 ? null : edits[i-1].oldid)};
  }
  //pg.misc.historyInfo=histInfo;
  return histInfo;
}

// ENDFILE: links.js
// STARTFILE: options.js
//////////////////////////////////////////////////
// options

// check for cookies and existing value, else use default
function defaultize(x) {
  var val=null;
  if (x!='popupCookies') {
    defaultize('popupCookies');
    if (pg.option.popupCookies &amp;&amp; (val=Cookie.read(x))) {
      pg.option[x]=val;
      return;
    }
  }
  if (pg.option[x]===null) {
    if (typeof window[x] != 'undefined' ) pg.option[x]=window[x];
    else pg.option[x]=pg.optionDefault[x];
  }
};

function newOption(x, def) {
  if (typeof pg.option[x]=='undefined') {
    pg.option[x]=null;
  }
  pg.optionDefault[x]=def;
};

function setDefault(x, def) { return newOption(x, def); }

function getValueOf(varName) {
  defaultize(varName);
  return pg.option[varName];
}

function setOptions() {
  // user-settable parameters and defaults

  // Basic options
  newOption('popupDelay',               0.5);
  newOption('simplePopups',             false);
  newOption('popupStructure',           'menus');   // see later - default for popupStructure is 'original' if simplePopups is true
  newOption('popupActionsMenu',         true);
  newOption('popupAdminLinks',          false);
  newOption('popupShortcutKeys',        false);
  newOption('popupDragging',            true);
  newOption('popupHistoricalLinks',     true);
  newOption('popupOnlyArticleLinks',    true);
  newOption('removeTitles',             true);
  newOption('popupMaxWidth',            350);
  newOption('popupInitialWidth',        false); // integer or false
  newOption('popupSimplifyMainLink',    true);
  newOption('popupAppendRedirNavLinks', true);
  newOption('popupTocLinks',            false);
  newOption('popupSubpopups',           true);

  // images
  newOption('popupImages',                 true);
  newOption('imagePopupsForImages',        true);
  newOption('popupNeverGetThumbs',         false);
  newOption('popupImagesFromThisWikiOnly', false);
  newOption('popupMinImageWidth',          50);
  newOption('popupLoadImagesSequentially', false);
  newOption('popupImagesToggleSize',       true);
  newOption('popupImageSize',              60);

  // redirs, dabs, reversion
  newOption('popupFixRedirs',             false);
  newOption('popupRedirAutoClick',        'wpDiff');
  newOption('popupFixDabs',               false);
  newOption('popupRevertSummaryPrompt',   false);
  newOption('popupRedlinkRemoval',        false);
  newOption('popupWatchDisambiggedPages', null);
  newOption('popupWatchRedirredPages',    null);

  // navlinks
  newOption('popupNavLinks',          true);
  newOption('popupNavLinkStyle',      'default');   // FIXME what's this do?
  newOption('popupNavLinkSeparator',  ' &amp;sdot; ');
  newOption('popupLastEditLink',      true);
  newOption('popupEditCounterTool',   'interiot');
  newOption('popupExtraUserMenu',     '');

  // previews etc
  newOption('popupPreviews',             true);
  newOption('popupSummaryData',          true);
  newOption('popupMaxPreviewSentences',  4);
  newOption('popupMaxPreviewCharacters', 600);
  newOption('popupLastModified',         true);
  newOption('popupPreviewKillTemplates', true);
  newOption('popupPreviewRawTemplates',  false);
  newOption('popupPreviewFirstParOnly',  true);

  // diffs
  newOption('popupPreviewDiffs',          true);
  newOption('popupDiffMaxLines',          100);
  newOption('popupDiffContextLines',      2);
  newOption('popupDiffContextCharacters', 40);
  newOption('popupDiffDates',             true);

  // edit summaries
  newOption('popupFixDabsSummary',           popupString('defaultpopupFixDabsSummary') );
  newOption('popupExtendedRevertSummary',    popupString('defaultpopupExtendedRevertSummary') );
  newOption('popupRevertSummary',            popupString('defaultpopupRevertSummary') );
  newOption('popupFixRedirsSummary',         popupString('defaultpopupFixRedirsSummary') );
  newOption('popupRedlinkSummary',           popupString('defaultpopupRedlinkSummary') );
  newOption('popupRmDabLinkSummary',         popupString('defaultpopupRmDabLinkSummary') );

  // misc
  newOption('popupLiveOptions',         false);
  newOption('popupLiveOptionsExpanded', false);
  newOption('popupCookies',             false);
  newOption('popupUnsimplifyLink',      false);
  newOption('popupHistoryLimit',        50);
  newOption('popupFilters',             [popupFilterStubDetect,     popupFilterDisambigDetect,
					 popupFilterPageSize,       popupFilterCountLinks,
					 popupFilterCountImages,    popupFilterCountCategories,
					 popupFilterLastModified]);
  newOption('extraPopupFilters',        []);
  newOption('popupOnEditSelection',     true);

  // new windows
  newOption('popupNewWindows',     false);
  newOption('popupLinksNewWindow', {'lastContrib': true, 'sinceMe': true});
}

// ENDFILE: options.js
// STARTFILE: strings.js
//////////////////////////////////////////////////
// Translatable strings
//////////////////////////////////////////////////
//
// Notes for translators
// ---------------------
//
// If there's a string that I've not included below, please drop a
// note at [[:en:User_talk:Lupin]].
//
// These strings can be changed if they're impossible to translate to
// more flexible versions.  Just ask.
//
// New translation method: copy the pg.string block below, translate
// the strings on the right and change the line
//
// pg.string = {
//
// into
//
// popupStrings = {
//
// Save this file on your wiki and load that file '''as well as'''
// popups.js or popupsdev.js from your user javascript file.

pg.string = {
  /////////////////////////////////////
  // summary data, searching etc.
  /////////////////////////////////////
  '#': '#',
  'article': 'article',
  'category': 'category',
  'categories': 'categories',
  'image': 'image',
  'images': 'images',
  'stub': 'stub',
  'Empty page': 'Empty page',
  'kB': 'kB',
  'bytes': 'bytes',
  'day': 'day',
  'days': 'days',
  'hour': 'hour',
  'hours': 'hours',
  'minute': 'minute',
  'minutes': 'minutes',
  'second': 'second',
  'seconds': 'seconds',
  'week': 'week',
  'weeks': 'weeks',
  'search': 'search',
  'SearchHint': 'Find English Wikipedia articles containing %s',
  'web': 'web',
  'global': 'global',
  'globalSearchHint': 'Search across Wikipedias in different languages for %s',
  'google': 'google',
  'googleSearchHint': 'Google for %s',
  /////////////////////////////////////
  // article-related actions and info
  // (some actions also apply to user pages)
  /////////////////////////////////////
  'actions': 'actions',         ///// view articles and view talk
  'space': 'space',
  'spacebar': 'space',
  'view article': 'view article',
  'viewHint': 'Go to %s',
  'talk': 'talk',
  'talk page': 'talk page',
  'this&amp;nbsp;revision': 'this&amp;nbsp;revision',
  'revision %s of %s': 'revision %s of %s',
  'Revision %s of %s': 'Revision %s of %s',
  'Toggle image size': 'Toggle image size',
  'del': 'del',                 ///// delete, protect, move
  'delete': 'delete',
  'deleteHint': 'Delete %s',
  'undeleteShort': 'un',
  'UndeleteHint': 'Show the deletion history for %s',
  'protect': 'protect',
  'protectHint': 'Restrict editing rights to %s',
  'unprotectShort': 'un',
  'unprotectHint': 'Allow %s to be edited by anyone again',
  'move': 'move',
  'move page': 'move page',
  'MovepageHint': 'Change the title of %s',
  'edit': 'edit',               ///// edit articles and talk
  'edit article': 'edit article',
  'editHint': 'Change the content of %s',
  'edit talk': 'edit talk',
  'new': 'new',
  'new topic': 'new topic',
  'newSectionHint': 'Start a new section on %s',
  'null edit': 'null edit',
  'nullEditHint': 'Submit an edit to %s, making no changes ',
  'hist': 'hist',               ///// history, diffs, editors, related
  'history': 'history',
  'History': 'History', // what appears in the titles of history pages
  'historyHint': 'List the changes made to %s',
  'last': 'last',
  'lastEdit': 'lastEdit',
  'show last edit': 'most recent edit',
  'Show the last edit': 'Show the effects of the most recent change',
  'lastContrib': 'lastContrib',
  'last set of edits': 'latest edits',
  'lastContribHint': 'Show the net effect of changes made by the last editor',
  'cur': 'cur',
  'diffCur': 'diffCur',
  'Show changes since revision %s': 'Show changes since revision %s',
  'Diff truncated for performance reasons': 'Diff truncated for performance reasons',
  'old': 'old',
  'oldEdit': 'oldEdit',
  'Show the edit made to get revision': 'Show the edit made to get revision',
  'sinceMe': 'sinceMe',
  'changes since mine': 'diff my edit',
  'sinceMeHint': 'Show changes since my last edit',
  'Couldn\'t find an edit by %s\nin the last %s edits to\n%s': 'Couldn\'t find an edit by %s\nin the last %s edits to\n%s',
  'eds': 'eds',
  'editors': 'editors',
  'editorListHint': 'List the users who have edited %s',
  'related': 'related',
  'relatedChanges': 'relatedChanges',
  'related changes': 'related changes',
  'RecentchangeslinkedHint': 'Show changes in articles related to %s',
  'editOld': 'editOld',          ///// edit old version, or revert
  'rv': 'rv',
  'revert': 'revert',
  'revertHint': 'Revert to %s',
  'defaultpopupRedlinkSummary': 'Removing link to empty page [[%s]] using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'defaultpopupFixDabsSummary': 'Disambiguate [[%s]] to [[%s]] using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'defaultpopupFixRedirsSummary': 'Redirect bypass from [[%s]] to [[%s]] using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'defaultpopupExtendedRevertSummary': 'Revert to revision dated %s by %s, oldid %s using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'defaultpopupRevertSummary': 'Revert to revision %s using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'defaultpopupRmDabLinkSummary': 'Remove link to dab page [[%s]] using [[:en:Wikipedia:Tools/Navigation_popups|popups]]',
  'Redirects': 'Redirects', // as in Redirects to ...
  ' to ': ' to ',           // as in Redirects to ...
  'Bypass redirect': 'Bypass redirect',
  'Fix this redirect': 'Fix this redirect',
  'disambig': 'disambig',          ///// add or remove dab etc.
  'disambigHint': 'Disambiguate this link to [[%s]]',
  'Click to disambiguate this link to:': 'Click to disambiguate this link to:',
  'remove this link': 'remove this link',
  'remove all links to this page from this article': 'remove all links to this page from this article',
  'remove all links to this disambig page from this article': 'remove all links to this disambig page from this article',
  'mainlink': 'mainlink',          ///// links, watch, unwatch
  'wikiLinks': 'wikiLinks',
  'links here': 'links here',
  'whatLinksHere': 'whatLinksHere',
  'what links here': 'what links here',
  'WhatlinkshereHint': 'List the pages that are hyperlinked to %s',
  'unwatchShort': 'un',
  'watchThingy': 'watch',  // called watchThingy because {}.watch is a function
  'watchHint': 'Add %s to my watchlist',
  'unwatchHint': 'Remove %s from my watchlist',
  /////////////////////////////////////
  // user-related actions and info
  /////////////////////////////////////
  'user': 'user',               ///// user page, talk, email, space
  'user page': 'user page',
  'user talk': 'user talk',
  'edit user talk': 'edit user talk',
  'leave comment': 'leave comment',
  'email': 'email',
  'email user': 'email user',
  'EmailuserHint': 'Send an email to %s',
  'space': 'userspace',
  'PrefixindexHint': 'Show pages in the userspace of %s',
  'count': 'count',             ///// contributions, tree, log
  'edit counter': 'edit counter',
  'katelinkHint': 'Count the countributions made by %s',
  'contribs': 'contribs',
  'contributions': 'contributions',
  'ContributionsHint': 'List the contributions made by %s',
  'tree': 'tree',
  'contribsTree': 'contribsTree',
  'contribsTreeHint': 'Explore %s\'s contributions by namespace and by article',
  'log': 'log',
  'user log': 'user log',
  'userLogHint': 'Show %s\'s user log',
  'arin': 'ARIN lookup',             ///// ARIN lookup, block user or IP
  'Look up %s in ARIN whois database': 'Look up %s in the ARIN whois database',
  'unblockShort': 'un',
  'block': 'block',
  'block user': 'block user',
  'IpblocklistHint': 'Unblock %s',
  'BlockipHint': 'Prevent %s from editing',
  'block log': 'block log',
  'blockLogHint': 'Show the block log for %s',
  /////////////////////////////////////
  // Popups setup
  /////////////////////////////////////
  'Display navigation links at the top of the popup': 'Display navigation links at the top of the popup',
  'Download preview data': 'Download preview data from the Wikipedia servers',
  'Load images': 'Load images',
  'Never download extra stuff for images/previews': 'Never download extra stuff for images/previews',
  'Only start downloading when told to do so': 'Only start downloading when told to do so',
  'Open full-size image': 'Open full-size image',
  'Preview only on click': 'Preview only on click',
  'Show/hide options': 'Show/hide options',
  'Show image previews': 'Show image previews',
  'Show navigation links': 'Show navigation links',
  'Show page summary data': 'Show page summary data',
  'Show previews': 'Show previews',
  'Show summary data': 'Show summary data',
  'Show text previews': 'Show text previews',
  'Simple popups': 'Simple popups',
  'Toggle this option': 'Toggle this option',
  'cookies': 'cookies',
  'Use cookies to store popups options': 'Use cookies to store popups options',
  'zxy': 'zxy'
};

function popupString(str) {
  if (typeof popupStrings != 'undefined' &amp;&amp; popupStrings &amp;&amp; popupStrings[str]) return popupStrings[str];
  if (pg.string[str]) return pg.string[str];
  return str;
}

function simplePrintf(str, subs) {
  if (!subs) return str;
  var ret=[];
  var s=str.split('%s');
  var i=0;
  do {
    if (i &gt;= subs.length) { ret.push(s.join('%s')); break; }
    ret.push(s.shift());
    if (s.length == 0) break;
    ret.push(subs[i]);
    ++i;
  } while (s.length &gt; 0);
  return ret.join('');
}
function tprintf(str,subs) {
  if (typeof subs != typeof []) { subs = [subs]; }
  return simplePrintf(popupString(str), subs);
}

// ENDFILE: strings.js&lt;/pre&gt;
</pre><div class="printfooter">
Retrieved from "<a href="http://simple.wikipedia.org../../../k/e/i/User%7EKeitei_monobook.js_cf97.html">http://simple.wikipedia.org../../../k/e/i/User%7EKeitei_monobook.js_cf97.html</a>"</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-user"
	       class="selected"	       ><a href="../../../k/e/i/User%7EKeitei_monobook.js_cf97.html">User page</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../k/e/i/User_talk%7EKeitei_monobook.js_69bd.html">Talk</a></li><li id="ca-current"
	       	       ><a href="http://simple.wikipedia.org/wiki/User:Keitei/monobook.js">Newest version</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../upload/b/bc/Wiki.png);"
	    href="../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Getting around</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-mainpage"><a href="../../../index.html">Main Page</a></li>
	     	      <li id="n-portal"><a href="../../../c/o/m/Wikipedia%7ECommunity_Portal_6a3c.html">Community portal</a></li>
	     	      <li id="n-Simple-talk"><a href="../../../s/i/m/Wikipedia%7ESimple_talk_51fd.html">Simple talk</a></li>
	     	      <li id="n-help"><a href="../../../c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	      <li id="n-sitesupport"><a href="http://wikimediafoundation.org/wiki/Fundraising">Support Wikipedia</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="http://wikimediafoundation.org/"><img src="../../../images/wikimedia-button.png" border="0" alt="Wikimedia Foundation"/></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 17:52, 13 April 2006 by Wikipedia user <a href="../../../k/e/i/User%7EKeitei_af28.html" title="User:Keitei">Keitei</a>. </li>	  <li id="f-copyright">This text is available under the terms of the <a class='internal' href="../../../t/e/x/Wikipedia%7EText_of_the_GNU_Free_Documentation_License_702a.html" title="Wikipedia:Text of the GNU Free Documentation License">GNU Free Documentation License</a>. (See <b><a class='internal' href="../../../c/o/p/Wikipedia%7ECopyrights_92c4.html" title="Wikipedia:Copyrights">Copyrights</a></b> for details.) <br /> Wikipedia&reg; is a registered trademark of the <a href="http://www.wikimediafoundation.org">Wikimedia Foundation, Inc</a>., a US-registered <a class='internal' href="http://en.wikipedia.org/wiki/501%28c%29" title="501(c)(3)">501(c)(3)</a> <a href="http://wikimediafoundation.org/wiki/Deductibility_of_donations">tax-deductible</a> <a class='internal' href="http://en.wikipedia.org/wiki/Non-profit_organization" title="Non-profit organization">nonprofit</a> <a href="http://en.wikipedia.org/wiki/Charitable_organization" title="Charitable organization">charity</a>.<br /></li>	  <li id="f-about"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html" title="Wikipedia:About">About Wikipedia</a></li>	  <li id="f-disclaimer"><a href="../../../g/e/n/Wikipedia%7EGeneral_disclaimer_3e44.html" title="Wikipedia:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
